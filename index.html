<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>æ›¼è°· 6 å¤© 5 å¤œè¦ªå­å°Šäº«ä¹‹æ—… (Fixed Layout v2)</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #F3F4F6; -webkit-tap-highlight-color: transparent; overscroll-behavior-y: none; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
        .pt-safe { padding-top: env(safe-area-inset-top); }
        [v-cloak] { display: none !important; }
        
        /* Animations */
        .fade-enter-active, .fade-leave-active { transition: opacity 0.3s ease; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }
        .slide-up-enter-active, .slide-up-leave-active { transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
        .slide-up-enter-from, .slide-up-leave-to { transform: translateY(100%); }
        
        /* Form Inputs */
        input[type="time"] { -webkit-appearance: none; appearance: none; }
        .loader { border: 2px solid #f3f3f3; border-top: 2px solid #FF8C00; border-radius: 50%; width: 16px; height: 16px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
    
    <script>
        tailwind.config = {
            theme: {
                extend: { colors: { primary: '#FF8C00', secondary: '#4B0082', michelin: '#BD2333' } }
            }
        }
    </script>
</head>
<body class="overflow-hidden text-gray-800 h-[100dvh]">

    <div id="app" v-cloak class="flex flex-col h-full max-w-md mx-auto bg-white shadow-2xl relative">
        
        <transition name="fade">
            <div v-if="statusMsg && statusMsg !== 'å°±ç·’'" class="absolute top-0 left-0 right-0 z-[60] bg-black/70 text-white text-[10px] py-1 text-center backdrop-blur-sm pt-safe">
                <span v-if="statusMsg.includes('ä¸­')"><i class="fa-solid fa-rotate fa-spin mr-1"></i></span>
                <span v-else><i class="fa-solid fa-check mr-1 text-green-400"></i></span>
                {{ statusMsg }}
            </div>
        </transition>

        <header class="bg-white px-5 pt-12 pb-4 shadow-sm z-10 flex justify-between items-center shrink-0">
            <div>
                <h1 class="text-2xl font-bold text-gray-900 tracking-tight flex items-center gap-2">
                    <span class="text-primary">Sawadee</span> Bangkok
                </h1>
                <div class="flex items-center gap-2 mt-1">
                    <span v-if="tripId" class="bg-gray-100 px-2 py-0.5 rounded text-[10px] text-gray-500 font-mono select-all">{{ tripId }}</span>
                    <span v-if="isCloudMode" class="text-[10px] text-green-600 bg-green-50 px-1.5 py-0.5 rounded-full flex items-center"><span class="w-1.5 h-1.5 bg-green-500 rounded-full mr-1"></span> ç·šä¸Š</span>
                    <span v-else class="text-[10px] text-gray-400 bg-gray-100 px-1.5 py-0.5 rounded-full">å–®æ©Ÿ</span>
                </div>
            </div>
            <div class="flex gap-3">
                <button @click="openAI" class="w-9 h-9 rounded-full bg-gradient-to-tr from-blue-500 to-purple-600 text-white shadow-md flex items-center justify-center active:scale-95 transition">
                    <i class="fa-solid fa-wand-magic-sparkles"></i>
                </button>
                <button @click="showSettings = true" class="text-gray-400 hover:text-primary transition px-1">
                    <i class="fa-solid fa-gear text-xl"></i>
                </button>
            </div>
        </header>

        <main class="flex-1 overflow-y-auto no-scrollbar scrolling-touch bg-gray-50 p-4 pb-28 relative w-full">
            
            <div v-if="!hasInitialized" class="flex flex-col items-center justify-center h-full space-y-6">
                <div class="w-20 h-20 bg-orange-100 rounded-full flex items-center justify-center text-primary text-3xl animate-bounce">
                    <i class="fa-solid fa-plane-departure"></i>
                </div>
                <h2 class="text-xl font-bold">æ­¡è¿ä½¿ç”¨æ›¼è°·æ—…éŠåŠ©æ‰‹</h2>
                <div class="w-full bg-white p-6 rounded-2xl shadow-sm space-y-4 max-w-xs">
                    <input v-model="inputTripId" type="text" placeholder="è¼¸å…¥æ—…ç¨‹ä»£ç¢¼ (ä¾‹å¦‚ FAMILY)" class="w-full bg-gray-100 px-4 py-3 rounded-xl text-center font-bold uppercase outline-none focus:ring-2 focus:ring-primary">
                    <button @click="joinCloudTrip()" class="w-full py-3 bg-primary text-white rounded-xl font-bold shadow-lg active:scale-95 transition flex justify-center gap-2">
                        <span v-if="isLoading" class="loader"></span>
                        <span v-else>åŠ å…¥ / å»ºç«‹æ—…ç¨‹</span>
                    </button>
                    <div class="text-center border-t pt-3 mt-2">
                        <button @click="startApp" class="text-xs text-gray-400 underline">ä½¿ç”¨å–®æ©Ÿç‰ˆ (ä¸é€£ç·š)</button>
                    </div>
                </div>
            </div>

            <div v-else>
                <div v-if="currentTab === 'itinerary'" class="space-y-4">
                    <div class="flex space-x-2 overflow-x-auto no-scrollbar pb-1">
                        <button v-for="(day, index) in tripDays" :key="index" @click="activeDayIndex = index" class="flex-shrink-0 px-4 py-2 rounded-full text-sm font-bold transition-all border min-w-[70px] flex flex-col items-center" :class="activeDayIndex === index ? 'bg-primary text-white border-primary shadow-md' : 'bg-white text-gray-500 border-gray-200'">
                            <span>D{{ index + 1 }}</span>
                            <span class="text-[10px] opacity-80 font-normal">{{ day.date.split(' ')[0] }}</span>
                        </button>
                        <button @click="addDay" class="flex-shrink-0 px-3 py-2 rounded-full bg-gray-200 text-gray-600"><i class="fa-solid fa-plus"></i></button>
                    </div>

                    <div class="bg-orange-50 p-4 rounded-xl border border-orange-100">
                        <input v-model="tripDays[activeDayIndex].title" class="bg-transparent font-bold text-lg text-gray-800 w-full outline-none placeholder-gray-400" placeholder="è¼¸å…¥ç•¶æ—¥ä¸»é¡Œ...">
                        <input v-model="tripDays[activeDayIndex].date" class="bg-transparent text-xs text-gray-500 mt-1 w-full outline-none" placeholder="æ—¥æœŸ (ä¾‹å¦‚ 12/26)">
                    </div>

                    <div class="relative pl-4 space-y-6 mt-2">
                        <div class="absolute left-4 top-2 bottom-2 w-0.5 bg-gray-200"></div>
                        <div v-for="item in currentDayItems" :key="item.id" class="relative pl-6 group">
                            <div class="absolute left-[11px] top-1.5 w-3 h-3 bg-white border-2 border-primary rounded-full z-10 group-hover:bg-primary transition-colors"></div>
                            <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 active:scale-[0.99] transition-transform relative overflow-hidden">
                                <div class="flex justify-between items-start mb-2">
                                    <div class="font-bold text-primary text-lg">{{ item.time }}</div>
                                    <div class="flex space-x-1">
                                        <button v-if="item.thaiAddr" @click="showThaiAddress(item)" class="w-7 h-7 rounded-full bg-purple-50 text-purple-600 flex items-center justify-center"><i class="fa-solid fa-language text-xs"></i></button>
                                        <button @click="openMap(item.location)" class="w-7 h-7 rounded-full bg-blue-50 text-blue-500 flex items-center justify-center"><i class="fa-solid fa-location-arrow text-xs"></i></button>
                                        <button @click="editItem(item)" class="w-7 h-7 rounded-full bg-gray-100 text-gray-500 flex items-center justify-center"><i class="fa-solid fa-pen text-xs"></i></button>
                                    </div>
                                </div>
                                <h3 class="font-bold text-gray-800 text-lg leading-tight mb-1">{{ item.title }}</h3>
                                <div class="flex items-center text-gray-500 text-sm mb-2"><i class="fa-solid fa-map-pin mr-1.5 text-xs text-gray-400 w-4 text-center"></i><span class="truncate">{{ item.location }}</span></div>
                                <div class="flex flex-wrap gap-2 mt-2">
                                    <span v-if="item.transport" class="inline-flex items-center px-2 py-1 rounded-md text-xs font-medium bg-gray-100 text-gray-600"><i class="fa-solid fa-van-shuttle mr-1"></i> {{ item.transport }}</span>
                                    <span v-if="item.tags" v-for="tag in item.tags" :key="tag" class="inline-flex items-center px-2 py-1 rounded-md text-xs font-medium bg-orange-50 text-orange-600">{{ tag }}</span>
                                </div>
                                <p v-if="item.desc" class="text-sm text-gray-500 mt-3 border-t pt-2 border-gray-50 leading-relaxed">{{ item.desc }}</p>
                            </div>
                        </div>
                        <div v-if="currentDayItems.length === 0" class="text-center py-10 text-gray-400">
                            <i class="fa-regular fa-calendar-plus text-3xl mb-2 opacity-50"></i>
                            <p class="text-xs">é»æ“Šå³ä¸‹è§’æŒ‰éˆ•æ–°å¢è¡Œç¨‹</p>
                        </div>
                    </div>
                </div>

                <div v-if="currentTab === 'food'" class="space-y-4">
                    <div class="flex space-x-2 overflow-x-auto no-scrollbar pb-1">
                        <button v-for="cat in foodCategories" :key="cat" @click="activeFoodCategory = cat" class="flex-shrink-0 px-4 py-2 rounded-full text-sm font-bold transition-all border whitespace-nowrap" :class="activeFoodCategory === cat ? 'bg-michelin text-white border-michelin shadow-md' : 'bg-white text-gray-500 border-gray-200'">{{ cat }}</button>
                    </div>
                    <div class="space-y-3">
                        <div v-for="spot in filteredFoodSpots" :key="spot.id || spot.name" class="bg-white rounded-xl shadow-sm border border-gray-100 p-4 relative">
                             
                             <div class="flex justify-between items-start mb-2">
                                <div class="flex-1 pr-2">
                                    <div class="flex items-center gap-2 mb-1 flex-wrap">
                                        <span v-if="spot.level === '1 Star'" class="bg-yellow-100 text-yellow-700 px-1.5 py-0.5 rounded text-[10px] font-bold">â˜… ä¸€æ˜Ÿ</span>
                                        <span v-else-if="spot.level === 'Bib'" class="bg-red-50 text-michelin px-1.5 py-0.5 rounded text-[10px] font-bold">å¿…æ¯”ç™»</span>
                                        <span v-else class="bg-blue-50 text-blue-600 px-1.5 py-0.5 rounded text-[10px] font-bold">è‡ªè¨‚</span>
                                        <span class="text-xs text-gray-400 font-bold">{{ spot.price }}</span>
                                    </div>
                                    <h3 class="font-bold text-gray-900 text-lg leading-tight break-words">{{ spot.name }}</h3>
                                    <p class="text-xs text-gray-500 mt-1">{{ spot.engName }}</p>
                                </div>
                                
                                <div class="flex items-center gap-2 shrink-0">
                                    <div v-if="spot.isCustom" class="flex bg-gray-50 rounded-lg p-1 border border-gray-100">
                                        <button @click="editFood(spot)" class="w-7 h-7 flex items-center justify-center text-blue-400 hover:text-blue-600 hover:bg-blue-50 rounded transition"><i class="fa-solid fa-pen text-[10px]"></i></button>
                                        <div class="w-px h-3 bg-gray-200 self-center mx-0.5"></div>
                                        <button @click="deleteCustomFood(spot.id)" class="w-7 h-7 flex items-center justify-center text-gray-400 hover:text-red-500 hover:bg-red-50 rounded transition"><i class="fa-solid fa-trash text-[10px]"></i></button>
                                    </div>
                                    
                                    <button @click="openMap(spot.engName || spot.name)" class="w-9 h-9 bg-blue-50 text-blue-500 rounded-full flex items-center justify-center hover:bg-blue-100 active:scale-95 transition shadow-sm"><i class="fa-solid fa-location-dot"></i></button>
                                </div>
                             </div>

                             <p class="text-sm text-gray-600 mt-2 border-t pt-2 border-gray-50 leading-relaxed" v-if="spot.mustEat"><span class="font-bold text-gray-800">å¿…é»ï¼š</span>{{ spot.mustEat }}</p>
                        </div>
                    </div>
                </div>

                <div v-if="currentTab === 'expense'" class="space-y-5">
                    <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-4">
                        <div class="flex justify-between items-center mb-3">
                            <h3 class="font-bold text-gray-800 text-sm"><i class="fa-solid fa-calculator text-green-500 mr-1"></i> åŒ¯ç‡è¨ˆç®—</h3>
                            <div class="flex items-center gap-1 text-xs bg-gray-50 px-2 py-1 rounded"><span class="text-gray-400">Rate:</span><input type="number" v-model.number="currentRate" @input="updateFromHKD" class="w-10 bg-transparent font-bold text-right outline-none" step="0.1"></div>
                        </div>
                        <div class="flex items-center gap-2">
                            <div class="flex-1 bg-gray-50 rounded-xl px-3 py-2"><label class="text-[10px] text-gray-400 block font-bold">THB</label><input type="number" v-model.number="calcTHB" @input="updateFromTHB" class="w-full bg-transparent font-bold text-lg text-center outline-none" placeholder="0"></div>
                            <i class="fa-solid fa-arrow-right-arrow-left text-gray-300 text-xs"></i>
                            <div class="flex-1 bg-gray-50 rounded-xl px-3 py-2"><label class="text-[10px] text-gray-400 block font-bold">HKD</label><input type="number" v-model.number="calcHKD" @input="updateFromHKD" class="w-full bg-transparent font-bold text-lg text-center outline-none" placeholder="0"></div>
                        </div>
                    </div>
                    
                    <div class="bg-gradient-to-br from-secondary to-purple-800 rounded-2xl p-5 text-white shadow-lg relative overflow-hidden">
                        <div class="relative z-10">
                            <div class="text-purple-200 text-xs font-bold uppercase mb-1">Total Expense</div>
                            <div class="text-4xl font-bold tracking-tight mb-4">à¸¿ {{ totalExpense.toLocaleString() }}</div>
                            <div class="flex gap-2 overflow-x-auto no-scrollbar">
                                <div v-for="(person, idx) in members" :key="idx" class="bg-white/10 px-2 py-1 rounded text-[10px] whitespace-nowrap border border-white/10">{{ person }}: à¸¿ {{ getPaidAmount(person).toLocaleString() }}</div>
                            </div>
                        </div>
                        <i class="fa-solid fa-coins absolute -bottom-4 -right-4 text-9xl text-white/5 rotate-12"></i>
                    </div>

                    <div class="grid grid-cols-2 gap-3">
                        <button @click="showSettlementModal = true" class="bg-white border border-purple-100 text-secondary py-3 rounded-xl font-bold shadow-sm text-sm"><i class="fa-solid fa-file-invoice-dollar mr-1"></i> çµç®—å ±è¡¨</button>
                        <button @click="openExpenseModal()" class="bg-secondary text-white py-3 rounded-xl font-bold shadow-md shadow-purple-200 text-sm"><i class="fa-solid fa-plus mr-1"></i> æ–°å¢æ¶ˆè²»</button>
                    </div>

                    <div class="space-y-2 pb-10">
                        <h3 class="font-bold text-gray-500 text-xs px-1">æœ€è¿‘è¨˜éŒ„</h3>
                        <div v-for="exp in expenses" :key="exp.id" class="bg-white p-3 rounded-xl shadow-sm flex justify-between items-center border border-gray-50">
                            <div class="flex items-center gap-3">
                                <div class="w-9 h-9 rounded-full bg-purple-50 text-secondary flex items-center justify-center font-bold text-xs shrink-0">{{ exp.payer.charAt(0) }}</div>
                                <div><div class="font-bold text-gray-800 text-sm">{{ exp.title }}</div><div class="text-[10px] text-gray-400">{{ exp.payer }} ä»˜æ¬¾</div></div>
                            </div>
                            <div class="text-right">
                                <div class="font-bold text-gray-900">à¸¿{{ exp.amount }}</div>
                                <button @click="deleteExpense(exp.id)" class="text-[10px] text-red-300 hover:text-red-500">åˆªé™¤</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <button v-if="hasInitialized && currentTab === 'itinerary'" @click="openItineraryModal()" class="fixed bottom-24 right-5 w-14 h-14 bg-primary text-white rounded-full shadow-xl shadow-orange-200 flex items-center justify-center text-2xl active:scale-90 transition z-40">
            <i class="fa-solid fa-plus"></i>
        </button>
        <button v-if="hasInitialized && currentTab === 'food'" @click="openFoodModal()" class="fixed bottom-24 right-5 w-14 h-14 bg-michelin text-white rounded-full shadow-xl shadow-red-200 flex items-center justify-center text-2xl active:scale-90 transition z-40">
            <i class="fa-solid fa-plus"></i>
        </button>

        <nav v-if="hasInitialized" class="bg-white border-t border-gray-100 flex justify-around items-center px-2 py-3 pb-safe z-50 shrink-0 sticky bottom-0 w-full">
            <button @click="currentTab = 'itinerary'" class="flex-1 flex flex-col items-center gap-1 p-1 rounded-xl transition" :class="currentTab === 'itinerary' ? 'text-primary' : 'text-gray-300'">
                <i class="fa-solid fa-map-location-dot text-xl"></i><span class="text-[10px] font-bold">è¡Œç¨‹</span>
            </button>
            <button @click="currentTab = 'food'" class="flex-1 flex flex-col items-center gap-1 p-1 rounded-xl transition" :class="currentTab === 'food' ? 'text-michelin' : 'text-gray-300'">
                <i class="fa-solid fa-utensils text-xl"></i><span class="text-[10px] font-bold">ç¾é£Ÿ</span>
            </button>
            <button @click="currentTab = 'expense'" class="flex-1 flex flex-col items-center gap-1 p-1 rounded-xl transition" :class="currentTab === 'expense' ? 'text-secondary' : 'text-gray-300'">
                <i class="fa-solid fa-coins text-xl"></i><span class="text-[10px] font-bold">åˆ†å¸³</span>
            </button>
        </nav>

        <transition name="slide-up">
        <div v-if="showItineraryModal" class="fixed inset-0 bg-black/50 z-[70] flex items-end sm:items-center justify-center backdrop-blur-sm p-4">
            <div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl overflow-y-auto max-h-[85vh]">
                <h3 class="text-lg font-bold mb-4 text-gray-800">{{ isEditing ? 'ç·¨è¼¯è¡Œç¨‹' : 'æ–°å¢è¡Œç¨‹' }}</h3>
                <div class="space-y-3">
                    <div class="flex gap-3">
                        <div class="w-1/3"><label class="text-[10px] font-bold text-gray-400 uppercase">Time</label><input type="time" v-model="formItinerary.time" class="w-full bg-gray-100 rounded-xl px-3 py-2.5 outline-none font-bold text-center"></div>
                        <div class="w-2/3"><label class="text-[10px] font-bold text-gray-400 uppercase">Title</label><input v-model="formItinerary.title" placeholder="æ¨™é¡Œ" class="w-full bg-gray-100 rounded-xl px-4 py-2.5 outline-none font-bold"></div>
                    </div>
                    <div><label class="text-[10px] font-bold text-gray-400 uppercase">Location (Eng)</label><input v-model="formItinerary.location" placeholder="Google Maps æœå°‹ç”¨" class="w-full bg-gray-100 rounded-xl px-4 py-2.5 outline-none text-sm"></div>
                    <div><label class="text-[10px] font-bold text-gray-400 uppercase">Thai Address</label><input v-model="formItinerary.thaiAddr" placeholder="çµ¦å¸æ©Ÿçœ‹çš„æ³°æ–‡" class="w-full bg-orange-50 text-orange-800 border border-orange-100 rounded-xl px-4 py-2.5 outline-none text-sm"></div>
                    
                    <div>
                        <label class="text-[10px] font-bold text-gray-400 uppercase">Transport (å¯é¸æˆ–è‡ªå¡«)</label>
                        <div class="flex flex-wrap gap-2 mb-2">
                            <button v-for="t in ['Grab/åŒ…è»Š', 'BTS/MRT', 'èˆ¹', 'æ­¥è¡Œ', 'TukTuk']" 
                                    @click="formItinerary.transport = t"
                                    class="px-2 py-1 rounded-md text-[10px] border border-gray-200 bg-gray-50 text-gray-500 hover:bg-primary hover:text-white transition-colors"
                                    :class="formItinerary.transport === t ? 'bg-primary text-white border-primary' : ''">
                                <i class="fa-solid fa-ship mr-1" v-if="t==='èˆ¹'"></i>
                                {{ t }}
                            </button>
                        </div>
                        <input v-model="formItinerary.transport" type="text" placeholder="è‡ªè¡Œè¼¸å…¥äº¤é€šæ–¹å¼..." class="w-full bg-gray-100 rounded-xl px-4 py-2.5 outline-none text-sm">
                    </div>

                    <div><label class="text-[10px] font-bold text-gray-400 uppercase">Note</label><textarea v-model="formItinerary.desc" rows="2" class="w-full bg-gray-100 rounded-xl px-4 py-2.5 outline-none text-sm resize-none"></textarea></div>
                </div>
                <div class="flex gap-3 mt-6">
                    <button v-if="isEditing" @click="deleteItinerary" class="flex-1 py-3 rounded-xl border border-red-100 text-red-500 font-bold text-sm">åˆªé™¤</button>
                    <button @click="showItineraryModal = false" class="flex-1 py-3 rounded-xl bg-gray-100 text-gray-500 font-bold text-sm">å–æ¶ˆ</button>
                    <button @click="saveItinerary" class="flex-[2] py-3 rounded-xl bg-primary text-white font-bold text-sm shadow-lg shadow-orange-200">å„²å­˜</button>
                </div>
            </div>
        </div>
        </transition>

        <transition name="slide-up">
        <div v-if="showFoodModal" class="fixed inset-0 bg-black/50 z-[70] flex items-end sm:items-center justify-center backdrop-blur-sm p-4">
            <div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl">
                <h3 class="text-lg font-bold mb-4 text-gray-800">{{ isEditing ? 'ç·¨è¼¯ç¾é£Ÿ' : 'æ–°å¢ç¾é£Ÿ' }}</h3>
                <div class="space-y-3">
                    <div><label class="text-[10px] font-bold text-gray-400 uppercase">Name</label><input v-model="formFood.name" class="w-full bg-gray-100 rounded-xl px-4 py-2.5 outline-none font-bold"></div>
                    <div><label class="text-[10px] font-bold text-gray-400 uppercase">Eng/Thai Name</label><input v-model="formFood.engName" placeholder="åœ°åœ–æœå°‹ç”¨" class="w-full bg-gray-100 rounded-xl px-4 py-2.5 outline-none text-sm"></div>
                    <div class="flex gap-3">
                        <div class="flex-1"><label class="text-[10px] font-bold text-gray-400 uppercase">Area</label><select v-model="formFood.category" class="w-full bg-gray-100 rounded-xl px-3 py-2.5 outline-none text-sm"><option v-for="c in foodCategories" :key="c" :value="c">{{c}}</option></select></div>
                        <div class="w-24"><label class="text-[10px] font-bold text-gray-400 uppercase">Price</label><select v-model="formFood.price" class="w-full bg-gray-100 rounded-xl px-3 py-2.5 outline-none text-sm"><option value="à¸¿">à¸¿</option><option value="à¸¿à¸¿">à¸¿à¸¿</option><option value="à¸¿à¸¿à¸¿">à¸¿à¸¿à¸¿</option></select></div>
                    </div>
                    <div><label class="text-[10px] font-bold text-gray-400 uppercase">Must Eat</label><input v-model="formFood.mustEat" placeholder="å¿…é»èœè‰²" class="w-full bg-gray-100 rounded-xl px-4 py-2.5 outline-none text-sm"></div>
                </div>
                <div class="flex gap-3 mt-6">
                    <button @click="showFoodModal = false" class="flex-1 py-3 rounded-xl bg-gray-100 text-gray-500 font-bold text-sm">å–æ¶ˆ</button>
                    <button @click="saveFood" class="flex-[2] py-3 rounded-xl bg-michelin text-white font-bold text-sm shadow-lg shadow-red-200">å„²å­˜</button>
                </div>
            </div>
        </div>
        </transition>

        <transition name="slide-up">
        <div v-if="showExpenseModal" class="fixed inset-0 bg-black/50 z-[70] flex items-end sm:items-center justify-center backdrop-blur-sm p-4">
            <div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl">
                <h3 class="text-lg font-bold mb-4 text-gray-800">æ–°å¢æ¶ˆè²»</h3>
                <div class="space-y-4">
                    <div><label class="text-[10px] font-bold text-gray-400 uppercase">Item</label><input v-model="formExpense.title" placeholder="é …ç›®" class="w-full bg-gray-100 rounded-xl px-4 py-3 outline-none font-bold"></div>
                    <div><label class="text-[10px] font-bold text-gray-400 uppercase">Amount (THB)</label><input type="number" v-model="formExpense.amount" placeholder="0" class="w-full bg-gray-100 rounded-xl px-4 py-3 outline-none font-bold text-2xl text-secondary"></div>
                    <div>
                        <label class="text-[10px] font-bold text-gray-400 uppercase mb-2 block">Payer</label>
                        <div class="flex flex-wrap gap-2">
                            <button v-for="m in members" :key="m" @click="formExpense.payer = m" class="px-4 py-2 rounded-lg text-sm font-bold border transition-colors" :class="formExpense.payer === m ? 'bg-secondary text-white border-secondary' : 'bg-white text-gray-500 border-gray-200'">{{ m }}</button>
                        </div>
                    </div>
                </div>
                <div class="flex gap-3 mt-6">
                    <button @click="showExpenseModal = false" class="flex-1 py-3 rounded-xl bg-gray-100 text-gray-500 font-bold text-sm">å–æ¶ˆ</button>
                    <button @click="saveExpense" class="flex-[2] py-3 rounded-xl bg-secondary text-white font-bold text-sm shadow-lg shadow-purple-200">å„²å­˜</button>
                </div>
            </div>
        </div>
        </transition>

        <transition name="slide-up">
        <div v-if="showAIModal" class="fixed inset-0 bg-black/60 z-[80] flex items-end sm:items-center justify-center backdrop-blur-sm p-0 sm:p-4">
            <div class="bg-white w-full h-[90vh] sm:h-[80vh] sm:max-w-md rounded-t-3xl sm:rounded-3xl shadow-2xl flex flex-col overflow-hidden">
                <div class="bg-gradient-to-r from-blue-600 to-purple-600 p-4 flex justify-between items-center shrink-0">
                    <h3 class="text-white font-bold flex items-center gap-2"><i class="fa-solid fa-robot"></i> AI éš¨èº«å°éŠ</h3>
                    <button @click="showAIModal = false" class="text-white/80 hover:text-white w-8 h-8 rounded-full bg-white/20 flex items-center justify-center"><i class="fa-solid fa-xmark"></i></button>
                </div>
                <div class="flex-1 overflow-y-auto p-4 space-y-4 bg-gray-50" id="ai-chat-box">
                    <div v-if="!hasGeminiKey" class="text-center py-10 px-4">
                        <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4 text-3xl">ğŸ”‘</div>
                        <h3 class="font-bold text-gray-800 mb-2">å•Ÿç”¨ AI åŠ©æ‰‹</h3>
                        <p class="text-sm text-gray-500 mb-4">è«‹è¼¸å…¥ Google Gemini API Key</p>
                        <input v-model="tempApiKey" type="password" placeholder="API Key" class="w-full bg-white border border-gray-200 rounded-xl px-4 py-3 mb-3 text-sm outline-none">
                        <button @click="saveGeminiKey" class="w-full py-3 bg-blue-600 text-white rounded-xl font-bold">å•Ÿç”¨</button>
                        <a href="https://aistudio.google.com/app/apikey" target="_blank" class="block mt-4 text-xs text-blue-500 underline">å…è²»ç”³è«‹ Key</a>
                    </div>
                    <div v-else>
                         <div v-if="aiMessages.length === 0" class="text-center py-8 text-gray-400">
                            <p class="text-sm mb-4">æ‚¨å¯ä»¥å•æˆ‘è¡Œç¨‹å»ºè­°ã€æ³°æ–‡ç¿»è­¯æˆ–ç¾é£Ÿæ¨è–¦ã€‚</p>
                            <div class="grid grid-cols-2 gap-2">
                                <button @click="triggerAIAction('translate')" class="p-2 bg-white border border-blue-100 rounded-lg text-xs text-blue-600 font-bold">ğŸ‡¹ğŸ‡­ ç¿»è­¯æ³°æ–‡</button>
                                <button @click="triggerAIAction('food')" class="p-2 bg-white border border-red-100 rounded-lg text-xs text-red-600 font-bold">ğŸ½ï¸ æ¨è–¦ç¾é£Ÿ</button>
                            </div>
                        </div>
                        <div v-for="(msg, idx) in aiMessages" :key="idx" class="flex flex-col mb-3" :class="msg.role === 'user' ? 'items-end' : 'items-start'">
                             <div class="max-w-[85%] p-3 rounded-2xl text-sm shadow-sm prose prose-sm" :class="msg.role === 'user' ? 'bg-blue-600 text-white rounded-tr-none' : 'bg-white text-gray-800 rounded-tl-none border border-gray-100'" v-html="renderMarkdown(msg.text)"></div>
                        </div>
                        <div v-if="isAILoading" class="flex justify-start"><div class="bg-white p-3 rounded-2xl rounded-tl-none border border-gray-100"><div class="flex gap-1"><div class="w-1.5 h-1.5 bg-gray-400 rounded-full animate-bounce"></div><div class="w-1.5 h-1.5 bg-gray-400 rounded-full animate-bounce delay-75"></div><div class="w-1.5 h-1.5 bg-gray-400 rounded-full animate-bounce delay-150"></div></div></div></div>
                    </div>
                </div>
                <div class="p-3 bg-white border-t border-gray-100 shrink-0" v-if="hasGeminiKey">
                    <div class="flex gap-2">
                        <input v-model="aiInput" @keyup.enter="sendMessage" type="text" placeholder="å•å• AI..." class="flex-1 bg-gray-100 rounded-xl px-4 py-3 text-sm outline-none">
                        <button @click="sendMessage" :disabled="isAILoading || !aiInput.trim()" class="w-12 bg-blue-600 text-white rounded-xl flex items-center justify-center disabled:opacity-50"><i class="fa-solid fa-paper-plane"></i></button>
                    </div>
                </div>
            </div>
        </div>
        </transition>

        <div v-if="showSettings" class="fixed inset-0 bg-black/50 z-[90] flex items-end sm:items-center justify-center backdrop-blur-sm p-4">
            <div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl">
                <h3 class="text-lg font-bold mb-4">è¨­å®š</h3>
                <div class="mb-4 bg-gray-50 p-3 rounded-xl border border-gray-200">
                    <p class="text-[10px] text-gray-400 uppercase font-bold mb-1">Trip ID</p>
                    <div class="flex justify-between items-center">
                        <span class="font-mono font-bold select-all">{{ tripId || 'Offline' }}</span>
                        <button @click="shareTrip" class="text-blue-500 text-xs font-bold"><i class="fa-solid fa-share-nodes"></i> åˆ†äº«</button>
                    </div>
                </div>
                <div class="mb-4">
                    <label class="block text-[10px] font-bold text-gray-400 uppercase mb-2">Members</label>
                    <div class="flex gap-2 mb-2"><input v-model="newMemberName" placeholder="å" class="flex-1 bg-gray-100 rounded-lg px-3 py-2 text-sm outline-none"><button @click="addMember" class="bg-gray-800 text-white px-3 rounded-lg">+</button></div>
                    <div class="flex flex-wrap gap-2"><div v-for="(m, idx) in members" :key="idx" class="bg-gray-100 px-2 py-1 rounded text-xs flex items-center gap-1">{{ m }}<button @click="removeMember(idx)" class="text-gray-400">Ã—</button></div></div>
                </div>
                <div class="mb-4">
                     <label class="block text-[10px] font-bold text-gray-400 uppercase mb-2">API Key</label>
                     <div class="flex gap-2">
                        <input v-model="tempApiKey" type="password" class="flex-1 bg-gray-100 rounded-lg px-3 py-2 text-xs outline-none" placeholder="Gemini Key">
                        <button @click="saveGeminiKey" class="bg-blue-100 text-blue-600 px-3 rounded-lg text-xs font-bold">å„²å­˜</button>
                     </div>
                </div>
                <button @click="resetAllData" class="w-full py-3 rounded-xl border border-red-100 text-red-500 font-bold mb-2 text-sm">é‡ç½®è³‡æ–™</button>
                <button @click="showSettings = false" class="w-full py-3 rounded-xl bg-gray-900 text-white font-bold text-sm">å®Œæˆ</button>
            </div>
        </div>

        <div v-if="showThaiAddrModal" class="fixed inset-0 bg-black/80 z-[100] flex items-center justify-center p-6 backdrop-blur-sm" @click="showThaiAddrModal = false">
            <div class="bg-white w-full max-w-sm rounded-2xl p-8 text-center shadow-2xl relative" @click.stop>
                <h3 class="font-bold text-gray-400 text-xs uppercase mb-4 tracking-widest">Show to Driver</h3>
                <div class="bg-gray-50 p-6 rounded-xl border-2 border-gray-100 mb-6">
                    <p class="text-3xl font-bold text-gray-900 leading-normal">{{ thaiAddrContent }}</p>
                </div>
                <button @click="showThaiAddrModal = false" class="w-full py-3 bg-gray-900 text-white rounded-xl font-bold">é—œé–‰</button>
            </div>
        </div>

        <div v-if="showSettlementModal" class="fixed inset-0 bg-black/50 z-[90] flex items-end sm:items-center justify-center backdrop-blur-sm p-4">
             <div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl">
                 <div class="flex justify-between items-center mb-4"><h3 class="font-bold text-lg">çµç®—å»ºè­°</h3><button @click="showSettlementModal = false" class="text-gray-400"><i class="fa-solid fa-xmark"></i></button></div>
                 <div class="bg-blue-50 p-3 rounded-xl text-xs text-blue-800 mb-4 flex justify-between"><span>ç¸½é¡: à¸¿{{ totalExpense }}</span><span>æ¯äºº: à¸¿{{ Math.round(totalExpense / (members.length || 1)) }}</span></div>
                 <div class="space-y-2 max-h-60 overflow-y-auto">
                     <div v-for="(s, idx) in settlements" :key="idx" class="flex items-center justify-between p-3 border border-gray-100 rounded-xl">
                         <div class="text-sm font-bold flex items-center gap-2"><span class="text-red-500">{{ s.from }}</span><i class="fa-solid fa-arrow-right text-gray-300 text-xs"></i><span class="text-green-600">{{ s.to }}</span></div>
                         <span class="font-mono font-bold bg-gray-100 px-2 py-1 rounded text-xs">à¸¿{{ Math.round(s.amount) }}</span>
                     </div>
                     <div v-if="settlements.length===0" class="text-center text-gray-400 py-4 text-sm">å¸³ç›®å·²å¹³è¡¡</div>
                 </div>
             </div>
        </div>

    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
        import { getFirestore, doc, onSnapshot, setDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";
        const { createApp, ref, computed, onMounted, watch, nextTick } = Vue;

        createApp({
            setup() {
                // Config
                const firebaseConfig = {
                    apiKey: "AIzaSyDX9-UT3PvUHth46bJqOQ3F6gtE6-qW7-w",
                    authDomain: "bangkok-trip-app.firebaseapp.com",
                    projectId: "bangkok-trip-app",
                    storageBucket: "bangkok-trip-app.firebasestorage.app",
                    messagingSenderId: "888598636200",
                    appId: "1:888598636200:web:c1a4ecf3b54c119418049d"
                };

                // State
                const currentTab = ref('itinerary');
                const hasInitialized = ref(false);
                const isLoading = ref(false);
                const isCloudMode = ref(false);
                const tripId = ref('');
                const inputTripId = ref('');
                const statusMsg = ref('');
                
                // Data
                const tripDays = ref([{id:1, date:'Day 1', title:'æŠµé”', items:[]}]);
                const expenses = ref([]);
                const members = ref(['æˆ‘', 'å®¶äºº']);
                const customFoodSpots = ref([]);
                const activeDayIndex = ref(0);
                
                // UI Modals
                const showItineraryModal = ref(false);
                const showFoodModal = ref(false);
                const showExpenseModal = ref(false);
                const showSettings = ref(false);
                const showThaiAddrModal = ref(false);
                const showSettlementModal = ref(false);
                const showAIModal = ref(false);

                // Forms
                const formItinerary = ref({});
                const formFood = ref({});
                const formExpense = ref({});
                const isEditing = ref(false);
                const editingId = ref(null);
                const thaiAddrContent = ref('');
                const newMemberName = ref('');
                const activeFoodCategory = ref('å…¨å€');
                const calcTHB = ref('');
                const calcHKD = ref('');
                const currentRate = ref(4.4);

                // AI
                const aiInput = ref('');
                const aiMessages = ref([]);
                const isAILoading = ref(false);
                const hasGeminiKey = ref(false);
                const tempApiKey = ref('');

                // Firebase Refs
                let db, auth, tripDocRef, unsubscribe;

                // Constants
                const foodCategories = ['å…¨å€', 'Siam', 'Sukhumvit', 'Old Town', 'Silom'];
                const defaultMichelin = [
                    { name: "Jay Fai", engName: "Raan Jay Fai", category: "Old Town", level: "1 Star", price: "à¸¿à¸¿à¸¿", mustEat: "é»ƒé‡‘èŸ¹è‚‰è›‹æ²" },
                    { name: "Thipsamai", engName: "Thipsamai Pad Thai", category: "Old Town", level: "Bib", price: "à¸¿à¸¿", mustEat: "è›‹åŒ…æ³°å¼ç‚’æ²³" },
                    { name: "Rung Rueang", engName: "Rung Rueang Pork Noodle", category: "Sukhumvit", level: "Bib", price: "à¸¿", mustEat: "é…¸è¾£è±¬è‚‰ç±³ç²‰æ¹¯" },
                    { name: "Go-Ang", engName: "Go-Ang Kaomunkai Pratunam", category: "Siam", level: "Bib", price: "à¸¿", mustEat: "æµ·å—é›é£¯" },
                    { name: "Jeh O Chula", engName: "Jeh O Chula", category: "Siam", level: "Bib", price: "à¸¿à¸¿", mustEat: "å†¬è”­åŠŸåª½åª½éºµé‹" }
                ];

                // Computed
                const currentDayItems = computed(() => tripDays.value[activeDayIndex.value]?.items || []);
                const filteredFoodSpots = computed(() => {
                    const all = [...customFoodSpots.value, ...defaultMichelin];
                    return activeFoodCategory.value === 'å…¨å€' ? all : all.filter(s => s.category === activeFoodCategory.value);
                });
                const totalExpense = computed(() => expenses.value.reduce((sum, e) => sum + (Number(e.amount)||0), 0));
                
                const settlements = computed(() => {
                    if(!members.value.length || !expenses.value.length) return [];
                    const bal = {}; members.value.forEach(m => bal[m] = 0);
                    const perPerson = totalExpense.value / members.value.length;
                    expenses.value.forEach(e => { if(bal[e.payer]!==undefined) bal[e.payer] += Number(e.amount); });
                    let debt=[], cred=[];
                    for(const m in bal) {
                        const net = bal[m] - perPerson;
                        if(net < -1) debt.push({n:m, v:Math.abs(net)});
                        else if(net > 1) cred.push({n:m, v:net});
                    }
                    const res = [];
                    let i=0, j=0;
                    while(i<debt.length && j<cred.length) {
                        const amt = Math.min(debt[i].v, cred[j].v);
                        res.push({from:debt[i].n, to:cred[j].n, amount:amt});
                        debt[i].v -= amt; cred[j].v -= amt;
                        if(debt[i].v < 1) i++; if(cred[j].v < 1) j++;
                    }
                    return res;
                });

                // Helper Functions
                const getPaidAmount = (p) => expenses.value.filter(e => e.payer === p).reduce((s,e) => s + (Number(e.amount)||0), 0);
                const sanitize = (obj) => JSON.parse(JSON.stringify(obj, (k, v) => v === undefined ? null : v));
                const renderMarkdown = (text) => marked.parse(text || '');

                // Actions
                function addDay() { tripDays.value.push({id: Date.now(), date: 'New Day', title: '', items: []}); activeDayIndex.value = tripDays.value.length - 1; }
                
                function openItineraryModal() { isEditing.value = false; formItinerary.value = {time:'10:00', title:'', location:'', transport:'', desc:''}; showItineraryModal.value = true; }
                function editItem(item) { isEditing.value = true; editingId.value = item.id; formItinerary.value = {...item}; showItineraryModal.value = true; }
                function saveItinerary() {
                    if(!formItinerary.value.title) return;
                    const newItem = { ...formItinerary.value, id: isEditing.value ? editingId.value : Date.now() };
                    if(isEditing.value) {
                        const idx = tripDays.value[activeDayIndex.value].items.findIndex(i => i.id === editingId.value);
                        if(idx !== -1) tripDays.value[activeDayIndex.value].items[idx] = newItem;
                    } else {
                        tripDays.value[activeDayIndex.value].items.push(newItem);
                        tripDays.value[activeDayIndex.value].items.sort((a,b) => a.time.localeCompare(b.time));
                    }
                    showItineraryModal.value = false;
                }
                function deleteItinerary() {
                    tripDays.value[activeDayIndex.value].items = tripDays.value[activeDayIndex.value].items.filter(i => i.id !== editingId.value);
                    showItineraryModal.value = false;
                }

                // Food
                function openFoodModal() { 
                    isEditing.value = false; 
                    editingId.value = null;
                    formFood.value = {name:'', category:'Siam', price:'à¸¿', mustEat:'', engName: ''}; 
                    showFoodModal.value = true; 
                }
                
                function editFood(item) {
                    isEditing.value = true;
                    editingId.value = item.id;
                    formFood.value = { ...item };
                    showFoodModal.value = true;
                }

                function saveFood() {
                    if(!formFood.value.name) return;

                    if (isEditing.value && editingId.value) {
                        // ç·¨è¼¯æ¨¡å¼
                        const index = customFoodSpots.value.findIndex(f => f.id === editingId.value);
                        if (index !== -1) {
                            customFoodSpots.value[index] = { 
                                ...formFood.value, 
                                id: editingId.value, 
                                isCustom: true 
                            };
                        }
                    } else {
                        // æ–°å¢æ¨¡å¼
                        customFoodSpots.value.unshift({
                            ...formFood.value, 
                            id: Date.now(), 
                            isCustom: true
                        });
                    }
                    showFoodModal.value = false;
                }
                
                function deleteCustomFood(id) { 
                    if(confirm('ç¢ºèªåˆªé™¤?')) customFoodSpots.value = customFoodSpots.value.filter(f => f.id !== id); 
                }
                
                // Expense
                function openExpenseModal() { formExpense.value = {title:'', amount:'', payer: members.value[0]}; showExpenseModal.value = true; }
                function saveExpense() {
                    if(!formExpense.value.amount) return;
                    expenses.value.unshift({...formExpense.value, id: Date.now(), amount: Number(formExpense.value.amount)});
                    showExpenseModal.value = false;
                }
                function deleteExpense(id) { if(confirm('åˆªé™¤?')) expenses.value = expenses.value.filter(e => e.id !== id); }

                function addMember() { if(newMemberName.value && !members.value.includes(newMemberName.value)) { members.value.push(newMemberName.value); newMemberName.value=''; } }
                function removeMember(idx) { if(confirm('ç§»é™¤æ­¤äºº?')) members.value.splice(idx, 1); }
                
                function showThaiAddress(item) { thaiAddrContent.value = item.thaiAddr; showThaiAddrModal.value = true; }
                
                function openMap(loc) {
                    if (!loc) return;
                    const query = encodeURIComponent(loc + ', Bangkok');
                    const url = `https://www.google.com/maps/search/?api=1&query=${query}`;
                    window.open(url, '_blank');
                }

                function updateFromTHB() { calcHKD.value = calcTHB.value ? (calcTHB.value / currentRate.value).toFixed(2) : ''; }
                function updateFromHKD() { calcTHB.value = calcHKD.value ? (calcHKD.value * currentRate.value).toFixed(0) : ''; }

                // Persistence
                async function syncToCloud() {
                    const data = sanitize({ tripDays: tripDays.value, expenses: expenses.value, members: members.value, customFoodSpots: customFoodSpots.value });
                    localStorage.setItem('bangkok_trip_data', JSON.stringify(data));
                    
                    if (isCloudMode.value && tripDocRef) {
                        statusMsg.value = 'åŒæ­¥ä¸­...';
                        try {
                            await setDoc(tripDocRef, data, { merge: true });
                            statusMsg.value = 'åŒæ­¥å®Œæˆ';
                            setTimeout(() => statusMsg.value = '', 2000);
                        } catch (e) {
                            console.error(e);
                            statusMsg.value = 'åŒæ­¥å¤±æ•—';
                        }
                    }
                }

                function loadLocal() {
                    const local = localStorage.getItem('bangkok_trip_data');
                    if(local) {
                        const d = JSON.parse(local);
                        if(d.tripDays) tripDays.value = d.tripDays;
                        if(d.expenses) expenses.value = d.expenses;
                        if(d.members) members.value = d.members;
                        if(d.customFoodSpots) customFoodSpots.value = d.customFoodSpots;
                    }
                    hasInitialized.value = true;
                }

                async function joinCloudTrip() {
                    const id = inputTripId.value.trim().toUpperCase();
                    if(!id) return alert('è«‹è¼¸å…¥ä»£ç¢¼');
                    isLoading.value = true;
                    
                    try {
                        const app = initializeApp(firebaseConfig);
                        db = getFirestore(app);
                        auth = getAuth(app);
                        await signInAnonymously(auth);
                        
                        tripId.value = id;
                        tripDocRef = doc(db, 'trips', id);
                        
                        unsubscribe = onSnapshot(tripDocRef, (snap) => {
                            if(snap.exists()) {
                                const d = snap.data();
                                if(d.tripDays) tripDays.value = d.tripDays;
                                if(d.expenses) expenses.value = d.expenses;
                                if(d.members) members.value = d.members;
                                if(d.customFoodSpots) customFoodSpots.value = d.customFoodSpots;
                            }
                            isCloudMode.value = true;
                            hasInitialized.value = true;
                            isLoading.value = false;
                            localStorage.setItem('tripId', id);
                            statusMsg.value = 'å·²é€£ç·š';
                        });
                    } catch(e) {
                        alert('é€£ç·šå¤±æ•—: ' + e.message);
                        isLoading.value = false;
                        startApp();
                    }
                }

                function startApp() { loadLocal(); isCloudMode.value = false; }
                function resetAllData() { if(confirm('ç¢ºå®šé‡ç½®æ‰€æœ‰è³‡æ–™ï¼Ÿ')) { localStorage.clear(); location.reload(); } }
                function shareTrip() { prompt("è¤‡è£½ä»£ç¢¼åˆ†äº«:", tripId.value); }

                // AI
                function openAI() {
                    showAIModal.value = true;
                    tempApiKey.value = localStorage.getItem('gemini_key') || '';
                    hasGeminiKey.value = !!tempApiKey.value;
                }
                function saveGeminiKey() {
                    if(tempApiKey.value) {
                        localStorage.setItem('gemini_key', tempApiKey.value);
                        hasGeminiKey.value = true;
                    }
                }
                async function sendMessage() {
                    if(!aiInput.value) return;
                    const text = aiInput.value; aiInput.value = '';
                    aiMessages.value.push({role:'user', text});
                    isAILoading.value = true;
                    
                    try {
                        const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${tempApiKey.value}`;
                        const prompt = `ä½ æ˜¯ä¸€å€‹æ›¼è°·å°éŠã€‚ç”¨æˆ¶è¡Œç¨‹Context: ${JSON.stringify(tripDays.value.map(d=>d.title))}. å›ç­”: ${text}`;
                        const res = await fetch(url, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({contents:[{parts:[{text:prompt}]}]}) });
                        const data = await res.json();
                        const reply = data.candidates?.[0]?.content?.parts?.[0]?.text || 'Error';
                        aiMessages.value.push({role:'model', text: reply});
                    } catch(e) { aiMessages.value.push({role:'model', text:'API Error'}); }
                    isAILoading.value = false;
                }
                function triggerAIAction(type) {
                    if(type==='translate') aiInput.value = 'è«‹æ•™æˆ‘å¹¾å¥æ­è»Šå’Œé»é¤çš„æ³°æ–‡';
                    if(type==='food') aiInput.value = 'æ¨è–¦è¡Œç¨‹é™„è¿‘çš„å¿…åƒç¾é£Ÿ';
                    sendMessage();
                }

                onMounted(() => {
                    const savedId = localStorage.getItem('tripId');
                    if(savedId) { inputTripId.value = savedId; joinCloudTrip(); }
                });

                watch([tripDays, expenses, members, customFoodSpots], syncToCloud, { deep: true });

                return {
                    currentTab, hasInitialized, isLoading, isCloudMode, tripId, inputTripId, statusMsg,
                    tripDays, expenses, members, customFoodSpots, activeDayIndex, currentDayItems,
                    totalExpense, settlements, getPaidAmount,
                    showItineraryModal, showFoodModal, showExpenseModal, showSettings, showThaiAddrModal, showSettlementModal, showAIModal,
                    formItinerary, formFood, formExpense, isEditing, thaiAddrContent, newMemberName,
                    foodCategories, filteredFoodSpots, activeFoodCategory, calcTHB, calcHKD, currentRate,
                    aiInput, aiMessages, isAILoading, hasGeminiKey, tempApiKey,
                    
                    addDay, openItineraryModal, saveItinerary, editItem, deleteItinerary,
                    openFoodModal, saveFood, deleteCustomFood, editFood, 
                    openExpenseModal, saveExpense, deleteExpense,
                    addMember, removeMember, showThaiAddress, openMap,
                    updateFromTHB, updateFromHKD, joinCloudTrip, startApp, resetAllData, shareTrip,
                    openAI, saveGeminiKey, sendMessage, triggerAIAction, renderMarkdown
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
