<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="æ›¼è°·è¦ªå­éŠ">
    
    <title>æ›¼è°· 6 å¤© 5 å¤œè¦ªå­å°Šäº«ä¹‹æ—…</title>

    <link rel="apple-touch-icon" href="./icon.jpg">
    <link rel="icon" href="./icon.jpg">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        body, #app { height: 100vh; height: 100dvh; }
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #F3F4F6; -webkit-tap-highlight-color: transparent; overscroll-behavior-y: none; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .scrolling-touch { -webkit-overflow-scrolling: touch; }
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
        .loader { border: 3px solid #f3f3f3; border-top: 3px solid #FF8C00; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; }
        [v-cloak] { display: none !important; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: { colors: { primary: '#FF8C00', secondary: '#4B0082', bg: '#F3F4F6', michelin: '#BD2333' } }
            }
        }
    </script>
</head>
<body class="overflow-hidden text-gray-800">

    <div id="app" v-cloak class="flex flex-col relative max-w-md mx-auto bg-white shadow-2xl h-full">
        
        <!-- Header -->
        <header class="bg-white px-5 pt-10 pb-4 shadow-sm z-10 flex justify-between items-center sticky top-0 shrink-0">
            <div>
                <h1 class="text-2xl font-bold text-gray-900 tracking-tight flex items-center gap-2">
                    <span class="text-primary">Sawadee</span> Bangkok ğŸ‡¹ğŸ‡­
                    <span v-if="isCloudMode" class="text-[10px] bg-green-100 text-green-600 px-2 py-0.5 rounded-full animate-pulse flex items-center gap-1">
                        <span class="w-1.5 h-1.5 bg-green-500 rounded-full"></span> ç·šä¸Š
                    </span>
                </h1>
                <p class="text-xs text-gray-500 font-medium mt-1">
                    {{ tripId ? 'æ—…ç¨‹ä»£ç¢¼: ' + tripId : 'è¦ªå­å°Šäº«ä¹‹æ—… (12/26 - 12/31)' }}
                </p>
            </div>
            <button @click="showSettings = true" class="text-gray-400 hover:text-primary transition relative">
                <i class="fa-solid fa-gear text-lg"></i>
                <span v-if="isCloudMode" class="absolute -top-1 -right-1 w-2 h-2 bg-green-500 rounded-full"></span>
            </button>
        </header>

        <!-- Main Content Area -->
        <main class="flex-1 overflow-y-auto no-scrollbar scrolling-touch bg-gray-50 p-4 pb-24 relative w-full">
            
            <!-- Setup Screen -->
            <div v-if="!hasInitialized" class="flex flex-col items-center justify-center h-full text-center space-y-6">
                <div class="w-20 h-20 bg-orange-100 rounded-full flex items-center justify-center text-primary text-3xl mb-2">
                    <i class="fa-solid fa-plane-departure"></i>
                </div>
                <h2 class="text-xl font-bold">æ­¡è¿ä½¿ç”¨æ›¼è°·æ—…éŠåŠ©æ‰‹</h2>
                
                <div class="w-full space-y-3 px-4">
                    <div v-if="isLoading" class="flex flex-col items-center justify-center text-gray-400 py-4">
                        <div class="loader mb-3"></div>
                        <p class="text-xs">æ­£åœ¨é€£ç·šè‡³é›²ç«¯è³‡æ–™åº«...</p>
                    </div>
                    
                    <div v-else class="bg-white p-6 rounded-2xl shadow-sm border border-blue-100 space-y-4">
                        <h3 class="font-bold text-blue-600"><i class="fa-solid fa-cloud mr-1"></i> é–‹å§‹æ—…ç¨‹</h3>
                        
                        <!-- æ•¸æ“šåº«è¨­å®šæç¤º -->
                        <div v-if="!hasCustomConfig" class="bg-yellow-50 border border-yellow-200 p-3 rounded-xl text-xs text-yellow-800 mb-2">
                            <p class="font-bold"><i class="fa-solid fa-triangle-exclamation"></i> å°šæœªè¨­å®šè³‡æ–™åº«</p>
                            <p class="mt-1">è‹¥è¦åœ¨ GitHub Pages ä½¿ç”¨ï¼Œè«‹å…ˆè¨­å®šæ‚¨çš„ Firebase Configã€‚</p>
                            <button @click="showConfigModal = true" class="mt-2 w-full py-2 bg-yellow-100 hover:bg-yellow-200 rounded-lg font-bold text-yellow-900">
                                <i class="fa-solid fa-wrench"></i> è¨­å®šè³‡æ–™åº«
                            </button>
                        </div>

                        <div>
                            <label class="block text-xs text-gray-400 mb-1 text-left ml-1">æ—…ç¨‹ä»£ç¢¼ æˆ– è‡ªè¨‚åç¨±</label>
                            <div class="flex gap-2 w-full">
                                <input v-model="inputTripId" type="text" placeholder="ä¾‹å¦‚: FWD_BKK_TRIP" class="flex-1 min-w-0 bg-gray-100 px-3 py-3 rounded-xl text-base font-bold text-center uppercase tracking-wide outline-none focus:ring-2 focus:ring-blue-500">
                                <button @click="joinCloudTrip()" class="px-5 bg-blue-600 text-white rounded-xl font-bold shadow-md hover:bg-blue-700 whitespace-nowrap">åŠ å…¥</button>
                            </div>
                        </div>
                        
                        <div class="relative py-2">
                            <div class="absolute inset-0 flex items-center"><div class="w-full border-t border-gray-100"></div></div>
                            <div class="relative flex justify-center text-xs bg-white px-2 text-gray-400">æˆ–æ˜¯</div>
                        </div>

                        <button @click="createCloudTrip" class="w-full py-3 bg-orange-50 border border-orange-200 text-orange-600 rounded-xl font-bold hover:bg-orange-100">
                            å»ºç«‹ä¸€å€‹æ–°æ—…ç¨‹ (è‡ªè¨‚åç¨±)
                        </button>
                        
                        <button @click="initOffline" class="text-xs text-gray-400 underline mt-2">
                            è·³éï¼Œä½¿ç”¨å–®æ©Ÿç‰ˆ (è³‡æ–™ä¸äº’é€š)
                        </button>
                    </div>
                </div>
            </div>

            <!-- Main App Content -->
            <div v-else>
                <!-- ITINERARY TAB -->
                <div v-if="currentTab === 'itinerary'" class="space-y-4">
                    <div class="rounded-2xl overflow-hidden shadow-md mb-4 border border-gray-100 relative h-40 bg-gray-200">
                        <img src="https://images.unsplash.com/photo-1508009603885-50cf7c579365?q=80&w=1000&auto=format&fit=crop" alt="Bangkok" class="w-full h-full object-cover block">
                        <div class="absolute inset-0 bg-gradient-to-t from-black/50 to-transparent flex items-end p-4">
                            <span class="text-white font-bold text-lg">Bangkok City of Angels</span>
                        </div>
                    </div>

                    <div class="flex space-x-3 overflow-x-auto no-scrollbar pb-2">
                        <button v-for="(day, index) in tripDays" :key="index" @click="activeDayIndex = index" class="flex-shrink-0 px-4 py-2 rounded-full text-sm font-bold transition-all transform active:scale-95 shadow-sm flex flex-col items-center min-w-[80px]" :class="activeDayIndex === index ? 'bg-primary text-white shadow-md' : 'bg-white text-gray-500 border border-gray-100'"><span>Day {{ index + 1 }}</span><span class="text-[10px] font-normal opacity-80">{{ day.date }}</span></button>
                        <button @click="addDay" class="flex-shrink-0 px-3 py-2 rounded-full text-sm bg-gray-200 text-gray-600"><i class="fa-solid fa-plus"></i></button>
                    </div>

                    <div class="bg-orange-50 p-4 rounded-xl border border-orange-100 mb-2">
                        <h2 class="font-bold text-lg text-gray-800">{{ tripDays[activeDayIndex].title || 'è‡ªç”±æ´»å‹•' }}</h2>
                        <p class="text-xs text-gray-500 mt-1" v-if="tripDays[activeDayIndex].note"><i class="fa-solid fa-circle-info mr-1 text-primary"></i>{{ tripDays[activeDayIndex].note }}</p>
                    </div>

                    <div class="relative pl-4 space-y-6 mt-4">
                        <div class="absolute left-4 top-2 bottom-2 w-0.5 bg-gray-200"></div>
                        <div v-for="item in currentDayItems" :key="item.id" class="relative pl-6 group">
                            <div class="absolute left-[11px] top-1.5 w-3 h-3 bg-white border-2 border-primary rounded-full z-10 group-hover:bg-primary transition-colors"></div>
                            <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 active:scale-[0.99] transition-transform">
                                <div class="flex justify-between items-start mb-2">
                                    <div class="font-bold text-primary text-lg">{{ item.time }}</div>
                                    <div class="flex space-x-1">
                                        <button v-if="item.thaiAddr" @click="showThaiAddress(item)" class="w-8 h-8 rounded-full bg-purple-50 text-purple-600 flex items-center justify-center hover:bg-purple-100"><i class="fa-solid fa-language text-sm"></i></button>
                                        <button @click="openMap(item.location)" class="w-8 h-8 rounded-full bg-blue-50 text-blue-500 flex items-center justify-center hover:bg-blue-100"><i class="fa-solid fa-location-arrow text-sm"></i></button>
                                        <button @click="editItem(item)" class="w-8 h-8 rounded-full bg-gray-50 text-gray-400 flex items-center justify-center hover:text-gray-600"><i class="fa-solid fa-pen text-xs"></i></button>
                                    </div>
                                </div>
                                <h3 class="font-bold text-gray-800 text-lg leading-tight mb-1">{{ item.title }}</h3>
                                <div class="flex items-center text-gray-500 text-sm mb-2"><i class="fa-solid fa-map-pin mr-1.5 text-xs text-gray-400 w-4 text-center"></i><span class="truncate">{{ item.location }}</span></div>
                                <div class="flex flex-wrap gap-2 mt-2">
                                    <span v-if="item.transport" class="inline-flex items-center px-2 py-1 rounded-md text-xs font-medium bg-gray-100 text-gray-600"><i class="fa-solid fa-van-shuttle mr-1"></i> {{ item.transport }}</span>
                                    <span v-if="item.tags" v-for="tag in item.tags" :key="tag" class="inline-flex items-center px-2 py-1 rounded-md text-xs font-medium bg-orange-50 text-orange-600">{{ tag }}</span>
                                </div>
                                <p v-if="item.desc" class="text-sm text-gray-500 mt-3 border-t pt-2 border-gray-50 leading-relaxed">{{ item.desc }}</p>
                            </div>
                        </div>
                        <div v-if="currentDayItems.length === 0" class="text-center py-10 text-gray-400"><i class="fa-regular fa-calendar-xmark text-4xl mb-3 opacity-30"></i><p>é€™å¤©é‚„æ²’æœ‰è¡Œç¨‹<br>é»æ“Šä¸‹æ–¹æŒ‰éˆ•æ–°å¢</p></div>
                    </div>
                </div>

                <!-- FOOD TAB -->
                <div v-if="currentTab === 'food'" class="space-y-4">
                    <div class="flex space-x-2 overflow-x-auto no-scrollbar pb-2">
                        <button v-for="cat in foodCategories" :key="cat" @click="activeFoodCategory = cat" class="flex-shrink-0 px-4 py-2 rounded-full text-sm font-bold transition-all border whitespace-nowrap" :class="activeFoodCategory === cat ? 'bg-michelin text-white border-michelin shadow-md' : 'bg-white text-gray-500 border-gray-200'">{{ cat }}</button>
                    </div>
                    <div class="space-y-4">
                        <div v-for="spot in filteredFoodSpots" :key="spot.id || spot.name" class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden flex flex-col relative">
                            <button v-if="spot.isCustom" @click="deleteCustomFood(spot.id)" class="absolute top-2 right-2 text-gray-300 hover:text-red-500 p-2 z-10"><i class="fa-solid fa-trash text-xs"></i></button>
                            <div class="flex justify-between items-start p-4 pb-2">
                                <div class="flex flex-col pr-8">
                                    <div class="flex items-center gap-2 mb-1 flex-wrap">
                                        <span v-if="spot.level === '1 Star'" class="bg-yellow-100 text-yellow-700 px-2 py-0.5 rounded text-[10px] font-bold border border-yellow-200"><i class="fa-solid fa-star"></i> ç±³èŠè“®ä¸€æ˜Ÿ</span>
                                        <span v-else-if="spot.level === 'Bib'" class="bg-red-50 text-michelin px-2 py-0.5 rounded text-[10px] font-bold border border-red-100"><i class="fa-solid fa-face-grin-tongue"></i> å¿…æ¯”ç™»</span>
                                        <span v-else-if="spot.isCustom" class="bg-blue-50 text-blue-600 px-2 py-0.5 rounded text-[10px] font-bold border border-blue-100"><i class="fa-solid fa-user-pen"></i> è‡ªè¨‚</span>
                                        <span class="text-xs text-gray-400 font-medium">{{ spot.price }}</span>
                                    </div>
                                    <h3 class="font-bold text-gray-900 text-lg">{{ spot.name }}</h3>
                                    <p class="text-xs text-gray-500">{{ spot.engName }}</p>
                                </div>
                                <button @click="openMap(spot.engName || spot.name)" class="w-10 h-10 bg-blue-50 rounded-full flex items-center justify-center text-blue-500 hover:bg-blue-100 shadow-sm shrink-0"><i class="fa-solid fa-location-dot"></i></button>
                            </div>
                            <div class="px-4 pb-4">
                                <p class="text-sm text-gray-600 leading-relaxed border-t border-gray-50 pt-2" v-if="spot.mustEat"><span class="font-bold text-gray-800">å¿…é»ï¼š</span>{{ spot.mustEat }}</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- EXPENSE TAB -->
                <div v-if="currentTab === 'expense'" class="space-y-6">
                    <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-5">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="font-bold text-gray-800 flex items-center gap-2"><i class="fa-solid fa-money-bill-transfer text-green-500"></i> åŒ¯ç‡è¨ˆç®—</h3>
                            <div class="flex items-center gap-2 text-xs bg-gray-50 px-2 py-1 rounded-lg"><span class="text-gray-400">åŒ¯ç‡:</span><input type="number" v-model.number="currentRate" @input="updateFromHKD" class="w-12 bg-transparent font-bold text-gray-700 text-right outline-none border-b border-gray-300 focus:border-primary" step="0.01"></div>
                        </div>
                        <div class="flex items-center gap-3">
                            <div class="flex-1"><label class="block text-xs font-bold text-gray-400 mb-1">æ³°éŠ– (THB)</label><input type="number" v-model.number="calcTHB" @input="updateFromTHB" class="w-full bg-gray-50 rounded-xl px-3 py-2 text-lg font-bold text-gray-800 outline-none focus:ring-2 focus:ring-primary focus:bg-white text-center" placeholder="0"></div>
                            <div class="text-gray-300 pt-5"><i class="fa-solid fa-right-left"></i></div>
                            <div class="flex-1"><label class="block text-xs font-bold text-gray-400 mb-1">æ¸¯å¹£ (HKD)</label><input type="number" v-model.number="calcHKD" @input="updateFromHKD" class="w-full bg-gray-50 rounded-xl px-3 py-2 text-lg font-bold text-gray-800 outline-none focus:ring-2 focus:ring-primary focus:bg-white text-center" placeholder="0"></div>
                        </div>
                    </div>
                    <div class="bg-gradient-to-r from-secondary to-purple-600 rounded-2xl p-6 text-white shadow-lg relative overflow-hidden">
                        <div class="relative z-10">
                            <div class="text-purple-200 text-sm font-medium mb-1">ç¸½æ”¯å‡º (Total)</div>
                            <div class="text-4xl font-bold tracking-tight">à¸¿ {{ totalExpense.toLocaleString() }}</div>
                            <div class="mt-4 flex space-x-2 overflow-x-auto no-scrollbar">
                                <div v-for="(person, idx) in members" :key="idx" class="bg-white/20 px-3 py-1 rounded-lg text-xs backdrop-blur-sm whitespace-nowrap">{{ person }}: à¸¿ {{ getPaidAmount(person).toLocaleString() }}</div>
                            </div>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <button @click="showSettlementModal = true" class="bg-white border border-purple-100 text-secondary py-3 rounded-xl font-bold shadow-sm hover:bg-purple-50 transition flex items-center justify-center gap-2"><i class="fa-solid fa-calculator"></i> çµç®—å ±è¡¨</button>
                        <button @click="openExpenseModal()" class="bg-secondary text-white py-3 rounded-xl font-bold shadow-md shadow-purple-200 active:scale-95 transition flex items-center justify-center gap-2"><i class="fa-solid fa-plus"></i> æ–°å¢æ¶ˆè²»</button>
                    </div>
                    <div>
                        <h3 class="font-bold text-gray-700 mb-3 px-1">æœ€è¿‘æ¶ˆè²»è¨˜éŒ„</h3>
                        <div class="space-y-3">
                            <div v-for="exp in expenses" :key="exp.id" class="bg-white p-4 rounded-xl shadow-sm flex justify-between items-center border border-gray-50">
                                <div class="flex items-center gap-3"><div class="w-10 h-10 rounded-full bg-purple-50 text-secondary flex items-center justify-center font-bold text-xs">{{ exp.payer.charAt(0) }}</div><div><div class="font-bold text-gray-800">{{ exp.title }}</div><div class="text-xs text-gray-500">{{ exp.payer }} å…ˆä»˜</div></div></div>
                                <div class="text-right"><div class="font-bold text-gray-900">à¸¿{{ exp.amount }}</div><button @click="deleteExpense(exp.id)" class="text-xs text-red-300 hover:text-red-500 mt-1">åˆªé™¤</button></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- Config Modal -->
        <div v-if="showConfigModal" class="fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-6 backdrop-blur-sm">
            <div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl">
                <h3 class="text-lg font-bold text-gray-800 mb-2">è¨­å®šæ‚¨çš„è³‡æ–™åº«</h3>
                <p class="text-xs text-gray-500 mb-4">è«‹è²¼ä¸Š Firebase Console > Project Settings > General ä¸­çš„ `firebaseConfig` ç‰©ä»¶å…§å®¹ (JSONæ ¼å¼)ã€‚</p>
                <textarea v-model="configInput" rows="8" class="w-full bg-gray-100 rounded-xl p-3 text-xs font-mono mb-4 border border-gray-200" placeholder='{ "apiKey": "...", "authDomain": "...", ... }'></textarea>
                <div class="flex gap-2">
                    <button @click="showConfigModal = false" class="flex-1 py-3 bg-gray-100 rounded-xl font-bold text-gray-600">å–æ¶ˆ</button>
                    <button @click="saveCustomConfig" class="flex-1 py-3 bg-primary text-white rounded-xl font-bold shadow-lg">å„²å­˜ä¸¦é‡å•Ÿ</button>
                </div>
            </div>
        </div>

        <!-- Floating Action Button -->
        <button v-if="hasInitialized && currentTab === 'itinerary'" @click="openItineraryModal()" class="fixed bottom-24 right-5 w-14 h-14 bg-primary text-white rounded-full shadow-lg shadow-orange-200 flex items-center justify-center text-2xl active:scale-90 transition transform z-50"><i class="fa-solid fa-plus"></i></button>
        <button v-if="hasInitialized && currentTab === 'food'" @click="openFoodModal()" class="fixed bottom-24 right-5 w-14 h-14 bg-michelin text-white rounded-full shadow-lg shadow-red-200 flex items-center justify-center text-2xl active:scale-90 transition transform z-50"><i class="fa-solid fa-plus"></i></button>

        <!-- Bottom Navigation -->
        <nav v-if="hasInitialized" class="bg-white border-t border-gray-100 flex justify-around items-center px-2 py-3 pb-safe z-30 shrink-0 sticky bottom-0 w-full">
            <button @click="currentTab = 'itinerary'" class="flex-1 flex flex-col items-center gap-1 p-2 rounded-xl transition" :class="currentTab === 'itinerary' ? 'text-primary' : 'text-gray-400'"><i class="fa-solid fa-map-location-dot text-xl"></i><span class="text-xs font-medium">è¡Œç¨‹</span></button>
            <button @click="currentTab = 'food'" class="flex-1 flex flex-col items-center gap-1 p-2 rounded-xl transition" :class="currentTab === 'food' ? 'text-michelin' : 'text-gray-400'"><i class="fa-solid fa-utensils text-xl"></i><span class="text-xs font-medium">ç¾é£Ÿ</span></button>
            <button @click="currentTab = 'expense'" class="flex-1 flex flex-col items-center gap-1 p-2 rounded-xl transition" :class="currentTab === 'expense' ? 'text-secondary' : 'text-gray-400'"><i class="fa-solid fa-coins text-xl"></i><span class="text-xs font-medium">åˆ†å¸³</span></button>
        </nav>

        <!-- MODALS -->
        <div v-if="showItineraryModal" class="fixed inset-0 bg-black/50 z-50 flex items-end sm:items-center justify-center backdrop-blur-sm p-4"><div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl animate-slide-up"><h3 class="text-xl font-bold mb-4">{{ isEditing ? 'ç·¨è¼¯è¡Œç¨‹' : 'æ–°å¢è¡Œç¨‹' }}</h3><div class="space-y-4"><input v-model="formItinerary.time" type="time" class="w-full bg-gray-100 rounded-xl px-4 py-3"><input v-model="formItinerary.title" type="text" placeholder="æ´»å‹•åç¨±" class="w-full bg-gray-100 rounded-xl px-4 py-3"><input v-model="formItinerary.location" type="text" placeholder="åœ°é»" class="w-full bg-gray-100 rounded-xl px-4 py-3"><input v-model="formItinerary.transport" type="text" placeholder="äº¤é€š" class="w-full bg-gray-100 rounded-xl px-4 py-3"><textarea v-model="formItinerary.desc" rows="3" placeholder="å‚™è¨»/æ³°æ–‡åœ°å€" class="w-full bg-gray-100 rounded-xl px-4 py-3 text-sm"></textarea></div><div class="flex gap-3 mt-6"><button @click="showItineraryModal = false" class="flex-1 py-3 bg-gray-100 rounded-xl font-bold text-gray-600">å–æ¶ˆ</button><button v-if="isEditing" @click="deleteItinerary" class="px-4 py-3 bg-red-50 text-red-500 rounded-xl font-bold"><i class="fa-solid fa-trash"></i></button><button @click="saveItinerary" class="flex-1 py-3 bg-primary text-white rounded-xl font-bold shadow-lg">å„²å­˜</button></div></div></div>
        <div v-if="showFoodModal" class="fixed inset-0 bg-black/50 z-50 flex items-end sm:items-center justify-center backdrop-blur-sm p-4"><div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl animate-slide-up"><h3 class="text-xl font-bold mb-4">æ–°å¢ç¾é£Ÿ</h3><div class="space-y-4 max-h-[60vh] overflow-y-auto no-scrollbar"><input v-model="formFood.name" placeholder="åç¨±" class="w-full bg-gray-100 rounded-xl px-4 py-3"><input v-model="formFood.engName" placeholder="Google Maps è‹±æ–‡å" class="w-full bg-gray-100 rounded-xl px-4 py-3"><select v-model="formFood.category" class="w-full bg-gray-100 rounded-xl px-4 py-3"><option v-for="c in foodCategories" :value="c">{{ c }}</option></select><input v-model="formFood.mustEat" placeholder="å¿…åƒ" class="w-full bg-gray-100 rounded-xl px-4 py-3"></div><div class="flex gap-3 mt-6"><button @click="showFoodModal = false" class="flex-1 py-3 bg-gray-100 rounded-xl font-bold text-gray-600">å–æ¶ˆ</button><button @click="saveFood" class="flex-1 py-3 bg-michelin text-white rounded-xl font-bold shadow-lg">åŠ å…¥</button></div></div></div>
        <div v-if="showExpenseModal" class="fixed inset-0 bg-black/50 z-50 flex items-end sm:items-center justify-center backdrop-blur-sm p-4"><div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl animate-slide-up"><h3 class="text-xl font-bold mb-4">è¨˜ä¸€ç­†</h3><div class="space-y-4"><input v-model="formExpense.title" placeholder="é …ç›®" class="w-full bg-gray-100 rounded-xl px-4 py-3"><input v-model.number="formExpense.amount" type="number" placeholder="é‡‘é¡ (THB)" class="w-full bg-gray-100 rounded-xl px-4 py-3 font-mono text-lg"><div class="flex flex-wrap gap-2"><button v-for="m in members" :key="m" @click="formExpense.payer = m" class="px-4 py-2 rounded-lg text-sm font-bold border transition" :class="formExpense.payer === m ? 'bg-secondary text-white' : 'bg-white text-gray-500'">{{ m }}</button></div></div><div class="flex gap-3 mt-6"><button @click="showExpenseModal = false" class="flex-1 py-3 bg-gray-100 rounded-xl font-bold text-gray-600">å–æ¶ˆ</button><button @click="saveExpense" class="flex-1 py-3 bg-secondary text-white rounded-xl font-bold shadow-lg">æ–°å¢</button></div></div></div>
        <div v-if="showThaiAddrModal" class="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-6 backdrop-blur-sm"><div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl text-center"><div class="w-16 h-16 bg-purple-100 text-purple-600 rounded-full flex items-center justify-center mx-auto mb-4 text-2xl"><i class="fa-solid fa-taxi"></i></div><h3 class="text-lg font-bold text-gray-500 mb-2">è«‹å¸æ©Ÿå»é€™è£¡</h3><h2 class="text-2xl font-bold text-gray-900 mb-6 leading-relaxed select-all">{{ thaiAddrContent }}</h2><button @click="showThaiAddrModal = false" class="w-full py-3 rounded-xl bg-gray-800 text-white font-bold">é—œé–‰</button></div></div>
        
        <!-- Settings Modal -->
        <div v-if="showSettings" class="fixed inset-0 bg-black/50 z-50 flex items-end sm:items-center justify-center backdrop-blur-sm p-4">
            <div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl overflow-y-auto max-h-[85vh]">
                <h3 class="text-xl font-bold mb-4">è¨­å®š</h3>
                
                <div v-if="isCloudMode" class="bg-green-50 border border-green-200 rounded-xl p-3 mb-4">
                    <p class="text-xs text-green-700 font-bold mb-1"><i class="fa-solid fa-cloud-check mr-1"></i> å·²é€£ç·šè‡³é›²ç«¯</p>
                    <p class="text-[10px] text-gray-500 mb-1">æ—…ç¨‹ä»£ç¢¼: <span class="font-mono bg-white px-1 border rounded select-all">{{ tripId }}</span></p>
                    <p class="text-[10px] text-gray-400">UID: {{ authUid || 'æœªç™»å…¥' }}</p>
                </div>

                <div class="mb-4">
                    <button @click="showConfigModal = true" class="w-full py-2 border border-gray-300 rounded-xl text-sm font-bold text-gray-600"><i class="fa-solid fa-wrench"></i> ä¿®æ”¹è³‡æ–™åº«è¨­å®š</button>
                </div>

                <div class="mb-4">
                    <label class="block text-xs font-bold text-gray-500 mb-2">æ—…ä¼´ç®¡ç†</label>
                    <div class="flex gap-2 mb-2"><input v-model="newMemberName" placeholder="è¼¸å…¥åå­—" class="flex-1 bg-gray-100 rounded-xl px-4 py-2 outline-none"><button @click="addMember" class="bg-gray-800 text-white px-4 rounded-xl font-bold">+</button></div>
                    <div class="flex flex-wrap gap-2 mt-3"><div v-for="(m, idx) in members" :key="idx" class="bg-gray-100 px-3 py-1 rounded-full text-sm flex items-center gap-2">{{ m }}<button @click="removeMember(idx)" class="text-gray-400 hover:text-red-500">Ã—</button></div></div>
                </div>

                <div class="pt-4 border-t border-gray-100">
                    <button @click="resetAllData" class="w-full py-3 rounded-xl border border-red-200 text-red-500 font-bold mb-2">é‡ç½®è³‡æ–™ (Reset)</button>
                    <button @click="showSettings = false" class="w-full py-3 rounded-xl bg-gray-800 text-white font-bold">å®Œæˆ</button>
                </div>
            </div>
        </div>

        <!-- Settlement Modal -->
        <div v-if="showSettlementModal" class="fixed inset-0 bg-black/50 z-50 flex items-end sm:items-center justify-center backdrop-blur-sm p-4"><div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl max-h-[80vh] overflow-y-auto"><div class="flex justify-between items-center mb-4"><h3 class="text-xl font-bold">çµç®—å»ºè­°</h3><button @click="showSettlementModal = false" class="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center text-gray-500"><i class="fa-solid fa-xmark"></i></button></div><div class="bg-blue-50 p-4 rounded-xl text-sm text-blue-800 mb-4"><p class="font-bold mb-1">ç¸½èŠ±è²»: à¸¿{{ totalExpense }}</p><p>å¹³å‡æ¯äºº: à¸¿{{ (totalExpense / members.length).toFixed(1) }}</p></div><div v-if="settlements.length > 0" class="space-y-3"><div v-for="(s, idx) in settlements" :key="idx" class="flex items-center justify-between p-3 border border-gray-100 rounded-xl shadow-sm"><div class="flex items-center gap-2"><span class="font-bold text-red-500">{{ s.from }}</span><i class="fa-solid fa-arrow-right text-gray-300 text-xs"></i><span class="font-bold text-green-500">{{ s.to }}</span></div><span class="font-mono font-bold bg-gray-100 px-2 py-1 rounded">à¸¿{{ Math.round(s.amount) }}</span></div></div><div v-else class="text-center py-6 text-green-600 font-bold"><p>å¸³ç›®å·²å¹³è¡¡ï¼</p></div></div></div>

    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
        import { getFirestore, doc, onSnapshot, setDoc, getDoc, updateDoc, arrayUnion, arrayRemove, collection } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";
        const { createApp, ref, computed, onMounted, watch } = Vue;

        createApp({
            setup() {
                const currentTab = ref('itinerary');
                const hasInitialized = ref(false);
                const isLoading = ref(false);
                const isCloudMode = ref(false);
                const tripId = ref('');
                const inputTripId = ref('');
                
                // Config Handling
                const showConfigModal = ref(false);
                const configInput = ref('');
                const hasCustomConfig = ref(false);

                let tripDocRef = null;
                let unsubscribeSnapshot = null;
                const currentUser = ref(null);
                const authUid = ref('');
                
                // Init Firebase Variables
                let app, auth, db;
                let appId = 'bangkok_app';
                let isInternalEnv = false;

                const defaultItinerary = [
                    { id: 1, date: '12/26 (äº”)', title: 'å•Ÿç¨‹æ›¼è°·', items: [
                        { id: 101, time: '12:05', title: 'æŠµé” BKK æ©Ÿå ´', location: 'Suvarnabhumi Airport', desc: 'é ˜å®Œè¡Œæå¾Œï¼Œå‰å¾€é å®šå¥½çš„å°ˆè»Šæ¥æ©Ÿé»é›†åˆã€‚', transport: 'åŒ…è»Š/æ¥é€' },
                        { id: 102, time: '14:00', title: 'é£¯åº— Check-in & ä¼‘æ¯', location: 'Centre Point Hotel Sukhumvit 10', thaiAddr: '39 à¸‹à¸­à¸¢ à¸ªà¸¸à¸‚à¸¸à¸¡à¸§à¸´à¸— 10 à¹à¸‚à¸§à¸‡à¸„à¸¥à¸­à¸‡à¹€à¸•à¸¢', desc: 'è®“é•·è¼©å°å­©å…ˆä¼‘æ¯ï¼Œæ•´ç†è¡Œæã€‚', tags: ['ä½å®¿'] },
                        { id: 103, time: '15:30', title: 'Chef Ple èŠ’æœç³¯ç±³é£¯', location: 'Chef Ple Thai Mango Sticky Rice', desc: 'åœ¨ Times Square Building æ—ã€‚å¯å¤–å¸¶å›é£¯åº—åƒã€‚', transport: 'æ­¥è¡Œ/TukTuk' },
                        { id: 104, time: '17:30', title: 'EmSphere å•†å ´æ™šé¤', location: 'EmSphere', thaiAddr: '628 à¸–à¸™à¸™à¸ªà¸¸à¸‚à¸¸à¸¡à¸§à¸´à¸— à¹à¸‚à¸§à¸‡à¸„à¸¥à¸­à¸‡à¸•à¸±à¸™ à¹€à¸‚à¸•à¸„à¸¥à¸­à¸‡à¹€à¸•à¸¢', desc: 'é¤å»³ï¼šKub Kao Kub Pla (åƒé£¯åƒé­š)ã€‚ç’°å¢ƒèˆ’é©ï¼Œå£å‘³é©åˆå…¨å®¶ã€‚', transport: 'Grab/åŒ…è»Š', tags: ['æ™šé¤'] }
                    ]},
                    // ... (å…¶ä»–å¤©æ•¸ä¿æŒåŸæ¨£ï¼Œç‚ºç¯€çœç©ºé–“çœç•¥ï¼Œå¯¦éš›åŸ·è¡Œæ™‚è«‹ä¿ç•™)
                ];
                
                const defaultMichelin = [
                    { name: "Jay Fai (ç—£å§)", engName: "Raan Jay Fai", area: "èˆŠåŸå€ (Old Town)", category: "Old Town", level: "1 Star", type: "è¡—é ­ç†±ç‚’", mustEat: "é»ƒé‡‘èŸ¹è‚‰è›‹æ² (Crab Omelette), é†‰æ¼¢éºµ", price: "à¸¿à¸¿à¸¿à¸¿", note: "åƒ¹æ ¼æ˜‚è²´ï¼Œéœ€æ’éšŠæ•¸å°æ™‚æˆ–é ç´„ã€‚å”¯ä¸€ç±³èŠè“®æ˜Ÿç´šè·¯é‚Šæ”¤ã€‚" },
                    { name: "Thipsamai (é¬¼é–€æ³°å¼ç‚’éºµ)", engName: "Thipsamai Pad Thai Pratoopee", area: "èˆŠåŸå€ (Old Town)", category: "Old Town", level: "Bib", type: "ç‚’æ²³ç²‰", mustEat: "è›‹åŒ…æ³°å¼ç‚’æ²³ (Superb Pad Thai)", price: "à¸¿à¸¿", note: "å°±åœ¨ Jay Fai æ—é‚Šï¼Œæ’éšŠäººæ½®å¤šä½†æµå‹•å¿«ã€‚æ©˜å­æ±å¿…é»ï¼" },
                    // ... (å…¶ä»–é¤å»³ä¿æŒåŸæ¨£)
                ];

                const tripDays = ref(defaultItinerary);
                const expenses = ref([]);
                const members = ref(['æˆ‘', 'å®¶äººA']);
                const customFoodSpots = ref([]);
                const activeDayIndex = ref(0);

                // --- Firebase åˆå§‹åŒ–é‚è¼¯ ---
                const initializeFirebase = async () => {
                    let firebaseConfig;
                    
                    // 1. å„ªå…ˆæª¢æŸ¥æ˜¯å¦åœ¨ AI å…§éƒ¨ç’°å¢ƒ
                    if (typeof __firebase_config !== 'undefined') {
                        firebaseConfig = JSON.parse(__firebase_config);
                        appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                        isInternalEnv = true;
                        hasCustomConfig.value = true;
                    } 
                    // 2. æª¢æŸ¥æ˜¯å¦æœ‰è‡ªè¨‚ Config (åœ¨ localStorage)
                    else {
                        const localConfig = localStorage.getItem('custom_firebase_config');
                        if (localConfig) {
                            try {
                                firebaseConfig = JSON.parse(localConfig);
                                hasCustomConfig.value = true;
                            } catch(e) { console.error("Invalid local config"); }
                        }
                    }

                    // 3. å¦‚æœéƒ½æ²’æœ‰ï¼Œä½¿ç”¨ Dummy Config (é€™æœƒå°è‡´ç„¡æ³•é€£ç·šï¼Œæ‰€ä»¥æœƒæç¤ºç”¨æˆ¶)
                    if (!firebaseConfig) {
                        console.warn("No firebase config found. App will run in offline mode unless config is provided.");
                        return; // ç­‰å¾…ç”¨æˆ¶è¼¸å…¥è¨­å®š
                    }

                    try {
                        app = initializeApp(firebaseConfig);
                        auth = getAuth(app);
                        db = getFirestore(app);

                        onAuthStateChanged(auth, async (user) => {
                            currentUser.value = user;
                            authUid.value = user ? user.uid : '';
                            if (user) {
                                const savedTripId = localStorage.getItem('tripId');
                                if (savedTripId) await joinCloudTrip(savedTripId);
                            }
                        });

                        // ç™»å…¥
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            try { await signInWithCustomToken(auth, __initial_auth_token); } 
                            catch (e) { await signInAnonymously(auth); }
                        } else {
                            await signInAnonymously(auth);
                        }
                    } catch (e) {
                        console.error("Firebase Init Error:", e);
                        alert("è³‡æ–™åº«é€£ç·šå¤±æ•—ï¼Œè«‹æª¢æŸ¥è¨­å®šã€‚");
                    }
                };

                const saveCustomConfig = () => {
                    try {
                        const conf = JSON.parse(configInput.value);
                        localStorage.setItem('custom_firebase_config', JSON.stringify(conf));
                        alert("è¨­å®šå·²å„²å­˜ï¼Œé é¢å°‡é‡æ–°æ•´ç†ã€‚");
                        location.reload();
                    } catch(e) {
                        alert("è¨­å®šæ ¼å¼éŒ¯èª¤ï¼Œè«‹ç¢ºä¿æ˜¯æ­£ç¢ºçš„ JSON æ ¼å¼ã€‚");
                    }
                };

                onMounted(() => {
                    initializeFirebase();
                });

                const initOffline = () => {
                    isCloudMode.value = false;
                    localStorage.setItem('appMode', 'offline');
                    loadFromLocalStorage();
                    hasInitialized.value = true;
                };

                const loadFromLocalStorage = () => {
                    const localTrips = localStorage.getItem('tripDays_v2');
                    if (localTrips) tripDays.value = JSON.parse(localTrips);
                    const localExp = localStorage.getItem('expenses');
                    if (localExp) expenses.value = JSON.parse(localExp);
                    const localMem = localStorage.getItem('members');
                    if (localMem) members.value = JSON.parse(localMem);
                    const localFood = localStorage.getItem('customFoodSpots');
                    if (localFood) customFoodSpots.value = JSON.parse(localFood);
                };

                const createCloudTrip = async () => {
                    if (!db) return alert("è«‹å…ˆè¨­å®šè³‡æ–™åº«ï¼");
                    let idToUse = inputTripId.value;
                    if (!idToUse) {
                        const userCustomName = prompt("è«‹è¼¸å…¥æ—…ç¨‹åç¨± (ä¾‹å¦‚: FWD_BKK_TRIP)ã€‚\nå¦‚æœä¸è¼¸å…¥ï¼Œç³»çµ±å°‡è‡ªå‹•ç”¢ç”Ÿã€‚", "");
                        if (userCustomName) idToUse = userCustomName;
                    }
                    const newId = (idToUse || 'BANGKOK_' + Math.floor(Math.random()*10000)).toUpperCase();
                    await connectToTrip(newId, true);
                };

                const joinCloudTrip = async (id = null) => {
                    if (!db) return alert("è«‹å…ˆè¨­å®šè³‡æ–™åº«ï¼");
                    const targetId = id || inputTripId.value.toUpperCase();
                    if(!targetId) return alert("è«‹è¼¸å…¥ä»£ç¢¼");
                    await connectToTrip(targetId, false);
                };

                // --- é—œéµè·¯å¾‘ä¿®æ­£ï¼šç¬¦åˆç”¨æˆ¶æˆªåœ– trips/{id} ---
                const getTripDocRef = (id) => {
                    if (isInternalEnv) {
                        return doc(db, 'artifacts', appId, 'public', 'data', 'trips', id);
                    } else {
                        // å¤–éƒ¨ç’°å¢ƒç›´æ¥å­˜å–æ ¹ç›®éŒ„ trips é›†åˆ
                        return doc(db, 'trips', id);
                    }
                };

                const connectToTrip = async (id, isNew) => {
                    if (!currentUser.value) {
                        alert("å°šæœªç™»å…¥è³‡æ–™åº«ï¼Œè«‹ç¨å€™æˆ–æª¢æŸ¥è¨­å®šã€‚");
                        return;
                    }
                    isLoading.value = true;
                    tripId.value = id;
                    
                    tripDocRef = getTripDocRef(id);

                    try {
                        if (isNew) {
                            await setDoc(tripDocRef, {
                                tripDays: defaultItinerary,
                                expenses: [],
                                members: ['æˆ‘'],
                                customFoodSpots: []
                            });
                        }

                        if (unsubscribeSnapshot) unsubscribeSnapshot();

                        unsubscribeSnapshot = onSnapshot(tripDocRef, (docSnap) => {
                            if (docSnap.exists()) {
                                const data = docSnap.data();
                                if (data.tripDays) tripDays.value = data.tripDays;
                                if (data.expenses) expenses.value = data.expenses;
                                if (data.members) members.value = data.members;
                                if (data.customFoodSpots) customFoodSpots.value = data.customFoodSpots;
                            }
                            isLoading.value = false;
                            hasInitialized.value = true;
                            isCloudMode.value = true;
                            localStorage.setItem('appMode', 'cloud');
                            localStorage.setItem('tripId', id);
                        }, (error) => {
                             console.error("Snapshot error:", error);
                             isLoading.value = false;
                             alert(`è®€å–å¤±æ•—: ${error.message}\nè«‹æª¢æŸ¥ Firebase Console çš„ Rules è¨­å®š (æ‡‰å…è¨± read/write)ã€‚`);
                             initOffline(); // Fallback
                        });

                    } catch (e) {
                        console.error(e);
                        alert("é€£ç·šå¤±æ•—ï¼š" + e.message);
                        isLoading.value = false;
                    }
                };

                const sanitize = (obj) => {
                    return JSON.parse(JSON.stringify(obj, (key, value) => {
                        return value === undefined ? null : value;
                    }));
                };

                const saveData = () => {
                    if (isCloudMode.value && tripDocRef) {
                        const dataToSave = sanitize({
                            tripDays: tripDays.value,
                            expenses: expenses.value,
                            members: members.value,
                            customFoodSpots: customFoodSpots.value
                        });
                        
                        updateDoc(tripDocRef, dataToSave).catch(e => {
                            console.error("Cloud save error", e);
                            alert(`å­˜æª”å¤±æ•—: ${e.message}\nå¯èƒ½åŸå› ï¼šæ¬Šé™ä¸è¶³ã€‚è«‹æª¢æŸ¥ Firebase Rulesã€‚`);
                        });
                    } else {
                        localStorage.setItem('tripDays_v2', JSON.stringify(tripDays.value));
                        localStorage.setItem('expenses', JSON.stringify(expenses.value));
                        localStorage.setItem('members', JSON.stringify(members.value));
                        localStorage.setItem('customFoodSpots', JSON.stringify(customFoodSpots.value));
                    }
                };

                watch([tripDays, expenses, members, customFoodSpots], saveData, { deep: true });

                const activeFoodCategory = ref('å…¨å€');
                const foodCategories = ['å…¨å€', 'Siam', 'Sukhumvit', 'Old Town', 'Silom'];
                const foodSpots = computed(() => [...customFoodSpots.value, ...defaultMichelin]);
                const filteredFoodSpots = computed(() => activeFoodCategory.value === 'å…¨å€' ? foodSpots.value : foodSpots.value.filter(s => s.category === activeFoodCategory.value));
                
                const showItineraryModal = ref(false);
                const showFoodModal = ref(false);
                const showExpenseModal = ref(false);
                const showSettlementModal = ref(false);
                const showSettings = ref(false);
                const showThaiAddrModal = ref(false);
                const thaiAddrContent = ref('');
                const isEditing = ref(false);
                const editingId = ref(null);
                
                const formItinerary = ref({});
                const formFood = ref({});
                const formExpense = ref({});
                
                const currentDayItems = computed(() => tripDays.value[activeDayIndex.value]?.items || []);
                const totalExpense = computed(() => expenses.value.reduce((sum, i) => sum + i.amount, 0));
                
                const addDay = () => { tripDays.value.push({id: Date.now(), date: `Day ${tripDays.value.length+1}`, items:[]}); activeDayIndex.value = tripDays.value.length-1; };
                
                const openItineraryModal = () => { 
                    isEditing.value = false; 
                    formItinerary.value = {time:'10:00', title:'', location:'', transport:'', desc:''}; 
                    showItineraryModal.value = true; 
                };
                
                const saveItinerary = () => {
                    if(!formItinerary.value.title) return;
                    if(isEditing.value) {
                        const day = tripDays.value[activeDayIndex.value];
                        const idx = day.items.findIndex(i => i.id === editingId.value);
                        if(idx!==-1) day.items[idx] = {...formItinerary.value, id: editingId.value};
                    } else {
                        tripDays.value[activeDayIndex.value].items.push({id: Date.now(), ...formItinerary.value});
                    }
                    showItineraryModal.value = false;
                };
                const editItem = (item) => { isEditing.value = true; editingId.value = item.id; formItinerary.value = {...item}; showItineraryModal.value = true; };
                const deleteItinerary = () => { 
                    const day = tripDays.value[activeDayIndex.value]; 
                    day.items = day.items.filter(i => i.id !== editingId.value); 
                    showItineraryModal.value = false; 
                };
                
                const openFoodModal = () => { 
                    formFood.value = {name: '', engName: '', category: 'Siam', mustEat: '', price:'à¸¿'}; 
                    showFoodModal.value = true; 
                };
                
                const saveFood = () => { 
                    try {
                         const newFood = {
                             id: Date.now(), 
                             isCustom:true, 
                             name: formFood.value.name || 'æœªå‘½åé¤å»³', 
                             engName: formFood.value.engName || '',
                             category: formFood.value.category || 'Siam',
                             mustEat: formFood.value.mustEat || '',
                             price: formFood.value.price || 'à¸¿'
                         };
                         customFoodSpots.value.unshift(newFood); 
                         showFoodModal.value = false; 
                    } catch(e) {
                        alert("æ–°å¢å¤±æ•—: " + e.message);
                    }
                };
                
                const deleteCustomFood = (id) => { if(confirm('åˆªé™¤?')) customFoodSpots.value = customFoodSpots.value.filter(f=>f.id!==id); };
                
                const openExpenseModal = () => { 
                    formExpense.value = {title: '', amount: '', payer: members.value[0]}; 
                    showExpenseModal.value = true; 
                };
                
                const saveExpense = () => { 
                    if (formExpense.value.amount === '') return alert("è«‹è¼¸å…¥é‡‘é¡");
                    try {
                        const newExpense = {
                            id: Date.now(), 
                            title: formExpense.value.title || 'ä¸€èˆ¬æ¶ˆè²»',
                            amount: Number(formExpense.value.amount) || 0,
                            payer: formExpense.value.payer || members.value[0]
                        };
                        expenses.value.unshift(newExpense); 
                        showExpenseModal.value = false; 
                    } catch (e) {
                        alert("æ–°å¢å¤±æ•—: " + e.message);
                    }
                };
                
                const deleteExpense = (id) => { if(confirm('åˆªé™¤?')) expenses.value = expenses.value.filter(e=>e.id!==id); };
                
                const settlements = computed(() => {
                    if (members.value.length === 0) return [];
                    const balances = {}; members.value.forEach(m => balances[m] = 0);
                    const split = totalExpense.value / members.value.length;
                    expenses.value.forEach(e => { if(balances[e.payer]!==undefined) balances[e.payer]+=e.amount; });
                    let debtors=[], creditors=[];
                    for(const m in balances) { const net=balances[m]-split; if(net<-0.1) debtors.push({name:m, amt:Math.abs(net)}); else if(net>0.1) creditors.push({name:m, amt:net}); }
                    const res = []; let i=0,j=0;
                    while(i<debtors.length && j<creditors.length) {
                        const amt = Math.min(debtors[i].amt, creditors[j].amt);
                        if(amt>0) res.push({from:debtors[i].name, to:creditors[j].name, amount:amt});
                        debtors[i].amt-=amt; creditors[j].amt-=amt;
                        if(debtors[i].amt<0.1) i++; if(creditors[j].amt<0.1) j++;
                    }
                    return res;
                });
                const getPaidAmount = (p) => expenses.value.filter(e=>e.payer===p).reduce((s,e)=>s+e.amount,0);
                
                const newMemberName = ref('');
                const addMember = () => { if(newMemberName.value && !members.value.includes(newMemberName.value)) { members.value.push(newMemberName.value); newMemberName.value=''; } };
                const removeMember = (idx) => members.value.splice(idx,1);
                
                const resetAllData = () => { if(confirm('é‡ç½®æ‰€æœ‰è³‡æ–™?')) { localStorage.clear(); location.reload(); } };
                
                const showThaiAddress = (item) => { thaiAddrContent.value = item.thaiAddr; showThaiAddrModal.value = true; };
                const openMap = (loc) => window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(loc+' Bangkok')}`);

                const calcTHB = ref(''); const calcHKD = ref(''); const currentRate = ref(4.4);
                const updateFromTHB = () => calcHKD.value = calcTHB.value ? (calcTHB.value/currentRate.value).toFixed(2) : '';
                const updateFromHKD = () => calcTHB.value = calcHKD.value ? (calcHKD.value*currentRate.value).toFixed(0) : '';

                return {
                    currentTab, hasInitialized, isLoading, isCloudMode, tripId, inputTripId, authUid,
                    initOffline, createCloudTrip, joinCloudTrip,
                    tripDays, activeDayIndex, currentDayItems, addDay,
                    showItineraryModal, formItinerary, isEditing, openItineraryModal, editItem, saveItinerary, deleteItinerary,
                    expenses, totalExpense, showExpenseModal, formExpense, saveExpense, deleteExpense,
                    showFoodModal, formFood, saveFood, deleteCustomFood,
                    foodCategories, activeFoodCategory, filteredFoodSpots,
                    showSettings, members, newMemberName, addMember, removeMember, resetAllData,
                    showSettlementModal, settlements, getPaidAmount, showThaiAddrModal, thaiAddrContent, showThaiAddress, openMap,
                    calcTHB, calcHKD, currentRate, updateFromTHB, updateFromHKD,
                    showConfigModal, configInput, hasCustomConfig, saveCustomConfig
                };
            }
        }).mount('#app');
    </script>
    <style>
        @keyframes slide-up { from { transform: translateY(100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .animate-slide-up { animation: slide-up 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
    </style>
</body>
</html>


