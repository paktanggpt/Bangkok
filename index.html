<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="æ›¼è°·è¦ªå­éŠ">
    
    <title>æ›¼è°· 6 å¤© 5 å¤œè¦ªå­å°Šäº«ä¹‹æ—…</title>

    <link rel="apple-touch-icon" href="./icon.jpg">
    <link rel="icon" href="./icon.jpg">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        body, #app { height: 100vh; height: 100dvh; }
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #F3F4F6; -webkit-tap-highlight-color: transparent; overscroll-behavior-y: none; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .scrolling-touch { -webkit-overflow-scrolling: touch; }
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
        [v-cloak] { display: none !important; }
        
        input[type="time"] {
            -webkit-appearance: none;
            appearance: none;
            background-color: #F3F4F6;
            padding: 0.75rem 1rem;
            border-radius: 0.75rem;
            width: 100%;
            display: block;
            min-height: 3rem;
            font-size: 1rem;
            line-height: 1.5;
            text-align: left;
        }
        
        .toast-enter-active, .toast-leave-active { transition: all 0.3s ease; }
        .toast-enter-from, .toast-leave-to { opacity: 0; transform: translateY(20px); }
        
        .fade-enter-active, .fade-leave-active { transition: opacity 0.3s ease; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }

        .prose p { margin-bottom: 0.5em; }
        .prose ul { list-style-type: disc; padding-left: 1.2em; margin-bottom: 0.5em; }
        .prose strong { color: #FF8C00; font-weight: 700; }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: { colors: { primary: '#FF8C00', secondary: '#4B0082', bg: '#F3F4F6', michelin: '#BD2333' } }
            }
        }
    </script>
</head>
<body class="overflow-hidden text-gray-800">

    <div id="app" v-cloak class="flex flex-col relative max-w-md mx-auto bg-white shadow-2xl h-full">
        
        <!-- Sync Status Bar (Top Overlay) -->
        <transition name="fade">
            <div v-if="statusMsg && statusMsg !== 'å°±ç·’'" class="fixed top-0 left-0 right-0 z-50 bg-black/70 text-white text-xs py-1 px-3 text-center backdrop-blur-sm">
                <i class="fa-solid fa-rotate fa-spin mr-1" v-if="statusMsg.includes('ä¸­')"></i>
                <i class="fa-solid fa-check mr-1 text-green-400" v-if="statusMsg.includes('å®Œæˆ')"></i>
                {{ statusMsg }}
            </div>
        </transition>
        
        <!-- Error Toast -->
        <transition name="toast">
            <div v-if="errorMsg" class="fixed top-10 left-4 right-4 bg-red-600 text-white p-4 rounded-xl shadow-2xl z-[100] flex items-start gap-3">
                <i class="fa-solid fa-circle-exclamation mt-1"></i>
                <div class="flex-1 text-xs">
                    <h4 class="font-bold text-sm mb-1">ç³»çµ±æç¤º</h4>
                    <p>{{ errorMsg }}</p>
                    <p v-if="errorHelp" class="mt-2 font-mono bg-red-700 p-1 rounded">{{ errorHelp }}</p>
                </div>
                <button @click="errorMsg = null" class="text-white opacity-70"><i class="fa-solid fa-xmark"></i></button>
            </div>
        </transition>

        <!-- Header -->
        <header class="bg-white px-5 pt-10 pb-4 shadow-sm z-10 flex justify-between items-center sticky top-0 shrink-0">
            <div>
                <h1 class="text-2xl font-bold text-gray-900 tracking-tight flex items-center gap-2">
                    <span class="text-primary">Sawadee</span> Bangkok ğŸ‡¹ğŸ‡­
                </h1>
                <p class="text-xs text-gray-500 font-medium mt-1 flex items-center gap-2">
                    <span v-if="tripId" class="bg-gray-100 px-2 py-0.5 rounded text-gray-600 select-all font-mono">{{ tripId }}</span>
                    <span v-else>è«‹å»ºç«‹æ—…ç¨‹</span>
                    
                    <span v-if="isCloudMode" class="text-[10px] text-green-600 bg-green-50 px-1.5 py-0.5 rounded-full flex items-center">
                        <span class="w-1.5 h-1.5 bg-green-500 rounded-full mr-1"></span> ç·šä¸Š
                    </span>
                    <span v-else class="text-[10px] text-gray-400 bg-gray-100 px-1.5 py-0.5 rounded-full">å–®æ©Ÿ</span>
                </p>
            </div>
            <div class="flex gap-2">
                <button @click="showAIModal = true" class="w-8 h-8 rounded-full bg-gradient-to-tr from-blue-500 to-purple-600 text-white shadow-md flex items-center justify-center hover:scale-110 transition relative">
                    <i class="fa-solid fa-wand-magic-sparkles"></i>
                </button>
                <button @click="showSettings = true" class="text-gray-400 hover:text-primary transition">
                    <i class="fa-solid fa-gear text-lg"></i>
                </button>
            </div>
        </header>

        <!-- Main Content Area -->
        <main class="flex-1 overflow-y-auto no-scrollbar scrolling-touch bg-gray-50 p-4 pb-24 relative w-full">
            
            <!-- Setup Screen -->
            <div v-if="!hasInitialized" class="flex flex-col items-center justify-center h-full text-center space-y-6">
                <div class="w-20 h-20 bg-orange-100 rounded-full flex items-center justify-center text-primary text-3xl mb-2 animate-bounce">
                    <i class="fa-solid fa-plane-departure"></i>
                </div>
                <h2 class="text-xl font-bold">æ­¡è¿ä½¿ç”¨æ›¼è°·æ—…éŠåŠ©æ‰‹</h2>
                
                <div class="w-full space-y-3 px-4">
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-blue-100 space-y-4">
                        <h3 class="font-bold text-blue-600 text-sm"><i class="fa-solid fa-users mr-1"></i> å¤šäººåŒæ­¥æ¨¡å¼</h3>
                        <p class="text-xs text-gray-500 text-left">è«‹è¼¸å…¥ä¸€å€‹å¤§å®¶éƒ½èƒ½è¨˜ä½çš„ä»£ç¢¼ï¼Œä¾‹å¦‚ "FAMILY2025"ã€‚</p>
                        
                        <div>
                            <input v-model="inputTripId" type="text" placeholder="è«‹è¼¸å…¥æ—…ç¨‹ä»£ç¢¼ (è‹±æ–‡)" class="w-full bg-gray-100 px-4 py-3 rounded-xl text-lg font-bold text-center uppercase tracking-wide outline-none focus:ring-2 focus:ring-blue-500 placeholder-gray-300">
                        </div>

                        <button @click="joinCloudTrip()" class="w-full py-3 bg-primary text-white rounded-xl font-bold shadow-lg hover:bg-orange-600 transition flex items-center justify-center gap-2">
                            <i class="fa-solid fa-cloud" v-if="!isLoading"></i>
                            <div v-else class="loader"></div>
                            {{ isLoading ? 'é€£ç·šä¸­...' : 'åŠ å…¥ / å»ºç«‹æ—…ç¨‹' }}
                        </button>
                        
                        <p class="text-[10px] text-gray-400 mt-2">
                            <i class="fa-solid fa-server"></i> è‡ªå‹•é€£ç·šè‡³ bangkok-trip-app
                        </p>

                         <div class="text-center pt-2 border-t border-gray-100 mt-2">
                             <button @click="startApp" class="text-xs text-gray-400 underline">
                                æš«ä¸é€£ç·šï¼Œä½¿ç”¨å–®æ©Ÿç‰ˆ
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Main App Content -->
            <div v-else>
                <!-- ITINERARY TAB -->
                <div v-if="currentTab === 'itinerary'" class="space-y-4">
                    <div class="rounded-2xl overflow-hidden shadow-md mb-4 border border-gray-100 relative h-40 bg-gray-200">
                        <img src="https://images.unsplash.com/photo-1508009603885-50cf7c579365?q=80&w=1000&auto=format&fit=crop" alt="Bangkok" class="w-full h-full object-cover block">
                        <div class="absolute inset-0 bg-gradient-to-t from-black/50 to-transparent flex items-end p-4">
                            <span class="text-white font-bold text-lg">Bangkok City of Angels</span>
                        </div>
                    </div>

                    <div class="flex space-x-3 overflow-x-auto no-scrollbar pb-2">
                        <button v-for="(day, index) in tripDays" :key="index" @click="activeDayIndex = index" class="flex-shrink-0 px-4 py-2 rounded-full text-sm font-bold transition-all transform active:scale-95 shadow-sm flex flex-col items-center min-w-[80px]" :class="activeDayIndex === index ? 'bg-primary text-white shadow-md' : 'bg-white text-gray-500 border border-gray-100'"><span>Day {{ index + 1 }}</span><span class="text-[10px] font-normal opacity-80">{{ day.date }}</span></button>
                        <button @click="addDay" class="flex-shrink-0 px-3 py-2 rounded-full text-sm bg-gray-200 text-gray-600"><i class="fa-solid fa-plus"></i></button>
                    </div>

                    <div class="bg-orange-50 p-4 rounded-xl border border-orange-100 mb-2">
                        <h2 class="font-bold text-lg text-gray-800">{{ tripDays[activeDayIndex].title || 'è‡ªç”±æ´»å‹•' }}</h2>
                        <p class="text-xs text-gray-500 mt-1" v-if="tripDays[activeDayIndex].note"><i class="fa-solid fa-circle-info mr-1 text-primary"></i>{{ tripDays[activeDayIndex].note }}</p>
                    </div>

                    <div class="relative pl-4 space-y-6 mt-4">
                        <div class="absolute left-4 top-2 bottom-2 w-0.5 bg-gray-200"></div>
                        <div v-for="item in currentDayItems" :key="item.id" class="relative pl-6 group">
                            <div class="absolute left-[11px] top-1.5 w-3 h-3 bg-white border-2 border-primary rounded-full z-10 group-hover:bg-primary transition-colors"></div>
                            <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 active:scale-[0.99] transition-transform">
                                <div class="flex justify-between items-start mb-2">
                                    <div class="font-bold text-primary text-lg">{{ item.time }}</div>
                                    <div class="flex space-x-1">
                                        <button v-if="item.thaiAddr" @click="showThaiAddress(item)" class="w-8 h-8 rounded-full bg-purple-50 text-purple-600 flex items-center justify-center hover:bg-purple-100"><i class="fa-solid fa-language text-sm"></i></button>
                                        <button @click="openMap(item.location)" class="w-8 h-8 rounded-full bg-blue-50 text-blue-500 flex items-center justify-center hover:bg-blue-100"><i class="fa-solid fa-location-arrow text-sm"></i></button>
                                        <button @click="editItem(item)" class="w-8 h-8 rounded-full bg-gray-50 text-gray-400 flex items-center justify-center hover:text-gray-600"><i class="fa-solid fa-pen text-xs"></i></button>
                                    </div>
                                </div>
                                <h3 class="font-bold text-gray-800 text-lg leading-tight mb-1">{{ item.title }}</h3>
                                <div class="flex items-center text-gray-500 text-sm mb-2"><i class="fa-solid fa-map-pin mr-1.5 text-xs text-gray-400 w-4 text-center"></i><span class="truncate">{{ item.location }}</span></div>
                                <div class="flex flex-wrap gap-2 mt-2">
                                    <span v-if="item.transport" class="inline-flex items-center px-2 py-1 rounded-md text-xs font-medium bg-gray-100 text-gray-600"><i class="fa-solid fa-van-shuttle mr-1"></i> {{ item.transport }}</span>
                                    <span v-if="item.tags" v-for="tag in item.tags" :key="tag" class="inline-flex items-center px-2 py-1 rounded-md text-xs font-medium bg-orange-50 text-orange-600">{{ tag }}</span>
                                </div>
                                <p v-if="item.desc" class="text-sm text-gray-500 mt-3 border-t pt-2 border-gray-50 leading-relaxed">{{ item.desc }}</p>
                            </div>
                        </div>
                        <div v-if="currentDayItems.length === 0" class="text-center py-10 text-gray-400"><i class="fa-regular fa-calendar-xmark text-4xl mb-3 opacity-30"></i><p>é€™å¤©é‚„æ²’æœ‰è¡Œç¨‹<br>é»æ“Šä¸‹æ–¹æŒ‰éˆ•æ–°å¢</p></div>
                    </div>
                </div>

                <!-- FOOD TAB -->
                <div v-if="currentTab === 'food'" class="space-y-4">
                    <div class="flex space-x-2 overflow-x-auto no-scrollbar pb-2">
                        <button v-for="cat in foodCategories" :key="cat" @click="activeFoodCategory = cat" class="flex-shrink-0 px-4 py-2 rounded-full text-sm font-bold transition-all border whitespace-nowrap" :class="activeFoodCategory === cat ? 'bg-michelin text-white border-michelin shadow-md' : 'bg-white text-gray-500 border-gray-200'">{{ cat }}</button>
                    </div>
                    <div class="space-y-4">
                        <div v-for="spot in filteredFoodSpots" :key="spot.id || spot.name" class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden flex flex-col relative">
                            <button v-if="spot.isCustom" @click="deleteCustomFood(spot.id)" class="absolute top-2 right-2 text-gray-300 hover:text-red-500 p-2 z-10"><i class="fa-solid fa-trash text-xs"></i></button>
                            <div class="flex justify-between items-start p-4 pb-2">
                                <div class="flex flex-col pr-8">
                                    <div class="flex items-center gap-2 mb-1 flex-wrap">
                                        <span v-if="spot.level === '1 Star'" class="bg-yellow-100 text-yellow-700 px-2 py-0.5 rounded text-[10px] font-bold border border-yellow-200"><i class="fa-solid fa-star"></i> ç±³èŠè“®ä¸€æ˜Ÿ</span>
                                        <span v-else-if="spot.level === 'Bib'" class="bg-red-50 text-michelin px-2 py-0.5 rounded text-[10px] font-bold border border-red-100"><i class="fa-solid fa-face-grin-tongue"></i> å¿…æ¯”ç™»</span>
                                        <span v-else-if="spot.isCustom" class="bg-blue-50 text-blue-600 px-2 py-0.5 rounded text-[10px] font-bold border border-blue-100"><i class="fa-solid fa-user-pen"></i> è‡ªè¨‚</span>
                                        <span class="text-xs text-gray-400 font-medium">{{ spot.price }}</span>
                                    </div>
                                    <h3 class="font-bold text-gray-900 text-lg">{{ spot.name }}</h3>
                                    <p class="text-xs text-gray-500">{{ spot.engName }}</p>
                                </div>
                                <button @click="openMap(spot.engName || spot.name)" class="w-10 h-10 bg-blue-50 rounded-full flex items-center justify-center text-blue-500 hover:bg-blue-100 shadow-sm shrink-0"><i class="fa-solid fa-location-dot"></i></button>
                            </div>
                            <div class="px-4 pb-4">
                                <p class="text-sm text-gray-600 leading-relaxed border-t border-gray-50 pt-2" v-if="spot.mustEat"><span class="font-bold text-gray-800">å¿…é»ï¼š</span>{{ spot.mustEat }}</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- EXPENSE TAB -->
                <div v-if="currentTab === 'expense'" class="space-y-6">
                    <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-5">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="font-bold text-gray-800 flex items-center gap-2"><i class="fa-solid fa-money-bill-transfer text-green-500"></i> åŒ¯ç‡è¨ˆç®—</h3>
                            <div class="flex items-center gap-2 text-xs bg-gray-50 px-2 py-1 rounded-lg"><span class="text-gray-400">åŒ¯ç‡:</span><input type="number" v-model.number="currentRate" @input="updateFromHKD" class="w-12 bg-transparent font-bold text-gray-700 text-right outline-none border-b border-gray-300 focus:border-primary" step="0.01"></div>
                        </div>
                        <div class="flex items-center gap-3">
                            <div class="flex-1"><label class="block text-xs font-bold text-gray-400 mb-1">æ³°éŠ– (THB)</label><input type="number" v-model.number="calcTHB" @input="updateFromTHB" class="w-full bg-gray-50 rounded-xl px-3 py-2 text-lg font-bold text-gray-800 outline-none focus:ring-2 focus:ring-primary focus:bg-white text-center" placeholder="0"></div>
                            <div class="text-gray-300 pt-5"><i class="fa-solid fa-right-left"></i></div>
                            <div class="flex-1"><label class="block text-xs font-bold text-gray-400 mb-1">æ¸¯å¹£ (HKD)</label><input type="number" v-model.number="calcHKD" @input="updateFromHKD" class="w-full bg-gray-50 rounded-xl px-3 py-2 text-lg font-bold text-gray-800 outline-none focus:ring-2 focus:ring-primary focus:bg-white text-center" placeholder="0"></div>
                        </div>
                    </div>
                    <div class="bg-gradient-to-r from-secondary to-purple-600 rounded-2xl p-6 text-white shadow-lg relative overflow-hidden">
                        <div class="relative z-10">
                            <div class="text-purple-200 text-sm font-medium mb-1">ç¸½æ”¯å‡º (Total)</div>
                            <div class="text-4xl font-bold tracking-tight">à¸¿ {{ totalExpense.toLocaleString() }}</div>
                            <div class="mt-4 flex space-x-2 overflow-x-auto no-scrollbar">
                                <div v-for="(person, idx) in members" :key="idx" class="bg-white/20 px-3 py-1 rounded-lg text-xs backdrop-blur-sm whitespace-nowrap">{{ person }}: à¸¿ {{ getPaidAmount(person).toLocaleString() }}</div>
                            </div>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <button @click="showSettlementModal = true" class="bg-white border border-purple-100 text-secondary py-3 rounded-xl font-bold shadow-sm hover:bg-purple-50 transition flex items-center justify-center gap-2"><i class="fa-solid fa-calculator"></i> çµç®—å ±è¡¨</button>
                        <button @click="openExpenseModal()" class="bg-secondary text-white py-3 rounded-xl font-bold shadow-md shadow-purple-200 active:scale-95 transition flex items-center justify-center gap-2"><i class="fa-solid fa-plus"></i> æ–°å¢æ¶ˆè²»</button>
                    </div>
                    <div>
                        <h3 class="font-bold text-gray-700 mb-3 px-1">æœ€è¿‘æ¶ˆè²»è¨˜éŒ„</h3>
                        <div class="space-y-3">
                            <div v-for="exp in expenses" :key="exp.id" class="bg-white p-4 rounded-xl shadow-sm flex justify-between items-center border border-gray-50">
                                <div class="flex items-center gap-3"><div class="w-10 h-10 rounded-full bg-purple-50 text-secondary flex items-center justify-center font-bold text-xs">{{ exp.payer.charAt(0) }}</div><div><div class="font-bold text-gray-800">{{ exp.title }}</div><div class="text-xs text-gray-500">{{ exp.payer }} å…ˆä»˜</div></div></div>
                                <div class="text-right"><div class="font-bold text-gray-900">à¸¿{{ exp.amount }}</div><button @click="deleteExpense(exp.id)" class="text-xs text-red-300 hover:text-red-500 mt-1">åˆªé™¤</button></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- AI Modal -->
        <div v-if="showAIModal" class="fixed inset-0 bg-black/60 z-[80] flex items-end sm:items-center justify-center backdrop-blur-sm p-0 sm:p-4">
            <div class="bg-white w-full h-[90vh] sm:h-[80vh] sm:max-w-md rounded-t-3xl sm:rounded-3xl p-0 shadow-2xl flex flex-col overflow-hidden relative animate-slide-up">
                
                <!-- AI Header -->
                <div class="bg-gradient-to-r from-blue-600 to-purple-600 p-4 flex justify-between items-center shrink-0">
                    <h3 class="text-white font-bold flex items-center gap-2">
                        <i class="fa-solid fa-wand-magic-sparkles"></i> AI éš¨èº«å°éŠ
                    </h3>
                    <button @click="showAIModal = false" class="text-white/80 hover:text-white bg-white/20 rounded-full w-8 h-8 flex items-center justify-center">
                        <i class="fa-solid fa-xmark"></i>
                    </button>
                </div>

                <!-- Chat Area -->
                <div class="flex-1 overflow-y-auto p-4 space-y-4 bg-gray-50" id="ai-chat-box">
                    <div v-if="aiMessages.length === 0" class="text-center py-8 text-gray-400">
                        <div class="text-4xl mb-2">ğŸ¤–</div>
                        <p class="text-sm">æˆ‘æ˜¯æ‚¨çš„æ›¼è°·æ—…éŠåŠ©æ‰‹<br>å¯ä»¥å•æˆ‘ä»»ä½•å•é¡Œï¼</p>
                        
                        <div class="grid grid-cols-2 gap-2 mt-6 px-4">
                            <button @click="triggerAIAction('translate')" class="p-3 bg-white border border-blue-100 rounded-xl text-xs text-blue-600 font-bold shadow-sm hover:bg-blue-50">
                                ğŸ‡¹ğŸ‡­ å¹«æˆ‘ç¿»è­¯æˆæ³°æ–‡
                            </button>
                            <button @click="triggerAIAction('optimize')" class="p-3 bg-white border border-orange-100 rounded-xl text-xs text-orange-600 font-bold shadow-sm hover:bg-orange-50">
                                ğŸ—ºï¸ å¹«æˆ‘æª¢æŸ¥è¡Œç¨‹
                            </button>
                             <button @click="triggerAIAction('food')" class="p-3 bg-white border border-red-100 rounded-xl text-xs text-red-600 font-bold shadow-sm hover:bg-red-50">
                                ğŸ½ï¸ æ¨è–¦é™„è¿‘ç¾é£Ÿ
                            </button>
                             <button @click="triggerAIAction('weather')" class="p-3 bg-white border border-green-100 rounded-xl text-xs text-green-600 font-bold shadow-sm hover:bg-green-50">
                                ğŸŒ¤ï¸ å¤©æ°£èˆ‡ç©¿è‘—
                            </button>
                        </div>
                    </div>

                    <div v-for="(msg, idx) in aiMessages" :key="idx" class="flex flex-col" :class="msg.role === 'user' ? 'items-end' : 'items-start'">
                         <div class="max-w-[85%] p-3 rounded-2xl text-sm shadow-sm prose prose-sm" 
                              :class="msg.role === 'user' ? 'bg-blue-600 text-white rounded-tr-none' : 'bg-white text-gray-800 rounded-tl-none border border-gray-100'"
                              v-html="renderMarkdown(msg.text)">
                         </div>
                         <span class="text-[10px] text-gray-400 mt-1 px-1">{{ msg.role === 'user' ? 'ä½ ' : 'AI å°éŠ' }}</span>
                    </div>

                    <div v-if="isAILoading" class="flex justify-start">
                        <div class="bg-white p-3 rounded-2xl rounded-tl-none border border-gray-100 shadow-sm">
                            <div class="flex gap-1">
                                <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce"></div>
                                <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0.1s"></div>
                                <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Input Area -->
                <div class="p-3 bg-white border-t border-gray-100 shrink-0">
                    <div class="flex gap-2">
                        <input v-model="aiInput" @keyup.enter="sendMessage" type="text" placeholder="è¼¸å…¥å•é¡Œ..." class="flex-1 bg-gray-100 rounded-xl px-4 py-3 text-sm outline-none focus:ring-2 focus:ring-blue-500">
                        <button @click="sendMessage" :disabled="isAILoading || !aiInput.trim()" class="w-12 bg-blue-600 text-white rounded-xl flex items-center justify-center disabled:opacity-50 disabled:bg-gray-400">
                            <i class="fa-solid fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Settings Modal -->
        <div v-if="showSettings" class="fixed inset-0 bg-black/50 z-50 flex items-end sm:items-center justify-center backdrop-blur-sm p-4">
            <div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl overflow-y-auto max-h-[85vh]">
                <h3 class="text-xl font-bold mb-4">è¨­å®š</h3>
                
                <div v-if="isCloudMode" class="bg-green-50 border border-green-200 rounded-xl p-3 mb-4">
                    <p class="text-xs text-green-700 font-bold mb-1"><i class="fa-solid fa-cloud-check mr-1"></i> å·²é€£ç·šè‡³é›²ç«¯</p>
                    <p class="text-[10px] text-gray-500 mb-1">æ—…ç¨‹ä»£ç¢¼: <span class="font-mono bg-white px-1 border rounded select-all">{{ tripId }}</span></p>
                    <p class="text-[10px] text-gray-400">UID: {{ authUid || 'æœªç™»å…¥' }}</p>
                    <button @click="shareTrip" class="mt-2 w-full py-1.5 bg-blue-50 text-blue-600 rounded-lg text-xs font-bold border border-blue-100"><i class="fa-solid fa-share-nodes"></i> åˆ†äº«ä»£ç¢¼çµ¦æ—…ä¼´</button>
                </div>
                <div v-else class="bg-gray-50 border border-gray-200 rounded-xl p-3 mb-4">
                    <p class="text-xs text-gray-600 font-bold mb-1">ä½¿ç”¨å–®æ©Ÿæ¨¡å¼</p>
                    <p class="text-[10px] text-gray-400">è³‡æ–™åƒ…å­˜åœ¨æ­¤è£ç½®</p>
                </div>

                <div class="mb-4">
                    <label class="block text-xs font-bold text-gray-500 mb-2">æ—…ä¼´ç®¡ç†</label>
                    <div class="flex gap-2 mb-2"><input v-model="newMemberName" placeholder="è¼¸å…¥åå­—" class="flex-1 bg-gray-100 rounded-xl px-4 py-2 outline-none"><button @click="addMember" class="bg-gray-800 text-white px-4 rounded-xl font-bold">+</button></div>
                    <div class="flex flex-wrap gap-2 mt-3"><div v-for="(m, idx) in members" :key="idx" class="bg-gray-100 px-3 py-1 rounded-full text-sm flex items-center gap-2">{{ m }}<button @click="removeMember(idx)" class="text-gray-400 hover:text-red-500">Ã—</button></div></div>
                </div>

                <div class="pt-4 border-t border-gray-100">
                    <button @click="resetAllData" class="w-full py-3 rounded-xl border border-red-200 text-red-500 font-bold mb-2">é‡ç½®è³‡æ–™ (Reset)</button>
                    <button @click="showSettings = false" class="w-full py-3 rounded-xl bg-gray-800 text-white font-bold">å®Œæˆ</button>
                </div>
            </div>
        </div>

        <!-- Settlement Modal -->
        <div v-if="showSettlementModal" class="fixed inset-0 bg-black/50 z-50 flex items-end sm:items-center justify-center backdrop-blur-sm p-4"><div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl max-h-[80vh] overflow-y-auto"><div class="flex justify-between items-center mb-4"><h3 class="text-xl font-bold">çµç®—å»ºè­°</h3><button @click="showSettlementModal = false" class="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center text-gray-500"><i class="fa-solid fa-xmark"></i></button></div><div class="bg-blue-50 p-4 rounded-xl text-sm text-blue-800 mb-4"><p class="font-bold mb-1">ç¸½èŠ±è²»: à¸¿{{ totalExpense }}</p><p>å¹³å‡æ¯äºº: à¸¿{{ (totalExpense / (members.length || 1)).toFixed(1) }}</p></div><div v-if="settlements.length > 0" class="space-y-3"><div v-for="(s, idx) in settlements" :key="idx" class="flex items-center justify-between p-3 border border-gray-100 rounded-xl shadow-sm"><div class="flex items-center gap-2"><span class="font-bold text-red-500">{{ s.from }}</span><i class="fa-solid fa-arrow-right text-gray-300 text-xs"></i><span class="font-bold text-green-500">{{ s.to }}</span></div><span class="font-mono font-bold bg-gray-100 px-2 py-1 rounded">à¸¿{{ Math.round(s.amount) }}</span></div></div><div v-else class="text-center py-6 text-green-600 font-bold"><p>å¸³ç›®å·²å¹³è¡¡ï¼</p></div></div></div>

        <!-- Floating Action Button -->
        <button v-if="hasInitialized && currentTab === 'itinerary'" @click="openItineraryModal()" class="fixed bottom-24 right-5 w-14 h-14 bg-primary text-white rounded-full shadow-lg shadow-orange-200 flex items-center justify-center text-2xl active:scale-90 transition transform z-40"><i class="fa-solid fa-plus"></i></button>
        <button v-if="hasInitialized && currentTab === 'food'" @click="openFoodModal()" class="fixed bottom-24 right-5 w-14 h-14 bg-michelin text-white rounded-full shadow-lg shadow-red-200 flex items-center justify-center text-2xl active:scale-90 transition transform z-40"><i class="fa-solid fa-plus"></i></button>

        <!-- MODALS -->
        <div v-if="showItineraryModal" class="fixed inset-0 bg-black/50 z-50 flex items-end sm:items-center justify-center backdrop-blur-sm p-4"><div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl animate-slide-up"><h3 class="text-xl font-bold mb-4">{{ isEditing ? 'ç·¨è¼¯è¡Œç¨‹' : 'æ–°å¢è¡Œç¨‹' }}</h3><div class="space-y-4"><input v-model="formItinerary.time" type="time" class="w-full bg-gray-100 rounded-xl px-4 py-3"><input v-model="formItinerary.title" type="text" placeholder="æ´»å‹•åç¨±" class="w-full bg-gray-100 rounded-xl px-4 py-3"><input v-model="formItinerary.location" type="text" placeholder="åœ°é»" class="w-full bg-gray-100 rounded-xl px-4 py-3"><input v-model="formItinerary.transport" type="text" placeholder="äº¤é€š" class="w-full bg-gray-100 rounded-xl px-4 py-3"><textarea v-model="formItinerary.desc" rows="3" placeholder="å‚™è¨»/æ³°æ–‡åœ°å€" class="w-full bg-gray-100 rounded-xl px-4 py-3 text-sm"></textarea></div><div class="flex gap-3 mt-6"><button @click="showItineraryModal = false" class="flex-1 py-3 bg-gray-100 rounded-xl font-bold text-gray-600">å–æ¶ˆ</button><button v-if="isEditing" @click="deleteItinerary" class="px-4 py-3 bg-red-50 text-red-500 rounded-xl font-bold"><i class="fa-solid fa-trash"></i></button><button @click="saveItinerary" class="flex-1 py-3 bg-primary text-white rounded-xl font-bold shadow-lg">å„²å­˜</button></div></div></div>
        <div v-if="showFoodModal" class="fixed inset-0 bg-black/50 z-50 flex items-end sm:items-center justify-center backdrop-blur-sm p-4"><div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl animate-slide-up"><h3 class="text-xl font-bold mb-4">æ–°å¢ç¾é£Ÿ</h3><div class="space-y-4 max-h-[60vh] overflow-y-auto no-scrollbar"><input v-model="formFood.name" placeholder="åç¨±" class="w-full bg-gray-100 rounded-xl px-4 py-3"><input v-model="formFood.engName" placeholder="Google Maps è‹±æ–‡å" class="w-full bg-gray-100 rounded-xl px-4 py-3"><select v-model="formFood.category" class="w-full bg-gray-100 rounded-xl px-4 py-3"><option v-for="c in foodCategories" :value="c">{{ c }}</option></select><input v-model="formFood.mustEat" placeholder="å¿…åƒ" class="w-full bg-gray-100 rounded-xl px-4 py-3"></div><div class="flex gap-3 mt-6"><button @click="showFoodModal = false" class="flex-1 py-3 bg-gray-100 rounded-xl font-bold text-gray-600">å–æ¶ˆ</button><button @click="saveFood" class="flex-1 py-3 bg-michelin text-white rounded-xl font-bold shadow-lg">åŠ å…¥</button></div></div></div>
        <div v-if="showExpenseModal" class="fixed inset-0 bg-black/50 z-50 flex items-end sm:items-center justify-center backdrop-blur-sm p-4"><div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl animate-slide-up"><h3 class="text-xl font-bold mb-4">è¨˜ä¸€ç­†</h3><div class="space-y-4"><input v-model="formExpense.title" placeholder="é …ç›®" class="w-full bg-gray-100 rounded-xl px-4 py-3"><input v-model.number="formExpense.amount" type="number" placeholder="é‡‘é¡ (THB)" class="w-full bg-gray-100 rounded-xl px-4 py-3 font-mono text-lg"><div class="flex flex-wrap gap-2"><button v-for="m in members" :key="m" @click="formExpense.payer = m" class="px-4 py-2 rounded-lg text-sm font-bold border transition" :class="formExpense.payer === m ? 'bg-secondary text-white' : 'bg-white text-gray-500'">{{ m }}</button></div></div><div class="flex gap-3 mt-6"><button @click="showExpenseModal = false" class="flex-1 py-3 bg-gray-100 rounded-xl font-bold text-gray-600">å–æ¶ˆ</button><button @click="saveExpense" class="flex-1 py-3 bg-secondary text-white rounded-xl font-bold shadow-lg">æ–°å¢</button></div></div></div>
        <div v-if="showThaiAddrModal" class="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-6 backdrop-blur-sm"><div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl text-center"><div class="w-16 h-16 bg-purple-100 text-purple-600 rounded-full flex items-center justify-center mx-auto mb-4 text-2xl"><i class="fa-solid fa-taxi"></i></div><h3 class="text-lg font-bold text-gray-500 mb-2">è«‹å¸æ©Ÿå»é€™è£¡</h3><h2 class="text-2xl font-bold text-gray-900 mb-6 leading-relaxed select-all">{{ thaiAddrContent }}</h2><button @click="showThaiAddrModal = false" class="w-full py-3 rounded-xl bg-gray-800 text-white font-bold">é—œé–‰</button></div></div>

    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
        import { getFirestore, doc, onSnapshot, setDoc, getDoc, updateDoc, arrayUnion, arrayRemove, collection } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";
        const { createApp, ref, computed, onMounted, watch, nextTick } = Vue;

        createApp({
            setup() {
                // 1. CONSTANTS & REFS
                const currentTab = ref('itinerary');
                const hasInitialized = ref(false);
                const isLoading = ref(false);
                const isCloudMode = ref(false);
                const tripId = ref('');
                const inputTripId = ref('');
                const statusMsg = ref('å°±ç·’');
                const errorMsg = ref(null);
                const errorHelp = ref(null);

                // AI
                const showAIModal = ref(false);
                const aiInput = ref('');
                const aiMessages = ref([]);
                const isAILoading = ref(false);
                const apiKey = ""; // Run-time provided

                const userConfig = {
                    apiKey: "AIzaSyDX9-UT3PvUHth46bJqOQ3F6gtE6-qW7-w",
                    authDomain: "bangkok-trip-app.firebaseapp.com",
                    projectId: "bangkok-trip-app",
                    storageBucket: "bangkok-trip-app.firebasestorage.app",
                    messagingSenderId: "888598636200",
                    appId: "1:888598636200:web:c1a4ecf3b54c119418049d",
                    measurementId: "G-EWMSXN3G1H"
                };

                let tripDocRef = null;
                let unsubscribeSnapshot = null;
                const currentUser = ref(null);
                const authUid = ref('');
                let app, auth, db;

                // Data Defaults
                const defaultItinerary = [
                    { id: 1, date: '12/26 (äº”)', title: 'å•Ÿç¨‹æ›¼è°·', items: [
                        { id: 101, time: '12:05', title: 'æŠµé” BKK æ©Ÿå ´', location: 'Suvarnabhumi Airport', desc: 'é ˜å®Œè¡Œæå¾Œï¼Œå‰å¾€é å®šå¥½çš„å°ˆè»Šæ¥æ©Ÿé»é›†åˆã€‚', transport: 'åŒ…è»Š/æ¥é€' },
                        { id: 102, time: '14:00', title: 'é£¯åº— Check-in & ä¼‘æ¯', location: 'Centre Point Hotel Sukhumvit 10', thaiAddr: '39 à¸‹à¸­à¸¢ à¸ªà¸¸à¸‚à¸¸à¸¡à¸§à¸´à¸— 10 à¹à¸‚à¸§à¸‡à¸„à¸¥à¸­à¸‡à¹€à¸•à¸¢', desc: 'è®“é•·è¼©å°å­©å…ˆä¼‘æ¯ï¼Œæ•´ç†è¡Œæã€‚', tags: ['ä½å®¿'] },
                        { id: 103, time: '15:30', title: 'Chef Ple èŠ’æœç³¯ç±³é£¯', location: 'Chef Ple Thai Mango Sticky Rice', desc: 'åœ¨ Times Square Building æ—ã€‚å¯å¤–å¸¶å›é£¯åº—åƒã€‚', transport: 'æ­¥è¡Œ/TukTuk' },
                        { id: 104, time: '17:30', title: 'EmSphere å•†å ´æ™šé¤', location: 'EmSphere', thaiAddr: '628 à¸–à¸™à¸™à¸ªà¸¸à¸‚à¸¸à¸¡à¸§à¸´à¸— à¹à¸‚à¸§à¸‡à¸„à¸¥à¸­à¸‡à¸•à¸±à¸™ à¹€à¸‚à¸•à¸„à¸¥à¸­à¸‡à¹€à¸•à¸¢', desc: 'é¤å»³ï¼šKub Kao Kub Pla (åƒé£¯åƒé­š)ã€‚ç’°å¢ƒèˆ’é©ï¼Œå£å‘³é©åˆå…¨å®¶ã€‚', transport: 'Grab/åŒ…è»Š', tags: ['æ™šé¤'] }
                    ]},
                    { id: 2, date: '12/27 (å…­)', title: 'æ³°æœç©¿è¶Š', items: [
                        { id: 201, time: '09:30', title: 'é„­ç‹å»Ÿæ³°æœé«”é©—', location: 'Wat Arun', thaiAddr: '158 à¸–à¸™à¸™à¸§à¸±à¸‡à¹€à¸”à¸´à¸¡ à¹à¸‚à¸§à¸‡à¸§à¸±à¸”à¸­à¸£à¸¸à¸“ à¹€à¸‚à¸•à¸šà¸²à¸‡à¸à¸­à¸à¹ƒà¸«à¸à¹ˆ', desc: 'Vision Thai Studio æ›è£ã€‚é•·è¼©èˆ‡å¹¼ç«¥å»ºè­°åœ¨å¹³é¢åº­åœ’æ‹ç…§å³å¯ï¼Œæ³¨æ„å®‰å…¨ã€‚', transport: 'åŒ…è»Š' },
                        { id: 202, time: '12:30', title: 'ICONSIAM åˆé¤', location: 'ICONSIAM', thaiAddr: '299 à¸–à¸™à¸™à¹€à¸ˆà¸£à¸´à¸à¸™à¸„à¸£ à¹à¸‚à¸§à¸‡à¸„à¸¥à¸­à¸‡à¸•à¹‰à¸™à¹„à¸—à¸£ à¹€à¸‚à¸•à¸„à¸¥à¸­à¸‡à¸ªà¸²à¸™', desc: 'å»ºè­°è‡³é«˜æ¨“å±¤é¤å»³ï¼ˆå¦‚ Nara Thai Cuisineï¼‰ã€‚é¤å¾Œå¯é€› SookSiam å®¤å…§æ°´ä¸Šå¸‚å ´ã€‚', transport: 'åŒ…è»Š/Grab' },
                        { id: 203, time: '15:00', title: 'ä¾ç¾…ç´€å±•è¦½', location: 'ICONSIAM Jurassic World', desc: 'åœ¨å†·æ°£æˆ¿å…§é«”é©—æ²‰æµ¸å¼æé¾ä¸–ç•Œï¼Œå°æœ‹å‹çš„æœ€æ„›ã€‚', tags: ['å±•è¦½'] },
                        { id: 204, time: '17:30', title: 'Asiatique æ²³æ¿±å¤œå¸‚æ™šé¤', location: 'Asiatique The Riverfront', thaiAddr: '2194 à¸–à¸™à¸™à¹€à¸ˆà¸£à¸´à¸à¸à¸£à¸¸à¸‡ à¹à¸‚à¸§à¸‡à¸§à¸±à¸”à¸à¸£à¸°à¸¢à¸²à¹„à¸à¸£ à¹€à¸‚à¸•à¸šà¸²à¸‡à¸„à¸­à¹à¸«à¸¥à¸¡', desc: 'æ™šé¤æ¨è–¦ï¼šKo Dang Talay (æµ·é®®å€‰åº«)ã€‚ç’°å¢ƒå¯¬æ•é©åˆå¤§å®¶åº­ã€‚', transport: 'åŒ…è»Š/Grab', tags: ['æ™šé¤'] }
                    ]},
                    { id: 3, date: '12/28 (æ—¥)', title: 'é€±æœ«æ·˜å¯¶', items: [
                        { id: 301, time: '10:00', title: 'æ´½åœ–æ´½å¸‚é›† / Mixt å•†å ´', location: 'Mixt Chatuchak', thaiAddr: '8 Kamphaeng Phet 3 Rd, Chatuchak', desc: 'é•·è¼©å¹¼ç«¥åœ¨ Mixt å•†å ´å¹å†·æ°£ä¼‘æ¯ã€‚æ¡è³¼çµ„å»æˆ¶å¤–å¸‚é›†å°‹å¯¶ã€‚åˆé¤åœ¨å•†å ´å…§è§£æ±ºã€‚', transport: 'åŒ…è»Š/Grab' },
                        { id: 302, time: '15:30', title: 'é£¯åº—æ³³æ±  / è¶³éƒ¨æŒ‰æ‘©', location: 'Centre Point Hotel Sukhumvit 10', desc: 'åˆå¾Œé¿æš‘ã€‚å°æœ‹å‹ç©æ°´ï¼Œå¤§äººåœ¨é™„è¿‘æ‰¾æŒ‰æ‘©åº—æ”¾é¬†ã€‚', transport: 'å›é£¯åº—' },
                        { id: 303, time: '17:30', title: 'é‡£è¦é«”é©—æ™šé¤', location: 'Bor Tok Kung Charoen Nakhon 16', thaiAddr: 'à¸šà¹ˆà¸­à¸•à¸à¸à¸¸à¹‰à¸‡à¹€à¸ˆà¸£à¸´à¸à¸™à¸„à¸£ 16 (Soi Charoen Nakhon 16)', desc: 'é«”é©—åœ¨åœ°å¨›æ¨‚ï¼å»ºè­°å…ˆé»ä¸€äº›ç†±ç‚’ä»¥å…ç­‰å¤ªä¹…é¤“è‚šå­ã€‚', transport: 'åŒ…è»Š/Grab', tags: ['æ™šé¤'] }
                    ]},
                    { id: 4, date: '12/29 (ä¸€)', title: 'é‡ç”Ÿå‹•ç‰©åœ’', items: [
                        { id: 401, time: '08:30', title: 'Safari World é‡ç”Ÿå‹•ç‰©åœ’', location: 'Safari World', thaiAddr: '99 à¸–à¸™à¸™à¸›à¸±à¸à¸à¸²à¸­à¸´à¸™à¸—à¸£à¸² à¹à¸‚à¸§à¸‡à¸ªà¸²à¸¡à¸§à¸²à¸•à¸°à¸§à¸±à¸™à¸•à¸ à¹€à¸‚à¸•à¸„à¸¥à¸­à¸‡à¸ªà¸²à¸¡à¸§à¸²', desc: 'ä¸Šåˆæ­è»ŠéŠé‡ç”Ÿå‹•ç‰©å€ (Safari Park)ï¼Œä¸‹åˆæ­¥è¡Œæµ·æ´‹å…¬åœ’å€ (Marine Park)ã€‚å¿…å»é•·é ¸é¹¿é¤µé£Ÿäº­ã€‚', transport: 'åŒ…è»Š', tags: ['å…¨æ—¥éŠ'] },
                        { id: 402, time: '18:30', title: 'Central World æ™šé¤', location: 'Central World', thaiAddr: '999/9 à¸–à¸™à¸™à¸à¸£à¸°à¸£à¸²à¸¡à¸—à¸µà¹ˆ à¹‘ à¹à¸‚à¸§à¸‡à¸›à¸—à¸¸à¸¡à¸§à¸±à¸™', desc: 'æ™šé¤ï¼šSavoey Seafood (ä¸Šå‘³æ³°é¤é¤¨)ï¼Œ2æ¨“ Groove å€ã€‚æ¨è–¦å’–å“©èƒèŸ¹ã€‚', transport: 'åŒ…è»Šå›å¸‚å€', tags: ['æ™šé¤'] }
                    ]},
                    { id: 5, date: '12/30 (äºŒ)', title: 'ä¼´æ‰‹ç¦®', items: [
                        { id: 501, time: '11:00', title: 'Big C æ¡è²·ä¼´æ‰‹ç¦®', location: 'Big C Supercenter Rajdamri', thaiAddr: '97/11 à¸–à¸™à¸™à¸£à¸²à¸Šà¸”à¸³à¸£à¸´ à¹à¸‚à¸§à¸‡à¸¥à¸¸à¸¡à¸à¸´à¸™à¸µ à¹€à¸‚à¸•à¸›à¸—à¸¸à¸¡à¸§à¸±à¸™', desc: 'å°±åœ¨ Central World å°é¢ã€‚è²·å®Œå¯å¯„æ”¾æˆ–è«‹å¸æ©Ÿè¼‰å›ã€‚', transport: 'åŒ…è»Š/Grab' },
                        { id: 502, time: '13:00', title: 'åˆé¤ï¼šThong Smith èˆ¹éºµ', location: 'Central World', desc: 'ä½æ–¼ 3 æ¨“ Beacon å€ã€‚é«˜ç´šèˆ¹éºµï¼Œè¾£åº¦å¯èª¿æ•´ã€‚', tags: ['åˆé¤'] },
                        { id: 503, time: '14:30', title: 'Sea Life æ°´æ—é¤¨ / ä¸‹åˆèŒ¶', location: 'Siam Paragon', thaiAddr: '991 à¸–à¸™à¸™à¸à¸£à¸°à¸£à¸²à¸¡à¸—à¸µà¹ˆ 1 à¹à¸‚à¸§à¸‡à¸›à¸—à¸¸à¸¡à¸§à¸±à¸™', desc: 'è¦ªå­çµ„ï¼šå» B1-B2 æ°´æ—é¤¨ã€‚ä¼‘é–’çµ„ï¼šåœ¨ç™¾è²¨å–ä¸‹åˆèŒ¶ã€‚å¾ Central World èµ° Skywalk éä¾†ã€‚', transport: 'æ­¥è¡Œ Skywalk' },
                        { id: 504, time: '18:00', title: 'å–¬å¾·å¤œå¸‚æ™šé¤', location: 'Jodd Fairs Rama 9', thaiAddr: 'à¸–à¸™à¸™à¸à¸£à¸°à¸£à¸²à¸¡ 9 à¹à¸‚à¸§à¸‡à¸«à¹‰à¸§à¸¢à¸‚à¸§à¸²à¸‡', desc: 'æ™šé¤åƒç«å±±æ’éª¨ã€‚é•·è¼©è‹¥æ€•ç†±å¯å»æ—é‚Š Central Rama 9 å•†å ´ä¼‘æ¯ã€‚', transport: 'Grab/åŒ…è»Š', tags: ['æ™šé¤'] }
                    ]},
                    { id: 6, date: '12/31 (ä¸‰)', title: 'å›ç¨‹', items: [
                        { id: 601, time: '09:30', title: 'æ‚ é–’æ—©é¤ & æ”¶æ‹¾', location: 'Centre Point Hotel Sukhumvit 10', desc: 'äº«å—æœ€å¾Œçš„é£¯åº—æ™‚å…‰ã€‚' },
                        { id: 602, time: '11:00', title: 'å‰å¾€æ©Ÿå ´ (BKK)', location: 'Suvarnabhumi Airport', desc: 'æ­ä¹˜å°ˆè»Šé€æ©Ÿã€‚è»Šç¨‹ç´„ 45-60 åˆ†é˜ã€‚', transport: 'åŒ…è»Šé€æ©Ÿ' },
                        { id: 603, time: '13:45', title: 'èˆªç­èµ·é£› (EK384)', location: 'Suvarnabhumi Airport', desc: '13:45 BKK -> 17:40 HKG', tags: ['é£›æ©Ÿ'] }
                    ]}
                ];
                
                const defaultMichelin = [
                    { name: "Jay Fai (ç—£å§)", engName: "Raan Jay Fai", area: "èˆŠåŸå€ (Old Town)", category: "Old Town", level: "1 Star", type: "è¡—é ­ç†±ç‚’", mustEat: "é»ƒé‡‘èŸ¹è‚‰è›‹æ² (Crab Omelette), é†‰æ¼¢éºµ", price: "à¸¿à¸¿à¸¿à¸¿", note: "åƒ¹æ ¼æ˜‚è²´ï¼Œéœ€æ’éšŠæ•¸å°æ™‚æˆ–é ç´„ã€‚å”¯ä¸€ç±³èŠè“®æ˜Ÿç´šè·¯é‚Šæ”¤ã€‚" },
                    { name: "Thipsamai (é¬¼é–€æ³°å¼ç‚’éºµ)", engName: "Thipsamai Pad Thai Pratoopee", area: "èˆŠåŸå€ (Old Town)", category: "Old Town", level: "Bib", type: "ç‚’æ²³ç²‰", mustEat: "è›‹åŒ…æ³°å¼ç‚’æ²³ (Superb Pad Thai)", price: "à¸¿à¸¿", note: "å°±åœ¨ Jay Fai æ—é‚Šï¼Œæ’éšŠäººæ½®å¤šä½†æµå‹•å¿«ã€‚æ©˜å­æ±å¿…é»ï¼" },
                    { name: "Nai Mong Hoi Thod (å…§è’™è ”ç…)", engName: "Nai Mong Hoi Thod", area: "å”äººè¡— (Chinatown)", category: "Old Town", level: "Bib", type: "èšµä»”ç…", mustEat: "è„†çš®èšµä»”ç… (Crispy Oyster Omelette)", price: "à¸¿à¸¿", note: "ä½æ–¼å”äººè¡—é‚Šç·£ï¼Œå£æ„Ÿæ¥µåº¦é…¥è„†ã€‚" },
                    { name: "Lim Lao Ngow (æ—è€äº”é­šä¸¸)", engName: "Lim Lao Ngow Fishball Noodle", area: "å”äººè¡— (Chinatown)", category: "Old Town", level: "Bib", type: "é­šä¸¸éºµ", mustEat: "ä¹¾æ‹Œé­šä¸¸éºµ", price: "à¸¿", note: "ç™¾å¹´è€åº—ï¼Œé­šä¸¸Qå½ˆç„¡ç²‰æ„Ÿã€‚æ™šä¸Šæ‰é–‹ã€‚" },
                    { name: "Rung Rueang (æ¦®æ³°ç±³ç²‰æ¹¯)", engName: "Rung Rueang Pork Noodle", area: "Sukhumvit (Phrom Phong)", category: "Sukhumvit", level: "Bib", type: "è±¬è‚‰éºµ", mustEat: "é…¸è¾£è±¬è‚‰ç±³ç²‰æ¹¯ (Tom Yum Pork Noodles)", price: "à¸¿", note: "ä½æ–¼ Soi 26ï¼Œæœ‰å…©é–“åº—é¢ç›¸é„°ï¼Œéƒ½æ˜¯è¦ªæˆšé–‹çš„ï¼Œå‘³é“å·®ä¸å¤šã€‚" },
                    { name: "Here Hai (æµ·æµ·)", engName: "Here Hai Restaurant", area: "Sukhumvit (Ekkamai)", category: "Sukhumvit", level: "Bib", type: "æµ·é®®ç†±ç‚’", mustEat: "èŸ¹è‚‰ç‚’é£¯ (Insane Crab Fried Rice)", price: "à¸¿à¸¿à¸¿", note: "èŸ¹è‚‰ä»½é‡é©šäººï¼Œå»ºè­°è¨‚ä½ã€‚" },
                    { name: "Wattana Panich (éƒ­ç‚æ¾)", engName: "Wattana Panich", area: "Sukhumvit (Ekkamai)", category: "Sukhumvit", level: "Bib", type: "ç‰›è‚‰éºµ", mustEat: "ç‡‰ç‰›è‚‰ç²¿æ¢", price: "à¸¿à¸¿", note: "é–€å£é‚£é‹ç…®äº†å¹¾åå¹´çš„é™³å¹´è€æ¹¯æ˜¯æ‹›ç‰Œã€‚" },
                    { name: "Go-Ang (ç´…å¤§å“¥æ°´é–€é›é£¯)", engName: "Go-Ang Kaomunkai Pratunam", area: "Pratunam (æ°´é–€)", category: "Siam", level: "Bib", type: "æµ·å—é›é£¯", mustEat: "é›æ²¹é£¯, ç‡‰é›æ¹¯", price: "à¸¿", note: "åº—å“¡ç©¿ç²‰ç´…è‰²åˆ¶æœã€‚å°±åœ¨ Central World é™„è¿‘ã€‚" },
                    { name: "Jeh O Chula (é›…æ­)", engName: "Jeh O Chula", area: "Siam (Chula)", category: "Siam", level: "Bib", type: "å®µå¤œç†±ç‚’", mustEat: "å†¬è”­åŠŸåª½åª½éºµé‹ (Tom Yum Mama)", price: "à¸¿à¸¿", note: "æ·±å¤œæ’éšŠååº—ï¼Œåª½åª½éºµæ™šä¸Š11é»å¾Œæ‰ä¾›æ‡‰ã€‚" },
                    { name: "Jok Prince (ç‹å­æˆ²é™¢è±¬è‚‰ç²¥)", engName: "Jok Prince", area: "Bang Rak (Silom)", category: "Silom", level: "Bib", type: "å»£å¼ç²¥å“", mustEat: "è±¬è‚‰è›‹ç²¥ (Pork Congee with Egg)", price: "à¸¿", note: "å¸¶æœ‰ç„¦é¦™å‘³çš„ç¨ç‰¹ç²¥å“ï¼Œå°±åœ¨ Robinson Bangrak å°é¢ã€‚" },
                    { name: "Baan Somtum (Sathorn)", engName: "Baan Somtum Sathorn", area: "Sathorn", category: "Silom", level: "Bib", type: "æ³°åŒ—èœ", mustEat: "é’æœ¨ç“œæ²™æ‹‰, ç‚¸é›ç¿…", price: "à¸¿à¸¿", note: "ç’°å¢ƒèˆ’é©ï¼Œå†·æ°£å¼·ï¼Œé©åˆå®¶åº­èšé¤ã€‚" }
                ];

                // Data Refs
                const tripDays = ref(defaultItinerary);
                const expenses = ref([]);
                const members = ref(['æˆ‘', 'å®¶äººA']);
                const customFoodSpots = ref([]);
                const activeDayIndex = ref(0);

                // UI Refs
                const showItineraryModal = ref(false);
                const showFoodModal = ref(false);
                const showExpenseModal = ref(false);
                const showSettlementModal = ref(false);
                const showSettings = ref(false);
                const showThaiAddrModal = ref(false);
                const thaiAddrContent = ref('');
                const isEditing = ref(false);
                const editingId = ref(null);
                
                const formItinerary = ref({});
                const formFood = ref({});
                const formExpense = ref({});

                const activeFoodCategory = ref('å…¨å€');
                const foodCategories = ref(['å…¨å€', 'Siam', 'Sukhumvit', 'Old Town', 'Silom']);
                const newMemberName = ref('');
                
                const calcTHB = ref(''); 
                const calcHKD = ref(''); 
                const currentRate = ref(4.4);

                // 2. COMPUTED PROPERTIES
                const foodSpots = computed(() => [...customFoodSpots.value, ...defaultMichelin]);
                const filteredFoodSpots = computed(() => activeFoodCategory.value === 'å…¨å€' ? foodSpots.value : foodSpots.value.filter(s => s.category === activeFoodCategory.value));
                const totalExpense = computed(() => expenses.value.reduce((sum, i) => sum + i.amount, 0));
                
                const currentDayItems = computed(() => tripDays.value[activeDayIndex.value]?.items || []);

                const settlements = computed(() => {
                    if (members.value.length === 0 || expenses.value.length === 0) return [];
                    const balances = {}; members.value.forEach(m => balances[m] = 0);
                    const split = totalExpense.value / (members.value.length || 1);
                    expenses.value.forEach(e => { if(balances[e.payer]!==undefined) balances[e.payer]+=e.amount; });
                    let debtors=[], creditors=[];
                    for(const m in balances) { const net=balances[m]-split; if(net<-0.1) debtors.push({name:m, amt:Math.abs(net)}); else if(net>0.1) creditors.push({name:m, amt:net}); }
                    const res = []; let i=0,j=0;
                    while(i<debtors.length && j<creditors.length) {
                        const amt = Math.min(debtors[i].amt, creditors[j].amt);
                        if(amt>0) res.push({from:debtors[i].name, to:creditors[j].name, amount:amt});
                        debtors[i].amt-=amt; creditors[j].amt-=amt;
                        if(debtors[i].amt<0.1) i++; if(creditors[j].amt<0.1) j++;
                    }
                    return res;
                });
                
                const getPaidAmount = (p) => expenses.value.filter(e=>e.payer===p).reduce((s,e)=>s+e.amount,0);

                // 3. HELPER & LOGIC
                function getTripDocRef(id) {
                    return doc(db, 'trips', id);
                }

                function sanitize(obj) {
                    return JSON.parse(JSON.stringify(obj, (key, value) => {
                        return value === undefined ? null : value;
                    }));
                }
                
                function renderMarkdown(text) {
                    return marked.parse(text || '');
                }

                // GEMINI AI LOGIC
                async function callGeminiAPI(prompt) {
                    const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                    });
                    
                    if (!response.ok) throw new Error(`Gemini Error: ${response.statusText}`);
                    const data = await response.json();
                    return data.candidates?.[0]?.content?.parts?.[0]?.text || 'æŠ±æ­‰ï¼Œæˆ‘ç¾åœ¨ç„¡æ³•å›ç­”ã€‚';
                }
                
                async function sendMessage() {
                    if (!aiInput.value.trim()) return;
                    const userText = aiInput.value;
                    aiInput.value = '';
                    
                    aiMessages.value.push({ role: 'user', text: userText });
                    isAILoading.value = true;
                    
                    // Scroll to bottom
                    nextTick(() => {
                        const chatBox = document.getElementById('ai-chat-box');
                        if (chatBox) chatBox.scrollTop = chatBox.scrollHeight;
                    });

                    try {
                        // Contextual Prompt
                        const itineraryContext = JSON.stringify(tripDays.value.map(d => ({ date: d.date, activities: d.items.map(i => i.title) })));
                        const prompt = `ä½ æ˜¯ä¸€å€‹å°ˆæ¥­çš„æ›¼è°·è¦ªå­æ—…éŠå°éŠã€‚ä½¿ç”¨ç¹é«”ä¸­æ–‡å›ç­”ã€‚
                        
                        ä½¿ç”¨è€…çš„ç•¶å‰è¡Œç¨‹ï¼š
                        ${itineraryContext}
                        
                        ä½¿ç”¨è€…çš„å•é¡Œï¼š${userText}
                        
                        è«‹æä¾›ç°¡çŸ­ã€å¯¦ç”¨ä¸”é©åˆå®¶åº­çš„å»ºè­°ã€‚å¦‚æœæ˜¯æ³°æ–‡ç¿»è­¯éœ€æ±‚ï¼Œè«‹æä¾›æ³°æ–‡åŸæ–‡å’Œç™¼éŸ³ã€‚`;
                        
                        const responseText = await callGeminiAPI(prompt);
                        aiMessages.value.push({ role: 'model', text: responseText });
                    } catch (e) {
                        aiMessages.value.push({ role: 'model', text: "âš ï¸ é€£ç·šéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚" });
                        console.error(e);
                    } finally {
                        isAILoading.value = false;
                        nextTick(() => {
                            const chatBox = document.getElementById('ai-chat-box');
                            if (chatBox) chatBox.scrollTop = chatBox.scrollHeight;
                        });
                    }
                }
                
                function triggerAIAction(type) {
                    if (type === 'translate') aiInput.value = 'è«‹æ•™æˆ‘å¹¾å¥åœ¨æ›¼è°·æ­è¨ˆç¨‹è»Šå’Œé»é¤å¸¸ç”¨çš„æ³°æ–‡ï¼Œé™„ä¸Šç™¼éŸ³ã€‚';
                    if (type === 'optimize') aiInput.value = 'è«‹å¹«æˆ‘æª¢æŸ¥ç›®å‰çš„è¡Œç¨‹ï¼Œçœ‹çœ‹æœ‰æ²’æœ‰è·¯ç·šä¸é †è·¯çš„åœ°æ–¹ï¼Œæˆ–è€…æ¨è–¦é™„è¿‘é©åˆå°å­©çš„éš±è—æ™¯é»ã€‚';
                    if (type === 'food') aiInput.value = 'æ ¹æ“šæˆ‘çš„è¡Œç¨‹ä½ç½®ï¼Œæ¨è–¦å¹¾å®¶é©åˆå¸¶é•·è¼©å°å­©å»çš„å¿…åƒé¤å»³ï¼Œä¸è¦å¤ªè¾£ã€‚';
                    if (type === 'weather') aiInput.value = '12æœˆåº•å»æ›¼è°·å¤©æ°£å¦‚ä½•ï¼Ÿéœ€è¦å¸¶ä»€éº¼è¡£æœï¼Ÿ';
                    sendMessage();
                }

                function initOffline() {
                    isCloudMode.value = false;
                    localStorage.setItem('appMode', 'offline');
                    loadFromLocalStorage();
                    hasInitialized.value = true;
                    statusMsg.value = "å–®æ©Ÿæ¨¡å¼";
                    isLoading.value = false;
                }

                function loadFromLocalStorage() {
                    const localTrips = localStorage.getItem('tripDays_v2');
                    if (localTrips) tripDays.value = JSON.parse(localTrips);
                    const localExp = localStorage.getItem('expenses');
                    if (localExp) expenses.value = JSON.parse(localExp);
                    const localMem = localStorage.getItem('members');
                    if (localMem) members.value = JSON.parse(localMem);
                    const localFood = localStorage.getItem('customFoodSpots');
                    if (localFood) customFoodSpots.value = JSON.parse(localFood);
                }

                function startApp() {
                    const newId = inputTripId.value || 'MY_TRIP';
                    tripId.value = newId;
                    initOffline();
                }

                async function connectToTrip(id, isNew) {
                    if (!db) { initOffline(); return; }
                    
                    isLoading.value = true;
                    tripId.value = id;
                    tripDocRef = doc(db, 'trips', id);

                    try {
                        if (isNew) {
                            await setDoc(tripDocRef, {
                                tripDays: defaultItinerary,
                                expenses: [],
                                members: ['æˆ‘'],
                                customFoodSpots: []
                            }, { merge: true });
                        }

                        if (unsubscribeSnapshot) unsubscribeSnapshot();

                        unsubscribeSnapshot = onSnapshot(tripDocRef, (docSnap) => {
                            if (docSnap.exists()) {
                                const data = docSnap.data();
                                if (!data.expenses && expenses.value.length > 0) return;
                                
                                if (data.tripDays) tripDays.value = data.tripDays;
                                if (data.expenses) expenses.value = data.expenses;
                                if (data.members) members.value = data.members;
                                if (data.customFoodSpots) customFoodSpots.value = data.customFoodSpots;
                                statusMsg.value = "åŒæ­¥å®Œæˆ";
                            }
                            isLoading.value = false;
                            hasInitialized.value = true;
                            isCloudMode.value = true;
                            localStorage.setItem('appMode', 'cloud');
                            localStorage.setItem('tripId', id);
                        }, (error) => {
                             console.error("Snapshot error:", error);
                             if (error.code === 'permission-denied') {
                                 errorMsg.value = "æ¬Šé™è¢«æ‹’ï¼šè«‹åˆ° Firebase Console é–‹å•Ÿ Database Rulesã€‚";
                                 errorHelp.value = "æ”¹ç‚º: allow read, write: if true;";
                             }
                             isLoading.value = false;
                             statusMsg.value = "è®€å–å¤±æ•—";
                             initOffline();
                        });

                    } catch (e) {
                        console.error(e);
                        isLoading.value = false;
                        statusMsg.value = "é€£ç·šéŒ¯èª¤";
                        initOffline();
                    }
                }

                async function joinCloudTrip(id = null) {
                    if (!db) {
                        await initializeFirebase();
                        if (!db) return alert("ç„¡æ³•é€£ç·šè‡³ Firebaseï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ–è¨­å®šã€‚");
                    }
                    
                    const targetId = id || inputTripId.value.toUpperCase();
                    if(!targetId) return alert("è«‹è¼¸å…¥ä»£ç¢¼");
                    await connectToTrip(targetId, false);
                }

                async function syncToCloud() {
                    localStorage.setItem('tripDays_v2', JSON.stringify(tripDays.value));
                    localStorage.setItem('expenses', JSON.stringify(expenses.value));
                    localStorage.setItem('members', JSON.stringify(members.value));
                    localStorage.setItem('customFoodSpots', JSON.stringify(customFoodSpots.value));
                    statusMsg.value = "å·²å­˜æœ¬æ©Ÿ";

                    if (isCloudMode.value && tripDocRef) {
                        statusMsg.value = "åŒæ­¥ä¸­...";
                        const dataToSave = sanitize({
                            tripDays: tripDays.value,
                            expenses: expenses.value,
                            members: members.value,
                            customFoodSpots: customFoodSpots.value
                        });
                        
                        try {
                            await setDoc(tripDocRef, dataToSave, { merge: true });
                            statusMsg.value = "åŒæ­¥å®Œæˆ";
                            errorMsg.value = null;
                        } catch (e) {
                            console.error("Cloud save error", e);
                            if (e.code === 'permission-denied') {
                                 errorMsg.value = "ç„¡æ³•å¯«å…¥ï¼šè«‹åˆ° Firebase Console é–‹å•Ÿ Database Rulesã€‚";
                                 errorHelp.value = "æ”¹ç‚º: allow read, write: if true;";
                            }
                            statusMsg.value = "ä¸Šå‚³å¤±æ•—";
                        }
                    }
                }

                async function initializeFirebase() {
                    if (db) return; 
                    try {
                        app = initializeApp(userConfig);
                        auth = getAuth(app);
                        db = getFirestore(app);

                        onAuthStateChanged(auth, async (user) => {
                            currentUser.value = user;
                            authUid.value = user ? user.uid : '';
                            if (user) {
                                const savedTripId = localStorage.getItem('tripId');
                                if (savedTripId) await connectToTrip(savedTripId, false);
                            }
                        });

                        await signInAnonymously(auth);
                    } catch (e) {
                        console.error("Firebase Init Error:", e);
                        if (e.code === 'auth/operation-not-allowed') {
                             errorMsg.value = "é©—è­‰æœªé–‹å•Ÿï¼šè«‹åˆ° Firebase Console -> Authentication é–‹å•Ÿ Anonymous ç™»å…¥ã€‚";
                        }
                    }
                }

                function addDay() { tripDays.value.push({id: Date.now(), date: `Day ${tripDays.value.length+1}`, items:[]}); activeDayIndex.value = tripDays.value.length-1; }
                function openItineraryModal() { isEditing.value = false; formItinerary.value = {time:'10:00', title:'', location:'', transport:'', desc:''}; showItineraryModal.value = true; }
                function saveItinerary() {
                    if(!formItinerary.value.title) return;
                    if(isEditing.value) {
                        const day = tripDays.value[activeDayIndex.value];
                        const idx = day.items.findIndex(i => i.id === editingId.value);
                        if(idx!==-1) day.items[idx] = {...formItinerary.value, id: editingId.value};
                    } else {
                        tripDays.value[activeDayIndex.value].items.push({id: Date.now(), ...formItinerary.value});
                    }
                    showItineraryModal.value = false;
                }
                function editItem(item) { isEditing.value = true; editingId.value = item.id; formItinerary.value = {...item}; showItineraryModal.value = true; }
                function deleteItinerary() { const day = tripDays.value[activeDayIndex.value]; day.items = day.items.filter(i => i.id !== editingId.value); showItineraryModal.value = false; }
                
                // --- MAP LINK FIX ---
                function openMap(loc) {
                    // For maximum compatibility on mobile devices
                    const query = encodeURIComponent(loc + ', Bangkok');
                    const url = `https://www.google.com/maps/search/?api=1&query=${query}`;
                    
                    // Create a temporary anchor element to force new tab behavior which usually triggers app intent
                    const a = document.createElement('a');
                    a.href = url;
                    a.target = '_blank';
                    a.rel = 'noopener noreferrer';
                    document.body.appendChild(a); // Append to body to ensure it's part of the DOM
                    a.click();
                    document.body.removeChild(a); // Clean up
                }

                function openFoodModal() { formFood.value = {name: '', engName: '', category: 'Siam', mustEat: '', price:'à¸¿'}; showFoodModal.value = true; }
                function saveFood() { 
                    const newFood = { id: Date.now(), isCustom:true, name: formFood.value.name || 'é¤å»³', engName: formFood.value.engName||'', category: formFood.value.category||'Siam', mustEat: formFood.value.mustEat||'', price: formFood.value.price||'à¸¿' };
                    customFoodSpots.value.unshift(newFood); showFoodModal.value = false; 
                }
                function deleteCustomFood(id) { if(confirm('åˆªé™¤?')) customFoodSpots.value = customFoodSpots.value.filter(f=>f.id!==id); }
                function openExpenseModal() { formExpense.value = {title: '', amount: '', payer: members.value[0]}; showExpenseModal.value = true; }
                function saveExpense() { 
                    if (!formExpense.value.amount) return alert("è«‹è¼¸å…¥é‡‘é¡");
                    const newExpense = { id: Date.now(), title: formExpense.value.title || 'æ¶ˆè²»', amount: Number(formExpense.value.amount), payer: formExpense.value.payer || members.value[0] };
                    expenses.value.unshift(newExpense); showExpenseModal.value = false; 
                }
                function deleteExpense(id) { if(confirm('åˆªé™¤?')) expenses.value = expenses.value.filter(e=>e.id!==id); }
                function addMember() { if(newMemberName.value && !members.value.includes(newMemberName.value)) { members.value.push(newMemberName.value); newMemberName.value=''; } }
                function removeMember(idx) { members.value.splice(idx,1); }
                function resetAllData() { if(confirm('é‡ç½®?')) { localStorage.clear(); location.reload(); } }
                function showThaiAddress(item) { thaiAddrContent.value = item.thaiAddr; showThaiAddrModal.value = true; }
                function updateFromTHB() { calcHKD.value = calcTHB.value ? (calcTHB.value/currentRate.value).toFixed(2) : ''; }
                function updateFromHKD() { calcTHB.value = calcHKD.value ? (calcHKD.value*currentRate.value).toFixed(0) : ''; }

                function shareTrip() {
                    const text = `å¿«ä¾†åŠ å…¥æˆ‘çš„æ›¼è°·æ—…ç¨‹ï¼\næ—…ç¨‹ä»£ç¢¼: ${tripId.value}`;
                    if (navigator.share) {
                        navigator.share({ title: 'Sawadee Bangkok', text: text });
                    } else {
                        prompt("è«‹è¤‡è£½ä»£ç¢¼åˆ†äº«çµ¦æ—…ä¼´ï¼š", tripId.value);
                    }
                }

                onMounted(() => {
                    initializeFirebase();
                    const localTripId = localStorage.getItem('tripId');
                    if (localTripId) {
                        tripId.value = localTripId;
                        loadFromLocalStorage();
                        hasInitialized.value = true;
                    }
                });

                watch([tripDays, expenses, members, customFoodSpots], syncToCloud, { deep: true });

                return {
                    currentTab, hasInitialized, isLoading, isCloudMode, tripId, inputTripId, authUid,
                    tripDays, activeDayIndex, currentDayItems, expenses, totalExpense, members, settlements, getPaidAmount,
                    customFoodSpots, foodSpots, filteredFoodSpots, activeFoodCategory, foodCategories,
                    showItineraryModal, showFoodModal, showExpenseModal, showSettlementModal, showSettings, showThaiAddrModal,
                    formItinerary, formFood, formExpense, isEditing, thaiAddrContent, newMemberName,
                    calcTHB, calcHKD, currentRate, statusMsg, errorMsg, errorHelp,
                    
                    // AI
                    showAIModal, aiInput, aiMessages, isAILoading, sendMessage, triggerAIAction, renderMarkdown,

                    initOffline, joinCloudTrip, startApp, addDay, openItineraryModal, saveItinerary, editItem, deleteItinerary,
                    openFoodModal, saveFood, deleteCustomFood, openExpenseModal, saveExpense, deleteExpense,
                    addMember, removeMember, resetAllData, showThaiAddress, updateFromTHB, updateFromHKD, shareTrip, openMap
                };
            }
        }).mount('#app');
    </script>
    <style>
        @keyframes slide-up { from { transform: translateY(100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .animate-slide-up { animation: slide-up 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
    </style>
</body>
</html>


