<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>曼谷 6 天 5 夜親子尊享之旅</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Vue 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <!-- FontAwesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* 核心修復：使用 dvh 單位適配移動端瀏覽器高度 */
        body, #app {
            height: 100vh; /* Fallback */
            height: 100dvh; /* Dynamic Viewport Height for Mobile */
        }

        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #F3F4F6;
            -webkit-tap-highlight-color: transparent;
            overscroll-behavior-y: none;
        }
        /* 隱藏 Scrollbar 但保持功能 */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        /* 模擬 iOS 彈性滾動 */
        .scrolling-touch {
            -webkit-overflow-scrolling: touch;
        }
        .pb-safe {
            padding-bottom: env(safe-area-inset-bottom);
        }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#FF8C00', // 泰國橘
                        secondary: '#4B0082', // 皇室紫
                        bg: '#F3F4F6',
                        michelin: '#BD2333' // 米芝蓮紅
                    }
                }
            }
        }
    </script>
</head>
<body class="overflow-hidden text-gray-800">

    <div id="app" class="flex flex-col relative max-w-md mx-auto bg-white shadow-2xl">
        
        <!-- Hero Image (Custom Banner) -->
        <!-- 修改說明：移除高度限制 (h-48)，改為 h-auto 讓圖片完整顯示，移除遮罩與文字覆蓋 -->
        <div class="relative w-full shrink-0 bg-white">
            <img src="./banner.jpg" alt="Bangkok Trip Banner" class="w-full h-auto object-cover block" onerror="this.src='https://images.unsplash.com/photo-1552465011-b4e21bf6e79a?q=80&w=800&auto=format&fit=crop'">
            
            <!-- 設定按鈕 (改為深色圖標+淺色背景，確保在卡通圖上可見) -->
            <button @click="showSettings = true" class="absolute top-4 right-4 text-gray-700 bg-white/90 hover:bg-white transition z-20 p-2 rounded-full shadow-md backdrop-blur-sm">
                <i class="fa-solid fa-gear text-lg"></i>
            </button>
        </div>

        <!-- Main Content Area -->
        <main class="flex-1 overflow-y-auto no-scrollbar scrolling-touch bg-gray-50 p-4 pb-24 relative w-full">
            
            <!-- VIEW: ITINERARY (行程) -->
            <div v-if="currentTab === 'itinerary'" class="space-y-4">
                
                <!-- Day Selector -->
                <div class="flex space-x-3 overflow-x-auto no-scrollbar pb-2">
                    <button 
                        v-for="(day, index) in tripDays" 
                        :key="index"
                        @click="activeDayIndex = index"
                        class="flex-shrink-0 px-4 py-2 rounded-full text-sm font-bold transition-all transform active:scale-95 shadow-sm flex flex-col items-center min-w-[80px]"
                        :class="activeDayIndex === index ? 'bg-primary text-white shadow-md' : 'bg-white text-gray-500 border border-gray-100'"
                    >
                        <span>Day {{ index + 1 }}</span>
                        <span class="text-[10px] font-normal opacity-80">{{ day.date }}</span>
                    </button>
                    <button @click="addDay" class="flex-shrink-0 px-3 py-2 rounded-full text-sm bg-gray-200 text-gray-600">
                        <i class="fa-solid fa-plus"></i>
                    </button>
                </div>

                <!-- Day Title & Summary -->
                <div class="bg-orange-50 p-4 rounded-xl border border-orange-100 mb-2">
                    <h2 class="font-bold text-lg text-gray-800">{{ tripDays[activeDayIndex].title || '自由活動' }}</h2>
                    <p class="text-xs text-gray-500 mt-1" v-if="tripDays[activeDayIndex].note">
                        <i class="fa-solid fa-circle-info mr-1 text-primary"></i>
                        {{ tripDays[activeDayIndex].note }}
                    </p>
                </div>

                <!-- Timeline List -->
                <div class="relative pl-4 space-y-6 mt-4">
                    <!-- Vertical Line -->
                    <div class="absolute left-4 top-2 bottom-2 w-0.5 bg-gray-200"></div>

                    <!-- Items -->
                    <div v-for="item in currentDayItems" :key="item.id" class="relative pl-6 group">
                        <!-- Dot -->
                        <div class="absolute left-[11px] top-1.5 w-3 h-3 bg-white border-2 border-primary rounded-full z-10 group-hover:bg-primary transition-colors"></div>
                        
                        <!-- Card -->
                        <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 active:scale-[0.99] transition-transform">
                            <div class="flex justify-between items-start mb-2">
                                <div class="font-bold text-primary text-lg">{{ item.time }}</div>
                                <div class="flex space-x-1">
                                    <button v-if="item.thaiAddr" @click="showThaiAddress(item)" class="w-8 h-8 rounded-full bg-purple-50 text-purple-600 flex items-center justify-center hover:bg-purple-100" title="顯示泰文地址給司機看">
                                        <i class="fa-solid fa-language text-sm"></i>
                                    </button>
                                    <button @click="openMap(item.location)" class="w-8 h-8 rounded-full bg-blue-50 text-blue-500 flex items-center justify-center hover:bg-blue-100">
                                        <i class="fa-solid fa-location-arrow text-sm"></i>
                                    </button>
                                    <button @click="editItem(item)" class="w-8 h-8 rounded-full bg-gray-50 text-gray-400 flex items-center justify-center hover:text-gray-600">
                                        <i class="fa-solid fa-pen text-xs"></i>
                                    </button>
                                </div>
                            </div>
                            <h3 class="font-bold text-gray-800 text-lg leading-tight mb-1">{{ item.title }}</h3>
                            
                            <div class="flex items-center text-gray-500 text-sm mb-2">
                                <i class="fa-solid fa-map-pin mr-1.5 text-xs text-gray-400 w-4 text-center"></i>
                                <span class="truncate">{{ item.location }}</span>
                            </div>

                            <div class="flex flex-wrap gap-2 mt-2">
                                <span v-if="item.transport" class="inline-flex items-center px-2 py-1 rounded-md text-xs font-medium bg-gray-100 text-gray-600">
                                    <i class="fa-solid fa-van-shuttle mr-1"></i> {{ item.transport }}
                                </span>
                                <span v-if="item.tags" v-for="tag in item.tags" :key="tag" class="inline-flex items-center px-2 py-1 rounded-md text-xs font-medium bg-orange-50 text-orange-600">
                                    {{ tag }}
                                </span>
                            </div>

                            <p v-if="item.desc" class="text-sm text-gray-500 mt-3 border-t pt-2 border-gray-50 leading-relaxed">
                                {{ item.desc }}
                            </p>
                        </div>
                    </div>

                    <!-- Empty State -->
                    <div v-if="currentDayItems.length === 0" class="text-center py-10 text-gray-400">
                        <i class="fa-regular fa-calendar-xmark text-4xl mb-3 opacity-30"></i>
                        <p>這天還沒有行程<br>點擊下方按鈕新增</p>
                    </div>
                </div>
            </div>

            <!-- VIEW: FOOD GUIDE (美食指南) -->
            <div v-if="currentTab === 'food'" class="space-y-4">
                
                <!-- Food Category Selector -->
                <div class="flex space-x-2 overflow-x-auto no-scrollbar pb-2">
                    <button 
                        v-for="cat in foodCategories" 
                        :key="cat"
                        @click="activeFoodCategory = cat"
                        class="flex-shrink-0 px-4 py-2 rounded-full text-sm font-bold transition-all border whitespace-nowrap"
                        :class="activeFoodCategory === cat ? 'bg-michelin text-white border-michelin shadow-md' : 'bg-white text-gray-500 border-gray-200'"
                    >
                        {{ cat }}
                    </button>
                </div>

                <!-- Restaurant List -->
                <div class="space-y-4">
                    <div v-for="spot in filteredFoodSpots" :key="spot.id || spot.name" class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden flex flex-col relative">
                        
                        <!-- Delete Button for Custom Spots -->
                        <button v-if="spot.isCustom" @click="deleteCustomFood(spot.id)" class="absolute top-2 right-2 text-gray-300 hover:text-red-500 p-2 z-10">
                            <i class="fa-solid fa-trash text-xs"></i>
                        </button>

                        <!-- Header / Tag -->
                        <div class="flex justify-between items-start p-4 pb-2">
                            <div class="flex flex-col pr-8">
                                <div class="flex items-center gap-2 mb-1 flex-wrap">
                                    <span v-if="spot.level === '1 Star'" class="bg-yellow-100 text-yellow-700 px-2 py-0.5 rounded text-[10px] font-bold border border-yellow-200">
                                        <i class="fa-solid fa-star"></i> 米芝蓮一星
                                    </span>
                                    <span v-else-if="spot.level === 'Bib'" class="bg-red-50 text-michelin px-2 py-0.5 rounded text-[10px] font-bold border border-red-100">
                                        <i class="fa-solid fa-face-grin-tongue"></i> 必比登推介
                                    </span>
                                    <span v-else-if="spot.isCustom" class="bg-blue-50 text-blue-600 px-2 py-0.5 rounded text-[10px] font-bold border border-blue-100">
                                        <i class="fa-solid fa-user-pen"></i> 自訂收藏
                                    </span>
                                    <span v-else class="bg-gray-100 text-gray-600 px-2 py-0.5 rounded text-[10px] font-bold">
                                        在地推薦
                                    </span>
                                    <span class="text-xs text-gray-400 font-medium">{{ spot.price }}</span>
                                </div>
                                <h3 class="font-bold text-gray-900 text-lg">{{ spot.name }}</h3>
                                <p class="text-xs text-gray-500">{{ spot.engName }}</p>
                            </div>
                            <button @click="openMap(spot.engName || spot.name)" class="w-10 h-10 bg-blue-50 rounded-full flex items-center justify-center text-blue-500 hover:bg-blue-100 shadow-sm shrink-0">
                                <i class="fa-solid fa-location-dot"></i>
                            </button>
                        </div>
                        
                        <!-- Content -->
                        <div class="px-4 pb-4">
                            <div class="flex gap-2 mb-3">
                                <span class="text-xs bg-gray-50 px-2 py-1 rounded text-gray-500">
                                    <i class="fa-solid fa-map-pin text-[10px] mr-1"></i> {{ spot.area }}
                                </span>
                                <span class="text-xs bg-gray-50 px-2 py-1 rounded text-gray-500">
                                    <i class="fa-solid fa-utensils text-[10px] mr-1"></i> {{ spot.type }}
                                </span>
                            </div>
                            <p class="text-sm text-gray-600 leading-relaxed border-t border-gray-50 pt-2" v-if="spot.mustEat">
                                <span class="font-bold text-gray-800">必點：</span>{{ spot.mustEat }}
                            </p>
                            <p class="text-xs text-gray-400 mt-2" v-if="spot.note">
                                <i class="fa-solid fa-triangle-exclamation mr-1"></i> {{ spot.note }}
                            </p>
                        </div>
                    </div>

                    <!-- Empty State for filtered -->
                    <div v-if="filteredFoodSpots.length === 0" class="text-center py-10 text-gray-400">
                        <p>這個區域暫無餐廳資料</p>
                    </div>
                </div>
            </div>

            <!-- VIEW: EXPENSE (分帳) -->
            <div v-if="currentTab === 'expense'" class="space-y-6">
                <!-- Currency Calculator -->
                <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-5">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="font-bold text-gray-800 flex items-center gap-2">
                            <i class="fa-solid fa-money-bill-transfer text-green-500"></i> 
                            匯率計算機
                        </h3>
                        <div class="flex items-center gap-2 text-xs bg-gray-50 px-2 py-1 rounded-lg">
                            <span class="text-gray-400">匯率:</span>
                            <input type="number" v-model.number="currentRate" @input="updateFromHKD" class="w-12 bg-transparent font-bold text-gray-700 text-right outline-none border-b border-gray-300 focus:border-primary" step="0.01">
                        </div>
                    </div>
                    
                    <div class="flex items-center gap-3">
                        <div class="flex-1">
                            <label class="block text-xs font-bold text-gray-400 mb-1">泰銖 (THB)</label>
                            <div class="relative">
                                <input type="number" v-model.number="calcTHB" @input="updateFromTHB" class="w-full bg-gray-50 rounded-xl px-3 py-2 text-lg font-bold text-gray-800 outline-none focus:ring-2 focus:ring-primary focus:bg-white transition text-center" placeholder="0">
                            </div>
                        </div>
                        <div class="text-gray-300 pt-5">
                            <i class="fa-solid fa-right-left"></i>
                        </div>
                        <div class="flex-1">
                            <label class="block text-xs font-bold text-gray-400 mb-1">港幣 (HKD)</label>
                            <div class="relative">
                                <input type="number" v-model.number="calcHKD" @input="updateFromHKD" class="w-full bg-gray-50 rounded-xl px-3 py-2 text-lg font-bold text-gray-800 outline-none focus:ring-2 focus:ring-primary focus:bg-white transition text-center" placeholder="0">
                            </div>
                        </div>
                    </div>
                    <p class="text-[10px] text-gray-400 text-center mt-2">輸入任一欄位自動換算，預設匯率 4.4</p>
                </div>

                <!-- Overview Card -->
                <div class="bg-gradient-to-r from-secondary to-purple-600 rounded-2xl p-6 text-white shadow-lg relative overflow-hidden">
                    <div class="absolute right-0 top-0 w-32 h-32 bg-white opacity-5 rounded-full -mr-10 -mt-10 blur-2xl"></div>
                    <div class="relative z-10">
                        <div class="text-purple-200 text-sm font-medium mb-1">總支出 (Total)</div>
                        <div class="text-4xl font-bold tracking-tight">฿ {{ totalExpense.toLocaleString() }}</div>
                        <div class="mt-4 flex space-x-2 overflow-x-auto no-scrollbar">
                            <div v-for="(person, idx) in members" :key="idx" class="bg-white/20 px-3 py-1 rounded-lg text-xs backdrop-blur-sm whitespace-nowrap">
                                {{ person }}: ฿ {{ getPaidAmount(person).toLocaleString() }}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="grid grid-cols-2 gap-3">
                    <button @click="showSettlementModal = true" class="bg-white border border-purple-100 text-secondary py-3 rounded-xl font-bold shadow-sm hover:bg-purple-50 transition flex items-center justify-center gap-2">
                        <i class="fa-solid fa-calculator"></i> 結算報表
                    </button>
                    <button @click="openExpenseModal()" class="bg-secondary text-white py-3 rounded-xl font-bold shadow-md shadow-purple-200 active:scale-95 transition flex items-center justify-center gap-2">
                        <i class="fa-solid fa-plus"></i> 新增消費
                    </button>
                </div>

                <!-- Expense List -->
                <div>
                    <h3 class="font-bold text-gray-700 mb-3 px-1">最近消費記錄</h3>
                    <div class="space-y-3">
                        <div v-for="exp in expenses" :key="exp.id" class="bg-white p-4 rounded-xl shadow-sm flex justify-between items-center border border-gray-50">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 rounded-full bg-purple-50 text-secondary flex items-center justify-center font-bold text-xs">
                                    {{ exp.payer.charAt(0) }}
                                </div>
                                <div>
                                    <div class="font-bold text-gray-800">{{ exp.title }}</div>
                                    <div class="text-xs text-gray-500">{{ exp.payer }} 先付</div>
                                </div>
                            </div>
                            <div class="text-right">
                                <div class="font-bold text-gray-900">฿{{ exp.amount }}</div>
                                <button @click="deleteExpense(exp.id)" class="text-xs text-red-300 hover:text-red-500 mt-1">刪除</button>
                            </div>
                        </div>
                        <div v-if="expenses.length === 0" class="text-center py-8 text-gray-400 text-sm">
                            尚無消費記錄
                        </div>
                    </div>
                </div>
            </div>

        </main>

        <!-- Floating Action Button -->
        <button 
            v-if="currentTab === 'itinerary'"
            @click="openItineraryModal()"
            class="absolute bottom-24 right-5 w-14 h-14 bg-primary text-white rounded-full shadow-lg shadow-orange-200 flex items-center justify-center text-2xl active:scale-90 transition transform z-20"
        >
            <i class="fa-solid fa-plus"></i>
        </button>

        <button 
            v-if="currentTab === 'food'"
            @click="openFoodModal()"
            class="absolute bottom-24 right-5 w-14 h-14 bg-michelin text-white rounded-full shadow-lg shadow-red-200 flex items-center justify-center text-2xl active:scale-90 transition transform z-20"
        >
            <i class="fa-solid fa-plus"></i>
        </button>

        <!-- Bottom Navigation (Fixed) -->
        <nav class="bg-white border-t border-gray-100 flex justify-around items-center px-2 py-3 pb-safe z-30 shrink-0 sticky bottom-0 w-full">
            <button @click="currentTab = 'itinerary'" class="flex-1 flex flex-col items-center gap-1 p-2 rounded-xl transition" :class="currentTab === 'itinerary' ? 'text-primary' : 'text-gray-400'">
                <i class="fa-solid fa-map-location-dot text-xl"></i>
                <span class="text-xs font-medium">行程</span>
            </button>
            <button @click="currentTab = 'food'" class="flex-1 flex flex-col items-center gap-1 p-2 rounded-xl transition" :class="currentTab === 'food' ? 'text-michelin' : 'text-gray-400'">
                <i class="fa-solid fa-utensils text-xl"></i>
                <span class="text-xs font-medium">美食指南</span>
            </button>
            <button @click="currentTab = 'expense'" class="flex-1 flex flex-col items-center gap-1 p-2 rounded-xl transition" :class="currentTab === 'expense' ? 'text-secondary' : 'text-gray-400'">
                <i class="fa-solid fa-coins text-xl"></i>
                <span class="text-xs font-medium">分帳/匯率</span>
            </button>
        </nav>


        <!-- MODAL: ADD/EDIT ITINERARY -->
        <div v-if="showItineraryModal" class="fixed inset-0 bg-black/50 z-50 flex items-end sm:items-center justify-center backdrop-blur-sm p-4">
            <div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl transform transition-all animate-slide-up">
                <h3 class="text-xl font-bold mb-4">{{ isEditing ? '編輯行程' : '新增行程' }}</h3>
                
                <div class="space-y-4 max-h-[60vh] overflow-y-auto no-scrollbar">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-1">時間</label>
                        <input v-model="formItinerary.time" type="time" class="w-full bg-gray-100 rounded-xl px-4 py-3 outline-none focus:ring-2 focus:ring-primary">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-1">活動名稱</label>
                        <input v-model="formItinerary.title" type="text" placeholder="例：去洽圖洽逛街" class="w-full bg-gray-100 rounded-xl px-4 py-3 outline-none focus:ring-2 focus:ring-primary">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-1">地點 (Google Maps)</label>
                        <input v-model="formItinerary.location" type="text" placeholder="例：Chatuchak Market" class="w-full bg-gray-100 rounded-xl px-4 py-3 outline-none focus:ring-2 focus:ring-primary">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-1">交通方式</label>
                        <input v-model="formItinerary.transport" type="text" placeholder="例：包車、Grab" class="w-full bg-gray-100 rounded-xl px-4 py-3 outline-none focus:ring-2 focus:ring-primary">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-1">備註 / 泰文地址</label>
                        <textarea v-model="formItinerary.desc" rows="3" class="w-full bg-gray-100 rounded-xl px-4 py-3 outline-none focus:ring-2 focus:ring-primary text-sm"></textarea>
                    </div>
                </div>

                <div class="flex gap-3 mt-6">
                    <button @click="showItineraryModal = false" class="flex-1 py-3 rounded-xl bg-gray-100 font-bold text-gray-600">取消</button>
                    <button v-if="isEditing" @click="deleteItinerary" class="flex-none px-4 py-3 rounded-xl bg-red-50 text-red-500 font-bold"><i class="fa-solid fa-trash"></i></button>
                    <button @click="saveItinerary" class="flex-1 py-3 rounded-xl bg-primary text-white font-bold shadow-lg shadow-orange-100">儲存</button>
                </div>
            </div>
        </div>

        <!-- MODAL: ADD FOOD -->
        <div v-if="showFoodModal" class="fixed inset-0 bg-black/50 z-50 flex items-end sm:items-center justify-center backdrop-blur-sm p-4">
            <div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl transform transition-all animate-slide-up">
                <h3 class="text-xl font-bold mb-4">新增美食餐廳</h3>
                
                <div class="space-y-4 max-h-[60vh] overflow-y-auto no-scrollbar">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-1">餐廳名稱</label>
                        <input v-model="formFood.name" type="text" placeholder="例：After You Dessert" class="w-full bg-gray-100 rounded-xl px-4 py-3 outline-none focus:ring-2 focus:ring-michelin">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-1">英文/泰文店名 (Google Maps用)</label>
                        <input v-model="formFood.engName" type="text" placeholder="例：After You Siam Paragon" class="w-full bg-gray-100 rounded-xl px-4 py-3 outline-none focus:ring-2 focus:ring-michelin">
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-xs font-bold text-gray-500 mb-1">地區</label>
                            <select v-model="formFood.category" class="w-full bg-gray-100 rounded-xl px-4 py-3 outline-none focus:ring-2 focus:ring-michelin appearance-none">
                                <option v-for="cat in foodCategories.filter(c => c !== '全區')" :key="cat" :value="cat">{{ cat }}</option>
                                <option value="Other">其他</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-500 mb-1">價位</label>
                            <select v-model="formFood.price" class="w-full bg-gray-100 rounded-xl px-4 py-3 outline-none focus:ring-2 focus:ring-michelin appearance-none">
                                <option value="฿">฿ (便宜)</option>
                                <option value="฿฿">฿฿ (中價)</option>
                                <option value="฿฿฿">฿฿฿ (高級)</option>
                            </select>
                        </div>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-1">料理類型</label>
                        <input v-model="formFood.type" type="text" placeholder="例：甜點、咖啡廳" class="w-full bg-gray-100 rounded-xl px-4 py-3 outline-none focus:ring-2 focus:ring-michelin">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-1">必吃菜色</label>
                        <input v-model="formFood.mustEat" type="text" placeholder="例：芒果糯米刨冰" class="w-full bg-gray-100 rounded-xl px-4 py-3 outline-none focus:ring-2 focus:ring-michelin">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-1">備註</label>
                        <textarea v-model="formFood.note" rows="2" class="w-full bg-gray-100 rounded-xl px-4 py-3 outline-none focus:ring-2 focus:ring-michelin text-sm"></textarea>
                    </div>
                </div>

                <div class="flex gap-3 mt-6">
                    <button @click="showFoodModal = false" class="flex-1 py-3 rounded-xl bg-gray-100 font-bold text-gray-600">取消</button>
                    <button @click="saveFood" class="flex-1 py-3 rounded-xl bg-michelin text-white font-bold shadow-lg shadow-red-200">加入清單</button>
                </div>
            </div>
        </div>

        <!-- MODAL: THAI ADDRESS -->
        <div v-if="showThaiAddrModal" class="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-6 backdrop-blur-sm">
            <div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl text-center">
                <div class="w-16 h-16 bg-purple-100 text-purple-600 rounded-full flex items-center justify-center mx-auto mb-4 text-2xl">
                    <i class="fa-solid fa-taxi"></i>
                </div>
                <h3 class="text-lg font-bold text-gray-500 mb-2">請司機去這裡</h3>
                <h2 class="text-2xl font-bold text-gray-900 mb-6 leading-relaxed select-all">{{ thaiAddrContent }}</h2>
                <button @click="showThaiAddrModal = false" class="w-full py-3 rounded-xl bg-gray-800 text-white font-bold">關閉</button>
            </div>
        </div>

        <!-- MODAL: ADD EXPENSE -->
        <div v-if="showExpenseModal" class="fixed inset-0 bg-black/50 z-50 flex items-end sm:items-center justify-center backdrop-blur-sm p-4">
            <div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl transform transition-all animate-slide-up">
                <h3 class="text-xl font-bold mb-4">記一筆</h3>
                
                <div class="space-y-4">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-1">項目</label>
                        <input v-model="formExpense.title" type="text" placeholder="例：午餐、Grab" class="w-full bg-gray-100 rounded-xl px-4 py-3 outline-none focus:ring-2 focus:ring-secondary">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-1">金額 (THB)</label>
                        <input v-model.number="formExpense.amount" type="number" placeholder="0" class="w-full bg-gray-100 rounded-xl px-4 py-3 outline-none focus:ring-2 focus:ring-secondary text-lg font-mono">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-1">誰先付的？</label>
                        <div class="flex flex-wrap gap-2">
                            <button 
                                v-for="m in members" 
                                :key="m"
                                @click="formExpense.payer = m"
                                class="px-4 py-2 rounded-lg text-sm font-bold border transition"
                                :class="formExpense.payer === m ? 'bg-secondary text-white border-secondary' : 'bg-white text-gray-500 border-gray-200'"
                            >
                                {{ m }}
                            </button>
                        </div>
                    </div>
                </div>

                <div class="flex gap-3 mt-6">
                    <button @click="showExpenseModal = false" class="flex-1 py-3 rounded-xl bg-gray-100 font-bold text-gray-600">取消</button>
                    <button @click="saveExpense" class="flex-1 py-3 rounded-xl bg-secondary text-white font-bold shadow-lg shadow-purple-200">新增</button>
                </div>
            </div>
        </div>

        <!-- MODAL: SETTLEMENT REPORT -->
        <div v-if="showSettlementModal" class="fixed inset-0 bg-black/50 z-50 flex items-end sm:items-center justify-center backdrop-blur-sm p-4">
            <div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl max-h-[80vh] overflow-y-auto">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold">結算建議</h3>
                    <button @click="showSettlementModal = false" class="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center text-gray-500"><i class="fa-solid fa-xmark"></i></button>
                </div>

                <div class="bg-blue-50 p-4 rounded-xl text-sm text-blue-800 mb-4">
                    <p class="font-bold mb-1">總花費: ฿{{ totalExpense }}</p>
                    <p>平均每人: ฿{{ (totalExpense / members.length).toFixed(1) }}</p>
                </div>

                <div v-if="settlements.length > 0" class="space-y-3">
                    <div v-for="(s, idx) in settlements" :key="idx" class="flex items-center justify-between p-3 border border-gray-100 rounded-xl shadow-sm">
                        <div class="flex items-center gap-2">
                            <span class="font-bold text-red-500">{{ s.from }}</span>
                            <i class="fa-solid fa-arrow-right text-gray-300 text-xs"></i>
                            <span class="font-bold text-green-500">{{ s.to }}</span>
                        </div>
                        <span class="font-mono font-bold bg-gray-100 px-2 py-1 rounded">฿{{ Math.round(s.amount) }}</span>
                    </div>
                    <p class="text-xs text-gray-400 text-center mt-4">已使用最小轉帳次數演算法優化</p>
                </div>
                <div v-else class="text-center py-6 text-green-600 font-bold">
                    <i class="fa-solid fa-check-circle text-3xl mb-2"></i>
                    <p>帳目已平衡，不需要轉帳！</p>
                </div>
            </div>
        </div>

        <!-- MODAL: SETTINGS (MEMBERS) -->
        <div v-if="showSettings" class="fixed inset-0 bg-black/50 z-50 flex items-end sm:items-center justify-center backdrop-blur-sm p-4">
            <div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl">
                <h3 class="text-xl font-bold mb-4">設定</h3>
                
                <div class="mb-4">
                    <label class="block text-xs font-bold text-gray-500 mb-2">旅伴管理</label>
                    <div class="flex gap-2 mb-2">
                        <input v-model="newMemberName" type="text" placeholder="輸入名字" class="flex-1 bg-gray-100 rounded-xl px-4 py-2 outline-none">
                        <button @click="addMember" class="bg-gray-800 text-white px-4 rounded-xl font-bold">+</button>
                    </div>
                    <div class="flex flex-wrap gap-2 mt-3">
                        <div v-for="(m, idx) in members" :key="idx" class="bg-gray-100 px-3 py-1 rounded-full text-sm flex items-center gap-2">
                            {{ m }}
                            <button @click="removeMember(idx)" class="text-gray-400 hover:text-red-500" v-if="members.length > 1">×</button>
                        </div>
                    </div>
                </div>

                <div class="pt-4 border-t">
                    <button @click="resetAllData" class="w-full py-3 rounded-xl border border-red-200 text-red-500 font-bold mb-2">還原預設行程 (重置)</button>
                    <button @click="showSettings = false" class="w-full py-3 rounded-xl bg-gray-800 text-white font-bold">完成</button>
                </div>
            </div>
        </div>

    </div>

    <script>
        const { createApp, ref, computed, onMounted, watch } = Vue;

        const defaultItinerary = [
            { 
                id: 1, 
                date: '12/26 (五)',
                title: '啟程曼谷・初見泰味', 
                note: '建議：機場到飯店包車最舒適',
                items: [
                    { id: 101, time: '12:05', title: '抵達 BKK 機場', location: 'Suvarnabhumi Airport', desc: '領完行李後，前往預定好的專車接機點集合。', transport: '包車/接送' },
                    { id: 102, time: '14:00', title: '飯店 Check-in & 休息', location: 'Centre Point Hotel Sukhumvit 10', thaiAddr: '39 ซอย สุขุมวิท 10 แขวงคลองเตย', desc: '讓長輩小孩先休息，整理行李。', tags: ['住宿'] },
                    { id: 103, time: '15:30', title: 'Chef Ple 芒果糯米飯', location: 'Chef Ple Thai Mango Sticky Rice', desc: '在 Times Square Building 旁。可外帶回飯店吃。', transport: '步行/TukTuk' },
                    { id: 104, time: '17:30', title: 'EmSphere 商場晚餐', location: 'EmSphere', thaiAddr: '628 ถนนสุขุมวิท แขวงคลองตัน เขตคลองเตย', desc: '餐廳：Kub Kao Kub Pla (吃飯吃魚)。環境舒適，口味適合全家。', transport: 'Grab/包車', tags: ['晚餐'] }
                ]
            },
            { 
                id: 2, 
                date: '12/27 (六)',
                title: '泰服穿越・河畔盛宴', 
                note: '重點日！注意長輩體力，鄭王廟樓梯陡峭。',
                items: [
                    { id: 201, time: '09:30', title: '鄭王廟泰服體驗', location: 'Wat Arun', thaiAddr: '158 ถนนวังเดิม แขวงวัดอรุณ เขตบางกอกใหญ่', desc: 'Vision Thai Studio 換裝。長輩與幼童建議在平面庭園拍照即可，注意安全。', transport: '包車' },
                    { id: 202, time: '12:30', title: 'ICONSIAM 午餐', location: 'ICONSIAM', thaiAddr: '299 ถนนเจริญนคร แขวงคลองต้นไทร เขตคลองสาน', desc: '建議至高樓層餐廳（如 Nara Thai Cuisine）。餐後可逛 SookSiam 室內水上市場。', transport: '包車/Grab' },
                    { id: 203, time: '15:00', title: '侏羅紀展覽', location: 'ICONSIAM Jurassic World', desc: '在冷氣房內體驗沉浸式恐龍世界，小朋友的最愛。', tags: ['展覽'] },
                    { id: 204, time: '17:30', title: 'Asiatique 河濱夜市晚餐', location: 'Asiatique The Riverfront', thaiAddr: '2194 ถนนเจริญกรุง แขวงวัดพระยาไกร เขตบางคอแหลม', desc: '晚餐推薦：Ko Dang Talay (海鮮倉庫)。環境寬敞適合大家庭。', transport: '包車/Grab', tags: ['晚餐'] }
                ]
            },
            { 
                id: 3, 
                date: '12/28 (日)',
                title: '週末淘寶・在地釣蝦樂', 
                note: '分組行動：長輩幼童吹冷氣，採購組逛市集。',
                items: [
                    { id: 301, time: '10:00', title: '洽圖洽市集 / Mixt 商場', location: 'Mixt Chatuchak', thaiAddr: '8 Kamphaeng Phet 3 Rd, Chatuchak', desc: '長輩幼童在 Mixt 商場吹冷氣休息。採購組去戶外市集尋寶。午餐在商場內解決。', transport: '包車/Grab' },
                    { id: 302, time: '15:30', title: '飯店泳池 / 足部按摩', location: 'Centre Point Hotel Sukhumvit 10', desc: '午後避暑。小朋友玩水，大人在附近找按摩店放鬆。', transport: '回飯店' },
                    { id: 303, time: '17:30', title: '釣蝦體驗晚餐', location: 'Bor Tok Kung Charoen Nakhon 16', thaiAddr: 'บ่อตกกุ้งเจริญนคร 16 (Soi Charoen Nakhon 16)', desc: '體驗在地娛樂！建議先點一些熱炒以免等太久餓肚子。', transport: '包車/Grab', tags: ['晚餐'] }
                ]
            },
            { 
                id: 4, 
                date: '12/29 (一)',
                title: '野生動物園・親子同樂', 
                note: '強烈建議今日全日包車，方便休息與置物。',
                items: [
                    { id: 401, time: '08:30', title: 'Safari World 野生動物園', location: 'Safari World', thaiAddr: '99 ถนนปัญญาอินทรา แขวงสามวาตะวันตก เขตคลองสามวา', desc: '上午搭車遊野生動物區 (Safari Park)，下午步行海洋公園區 (Marine Park)。必去長頸鹿餵食亭。', transport: '包車', tags: ['全日遊'] },
                    { id: 402, time: '18:30', title: 'Central World 晚餐', location: 'Central World', thaiAddr: '999/9 ถนนพระรามที่ ๑ แขวงปทุมวัน', desc: '晚餐：Savoey Seafood (上味泰餐館)，2樓 Groove 區。推薦咖哩螃蟹。', transport: '包車回市區', tags: ['晚餐'] }
                ]
            },
            { 
                id: 5, 
                date: '12/30 (二)',
                title: '伴手禮・海洋探索・夜市', 
                note: '利用 Skywalk 連通道移動，舒適涼爽。',
                items: [
                    { id: 501, time: '11:00', title: 'Big C 採買伴手禮', location: 'Big C Supercenter Rajdamri', thaiAddr: '97/11 ถนนราชดำริ แขวงลุมพินี เขตปทุมวัน', desc: '就在 Central World 對面。買完可寄放或請司機載回。', transport: '包車/Grab' },
                    { id: 502, time: '13:00', title: '午餐：Thong Smith 船麵', location: 'Central World', desc: '位於 3 樓 Beacon 區。高級船麵，辣度可調整。', tags: ['午餐'] },
                    { id: 503, time: '14:30', title: 'Sea Life 水族館 / 下午茶', location: 'Siam Paragon', thaiAddr: '991 ถนนพระรามที่ 1 แขวงปทุมวัน', desc: '親子組：去 B1-B2 水族館。休閒組：在百貨喝下午茶。從 Central World 走 Skywalk 過來。', transport: '步行 Skywalk' },
                    { id: 504, time: '18:00', title: '喬德夜市晚餐', location: 'Jodd Fairs Rama 9', thaiAddr: 'ถนนพระราม 9 แขวงห้วยขวาง', desc: '晚餐吃火山排骨。長輩若怕熱可去旁邊 Central Rama 9 商場休息。', transport: 'Grab/包車', tags: ['晚餐'] }
                ]
            },
            { 
                id: 6, 
                date: '12/31 (三)',
                title: '滿載而歸・再會曼谷', 
                note: '檢查戰利品，準備前往機場。',
                items: [
                    { id: 601, time: '09:30', title: '悠閒早餐 & 收拾', location: 'Centre Point Hotel Sukhumvit 10', desc: '享受最後的飯店時光。' },
                    { id: 602, time: '11:00', title: '前往機場 (BKK)', location: 'Suvarnabhumi Airport', desc: '搭乘專車送機。車程約 45-60 分鐘。', transport: '包車送機' },
                    { id: 603, time: '13:45', title: '航班起飛 (EK384)', location: 'Suvarnabhumi Airport', desc: '13:45 BKK -> 17:40 HKG', tags: ['飛機'] }
                ]
            }
        ];

        // Michelin Guide Data (Static)
        const defaultMichelinData = [
            // Old Town / Chinatown
            {
                name: "Jay Fai (痣姐)",
                engName: "Raan Jay Fai",
                area: "舊城區 (Old Town)",
                category: "Old Town",
                level: "1 Star",
                type: "街頭熱炒",
                mustEat: "黃金蟹肉蛋捲 (Crab Omelette), 醉漢麵",
                price: "฿฿฿฿",
                note: "價格昂貴，需排隊數小時或預約。唯一米芝蓮星級路邊攤。"
            },
            {
                name: "Thipsamai (鬼門泰式炒麵)",
                engName: "Thipsamai Pad Thai Pratoopee",
                area: "舊城區 (Old Town)",
                category: "Old Town",
                level: "Bib",
                type: "炒河粉",
                mustEat: "蛋包泰式炒河 (Superb Pad Thai)",
                price: "฿฿",
                note: "就在 Jay Fai 旁邊，排隊人潮多但流動快。橘子汁必點！"
            },
            {
                name: "Nai Mong Hoi Thod (內蒙蠔煎)",
                engName: "Nai Mong Hoi Thod",
                area: "唐人街 (Chinatown)",
                category: "Old Town",
                level: "Bib",
                type: "蚵仔煎",
                mustEat: "脆皮蚵仔煎 (Crispy Oyster Omelette)",
                price: "฿฿",
                note: "位於唐人街邊緣，口感極度酥脆。"
            },
            {
                name: "Lim Lao Ngow (林老五魚丸)",
                engName: "Lim Lao Ngow Fishball Noodle",
                area: "唐人街 (Chinatown)",
                category: "Old Town",
                level: "Bib",
                type: "魚丸麵",
                mustEat: "乾拌魚丸麵",
                price: "฿",
                note: "百年老店，魚丸Q彈無粉感。晚上才開。"
            },
            
            // Sukhumvit
            {
                name: "Rung Rueang (榮泰米粉湯)",
                engName: "Rung Rueang Pork Noodle",
                area: "Sukhumvit (Phrom Phong)",
                category: "Sukhumvit",
                level: "Bib",
                type: "豬肉麵",
                mustEat: "酸辣豬肉米粉湯 (Tom Yum Pork Noodles)",
                price: "฿",
                note: "位於 Soi 26，有兩間店面相鄰，都是親戚開的，味道差不多。"
            },
            {
                name: "Here Hai (海海)",
                engName: "Here Hai Restaurant",
                area: "Sukhumvit (Ekkamai)",
                category: "Sukhumvit",
                level: "Bib",
                type: "海鮮熱炒",
                mustEat: "蟹肉炒飯 (Insane Crab Fried Rice)",
                price: "฿฿฿",
                note: "蟹肉份量驚人，建議訂位。"
            },
            {
                name: "Wattana Panich (郭炎松)",
                engName: "Wattana Panich",
                area: "Sukhumvit (Ekkamai)",
                category: "Sukhumvit",
                level: "Bib",
                type: "牛肉麵",
                mustEat: "燉牛肉粿條",
                price: "฿฿",
                note: "門口那鍋煮了幾十年的陳年老湯是招牌。"
            },

            // Siam / Pratunam
            {
                name: "Go-Ang (紅大哥水門雞飯)",
                engName: "Go-Ang Kaomunkai Pratunam",
                area: "Pratunam (水門)",
                category: "Siam",
                level: "Bib",
                type: "海南雞飯",
                mustEat: "雞油飯, 燉雞湯",
                price: "฿",
                note: "店員穿粉紅色制服。就在 Central World 附近。"
            },
            {
                name: "Jeh O Chula (雅歐)",
                engName: "Jeh O Chula",
                area: "Siam (Chula)",
                category: "Siam",
                level: "Bib",
                type: "宵夜熱炒",
                mustEat: "冬蔭功媽媽麵鍋 (Tom Yum Mama)",
                price: "฿฿",
                note: "深夜排隊名店，媽媽麵晚上11點後才供應。"
            },

            // Silom / Sathorn
            {
                name: "Jok Prince (王子戲院豬肉粥)",
                engName: "Jok Prince",
                area: "Bang Rak (Silom)",
                category: "Silom",
                level: "Bib",
                type: "廣式粥品",
                mustEat: "豬肉蛋粥 (Pork Congee with Egg)",
                price: "฿",
                note: "帶有焦香味的獨特粥品，就在 Robinson Bangrak 對面。"
            },
            {
                name: "Baan Somtum (Sathorn)",
                engName: "Baan Somtum Sathorn",
                area: "Sathorn",
                category: "Silom",
                level: "Bib",
                type: "泰北菜",
                mustEat: "青木瓜沙拉, 炸雞翅",
                price: "฿฿",
                note: "環境舒適，冷氣強，適合家庭聚餐。"
            }
        ];

        createApp({
            setup() {
                // State
                const currentTab = ref('itinerary');
                const activeDayIndex = ref(0);
                const activeFoodCategory = ref('全區');
                const showItineraryModal = ref(false);
                const showExpenseModal = ref(false);
                const showFoodModal = ref(false);
                const showSettlementModal = ref(false);
                const showSettings = ref(false);
                const showThaiAddrModal = ref(false);
                const thaiAddrContent = ref('');
                const isEditing = ref(false);
                const editingId = ref(null);

                // Calculator State
                const calcTHB = ref('');
                const calcHKD = ref('');
                const currentRate = ref(4.4);

                // Data
                const savedTrips = JSON.parse(localStorage.getItem('tripDays_v2'));
                const tripDays = ref(savedTrips || defaultItinerary);
                const expenses = ref(JSON.parse(localStorage.getItem('expenses')) || []);
                const members = ref(JSON.parse(localStorage.getItem('members')) || ['我', '家人A', '家人B']);
                const newMemberName = ref('');
                
                // Food Data Handling
                const customFoodSpots = ref(JSON.parse(localStorage.getItem('customFoodSpots')) || []);
                const foodSpots = computed(() => [...customFoodSpots.value, ...defaultMichelinData]);

                // Food Categories
                const foodCategories = ['全區', 'Siam', 'Sukhumvit', 'Old Town', 'Silom'];

                // Forms
                const formItinerary = ref({ time: '', title: '', location: '', transport: '', desc: '', thaiAddr: '' });
                const formExpense = ref({ title: '', amount: '', payer: '' });
                const formFood = ref({ name: '', engName: '', category: 'Siam', level: 'Custom', type: '', mustEat: '', price: '฿', note: '' });

                // Computed
                const currentDayItems = computed(() => {
                    return tripDays.value[activeDayIndex.value].items.sort((a, b) => a.time.localeCompare(b.time));
                });

                const filteredFoodSpots = computed(() => {
                    if (activeFoodCategory.value === '全區') {
                        return foodSpots.value;
                    }
                    return foodSpots.value.filter(spot => spot.category === activeFoodCategory.value || (activeFoodCategory.value === 'Siam' && spot.category === 'Siam') /* Fallback logic simplified */);
                });

                const totalExpense = computed(() => {
                    return expenses.value.reduce((sum, item) => sum + item.amount, 0);
                });

                const settlements = computed(() => {
                    if (members.value.length === 0) return [];
                    const balances = {};
                    members.value.forEach(m => balances[m] = 0);
                    const splitAmount = totalExpense.value / members.value.length;
                    expenses.value.forEach(exp => {
                        if (balances[exp.payer] !== undefined) balances[exp.payer] += exp.amount;
                    });
                    let debtors = [], creditors = [];
                    for (const m in balances) {
                        const net = balances[m] - splitAmount;
                        if (net < -0.01) debtors.push({ name: m, amount: Math.abs(net) });
                        else if (net > 0.01) creditors.push({ name: m, amount: net });
                    }
                    const result = [];
                    let i = 0, j = 0;
                    while (i < debtors.length && j < creditors.length) {
                        const debtor = debtors[i];
                        const creditor = creditors[j];
                        const amount = Math.min(debtor.amount, creditor.amount);
                        if (amount > 0) result.push({ from: debtor.name, to: creditor.name, amount: amount });
                        debtor.amount -= amount;
                        creditor.amount -= amount;
                        if (debtor.amount < 0.01) i++;
                        if (creditor.amount < 0.01) j++;
                    }
                    return result;
                });

                // Methods
                const updateFromTHB = () => {
                    if (!calcTHB.value) { calcHKD.value = ''; return; }
                    calcHKD.value = (calcTHB.value / currentRate.value).toFixed(2);
                };
                const updateFromHKD = () => {
                    if (!calcHKD.value) { calcTHB.value = ''; return; }
                    calcTHB.value = (calcHKD.value * currentRate.value).toFixed(0);
                };

                const addDay = () => {
                    tripDays.value.push({ id: Date.now(), date: `Day ${tripDays.value.length + 1}`, title: '新的一天', items: [] });
                    activeDayIndex.value = tripDays.value.length - 1;
                };

                const openItineraryModal = () => {
                    isEditing.value = false;
                    formItinerary.value = { time: '10:00', title: '', location: '', transport: '', desc: '', thaiAddr: '' };
                    showItineraryModal.value = true;
                };

                const editItem = (item) => {
                    isEditing.value = true;
                    editingId.value = item.id;
                    formItinerary.value = { ...item };
                    showItineraryModal.value = true;
                };

                const showThaiAddress = (item) => {
                    thaiAddrContent.value = item.thaiAddr;
                    showThaiAddrModal.value = true;
                };

                const saveItinerary = () => {
                    if (!formItinerary.value.title) return;
                    if (isEditing.value) {
                        const day = tripDays.value[activeDayIndex.value];
                        const idx = day.items.findIndex(i => i.id === editingId.value);
                        if (idx !== -1) day.items[idx] = { ...formItinerary.value, id: editingId.value };
                    } else {
                        tripDays.value[activeDayIndex.value].items.push({ id: Date.now(), ...formItinerary.value });
                    }
                    showItineraryModal.value = false;
                    saveData();
                };

                const deleteItinerary = () => {
                    if (confirm('確定要刪除這個行程嗎？')) {
                        const day = tripDays.value[activeDayIndex.value];
                        day.items = day.items.filter(i => i.id !== editingId.value);
                        showItineraryModal.value = false;
                        saveData();
                    }
                };

                const openMap = (loc) => {
                    if (!loc) return;
                    const query = encodeURIComponent(loc + ' Bangkok');
                    window.open(`https://www.google.com/maps/search/?api=1&query=${query}`, '_blank');
                };

                const openExpenseModal = () => {
                    formExpense.value = { title: '', amount: '', payer: members.value[0] || '' };
                    showExpenseModal.value = true;
                };

                const saveExpense = () => {
                    if (!formExpense.value.title || !formExpense.value.amount || !formExpense.value.payer) return;
                    expenses.value.unshift({ id: Date.now(), ...formExpense.value });
                    showExpenseModal.value = false;
                    saveData();
                };

                const deleteExpense = (id) => {
                    if (confirm('刪除這筆帳目？')) {
                        expenses.value = expenses.value.filter(e => e.id !== id);
                        saveData();
                    }
                };

                // Food Methods
                const openFoodModal = () => {
                    formFood.value = { name: '', engName: '', category: 'Siam', level: 'Custom', type: '', mustEat: '', price: '฿', note: '' };
                    showFoodModal.value = true;
                };

                const saveFood = () => {
                    if (!formFood.value.name) return;
                    customFoodSpots.value.unshift({ 
                        id: Date.now(), 
                        isCustom: true,
                        area: formFood.value.category, // Map category to area for display
                        ...formFood.value 
                    });
                    showFoodModal.value = false;
                    saveData();
                };

                const deleteCustomFood = (id) => {
                    if (confirm('確定要刪除這個收藏嗎？')) {
                        customFoodSpots.value = customFoodSpots.value.filter(f => f.id !== id);
                        saveData();
                    }
                };

                const getPaidAmount = (person) => {
                    return expenses.value.filter(e => e.payer === person).reduce((sum, e) => sum + e.amount, 0);
                };

                const addMember = () => {
                    if (newMemberName.value && !members.value.includes(newMemberName.value)) {
                        members.value.push(newMemberName.value);
                        newMemberName.value = '';
                        saveData();
                    }
                };

                const removeMember = (index) => {
                    members.value.splice(index, 1);
                    saveData();
                };

                const resetAllData = () => {
                    if (confirm('確定要重置所有資料為預設行程嗎？您的記帳紀錄和自訂餐廳也會被清空。')) {
                        localStorage.clear();
                        location.reload();
                    }
                };

                const saveData = () => {
                    localStorage.setItem('tripDays_v2', JSON.stringify(tripDays.value));
                    localStorage.setItem('expenses', JSON.stringify(expenses.value));
                    localStorage.setItem('members', JSON.stringify(members.value));
                    localStorage.setItem('customFoodSpots', JSON.stringify(customFoodSpots.value));
                };

                watch([tripDays, expenses, members, customFoodSpots], saveData, { deep: true });

                return {
                    currentTab, tripDays, activeDayIndex, currentDayItems, addDay,
                    showItineraryModal, showThaiAddrModal, thaiAddrContent, formItinerary, isEditing, openItineraryModal, editItem, showThaiAddress, saveItinerary, deleteItinerary, openMap,
                    expenses, totalExpense, showExpenseModal, showSettlementModal, formExpense, settlements, openExpenseModal, saveExpense, deleteExpense, getPaidAmount,
                    calcTHB, calcHKD, currentRate, updateFromTHB, updateFromHKD,
                    showSettings, members, newMemberName, addMember, removeMember, resetAllData,
                    // Food Guide
                    foodCategories, activeFoodCategory, filteredFoodSpots, showFoodModal, formFood, openFoodModal, saveFood, deleteCustomFood
                };
            }
        }).mount('#app');
    </script>
    <style>
        @keyframes slide-up {
            from { transform: translateY(100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .animate-slide-up {
            animation: slide-up 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }
    </style>
</body>
</html>
